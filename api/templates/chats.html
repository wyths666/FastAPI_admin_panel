<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
    <style>
        :root {
            --primary: #4361ee;
            --success: #4cc9f0;
            --warning: #ff5c1a;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.1);
            --radius: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        /* –ù–∞–≤–±–∞—Ä */
.navbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 0 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    min-height: 64px;
}

.nav-brand {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.nav-logo {
    font-size: 1.5rem;
}

.nav-title {
    color: white;
    font-weight: 600;
    font-size: 1.25rem;
}

.nav-links {
    display: flex;
    gap: 0.5rem;
}

.nav-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    transition: all 0.2s;
    font-weight: 500;
}

.nav-link:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    transform: translateY(-1px);
}

.nav-link.active {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.nav-icon {
    font-size: 1.125rem;
}

.nav-text {
    font-size: 0.875rem;
}

.nav-actions {
    display: flex;
    align-items: center;
}

.nav-logout {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #fecaca;
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: all 0.2s;
    font-weight: 500;
    background: rgba(239, 68, 68, 0.2);
}

.nav-logout:hover {
    background: rgba(239, 68, 68, 0.3);
    transform: translateY(-1px);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 1024px) {
    .nav-text {
        display: none;
    }

    .nav-link {
        padding: 0.75rem;
    }

    .nav-brand .nav-title {
        display: none;
    }
}

@media (max-width: 768px) {
    .navbar {
        flex-direction: column;
        padding: 1rem;
        gap: 1rem;
    }

    .nav-links {
        flex-wrap: wrap;
        justify-content: center;
    }
}
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .chat-attach-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: #f1f3f9;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.2s;
}
.chat-attach-btn:hover {
    background: #e9ecef;
    transform: scale(1.05);
}
        .btn-logout {
            background: var(--danger);
            padding: 10px 20px;
            font-size: 1rem;
            display: inline-block;
            color: white;
            text-decoration: none;
            border-radius: var(--radius);
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn-back {
            display: inline-block;
            padding: 10px 20px;
            background: var(--gray);
            color: white;
            text-decoration: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
        }

        .filters {
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px var(--shadow);
            padding: 20px;
            margin-bottom: 30px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
        }

        .filter-button {
            height: 40px;
            line-height: 40px;
            text-align: center;
            padding: 0 20px;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            width: 120px;
            box-sizing: border-box;
            background-color: var(--primary);
            color: white;
        }

        .filter-button:hover {
            background-color: #3a56e4;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px var(--shadow);
        }

        h1 {
            font-size: 2.2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .summary {
            font-size: 1.2rem;
            color: var(--gray);
        }

        .chat-item {
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 10px var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .chat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--shadow);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(to right, #f1f3f9, #e9ecef);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-username {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .chat-user-id {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .chat-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .unread-badge {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .chat-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
        }

        .status-active { background: #d1ecf1; color: #0c5460; }
        .status-banned { background: #f8d7da; color: #721c24; }

        .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .chat-item.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .chat-details {
            display: none;
            padding: 20px;
            background: white;
        }

        .chat-item.expanded .chat-details {
            display: block;
        }

        .chat-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .info-item strong {
            color: var(--dark);
        }

        .chat-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-open-chat {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-ban {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-unban {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-pay {
            display: inline-block;
            padding: 10px 20px;
            background: #09ad50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ */
        .chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .chat-modal-content {
            background: white;
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            position: absolute;
            min-width: 400px;
            min-height: 300px;
            max-width: 95vw;
            max-height: 95vh;
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .chat-modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .chat-modal-close {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .chat-modal-close:hover {
            background: #c1121f;
            transform: scale(1.1);
        }

        /*.chat-modal-controls {*/
        /*    display: flex;*/
        /*    gap: 8px;*/
        /*    align-items: center;*/
        /*}*/

        /*.modal-control-btn {*/
        /*    background: var(--gray);*/
        /*    color: white;*/
        /*    border: none;*/
        /*    width: 28px;*/
        /*    height: 28px;*/
        /*    border-radius: 4px;*/
        /*    cursor: pointer;*/
        /*    display: flex;*/
        /*    align-items: center;*/
        /*    justify-content: center;*/
        /*    font-size: 0.9rem;*/
        /*    transition: all 0.2s ease;*/
        /*}*/

        /*.modal-control-btn:hover {*/
        /*    background: #5a6268;*/
        /*}*/

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px;
            border-radius: 12px;
            position: relative;
        }

        .message.operator {
            background: #e3f2fd;
            align-self: flex-end;
            text-align: right;
        }

        .message.user {
            background: #f5f5f5;
            align-self: flex-start;
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: #f8f9fa;
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
        }

        .chat-send {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            gap: 10px;
        }

        .pagination-info {
            text-align: center;
            margin-bottom: 15px;
            color: var(--gray);
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            color: var(--dark);
        }

        .page-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.disabled:hover {
            background: white;
            color: var(--dark);
            border-color: var(--border);
        }


        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
            }
            .filter-button {
                align-self: stretch;
            }
            .chat-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .chat-stats {
                align-self: stretch;
                justify-content: space-between;
            }
            .message {
                max-width: 85%;
            }
            .chat-modal-content {
                min-width: 95vw;
                min-height: 80vh;
                resize: none;
            }
        }
        .chat-header.has-unread {
            background: linear-gradient(to right, #fff3cd, #ffeaa7) !important;
            border-left: 4px solid #ffc107 !important;
        }

        .chat-header.has-unread .chat-username {
            color: #e74c3c !important;
            font-weight: bold !important;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
        @keyframes pulse-new {
            0% { background-color: transparent; }
            50% { background-color: #fff3cd; }
            100% { background-color: transparent; }
        }

        .chat-header.new-message {
            animation: pulse-new 2s ease-in-out;
        }
        .btn-delete-chat {
            background: var(--warning);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-delete-chat:hover {
            background: #e71d36;
            transform: translateY(-2px);
        }
        .chat-input {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            background: white;
        }
        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ */
        .resize-indicator {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .message {
    max-width: 70%;
    padding: 12px;
    border-radius: 12px;
    position: relative;
    overflow-wrap: break-word;
    word-break: break-word;
}

.message .inline-image-container {
    max-width: 100%;
    max-height: 250px;
    margin: 8px 0;
}

.message .inline-image-container img {
    max-height: 200px;
    width: auto;
    max-width: 100%;
}
        /*.chat-modal-content.resizing .resize-indicator {*/
        /*    opacity: 1;*/
        /*}*/
    </style>
</head>
<body>
<div class="container">
    <div class="navbar">


    <div class="nav-links">
        <a href="/" class="nav-link">
            <span class="nav-icon">üè†</span>
            <span class="nav-text">–ì–ª–∞–≤–Ω–∞—è</span>
        </a>



        <a href="/chats/" class="nav-link active">
            <span class="nav-icon">ü§ñ</span>
            <span class="nav-text">–ß–∞—Ç—ã (–í—ã–∫—É–ø—ã)</span>
        </a>

        <a href="/payments/create/" class="nav-link">
            <span class="nav-icon">üí∞</span>
            <span class="nav-text">–í—ã–ø–ª–∞—Ç—ã</span>
        </a>

        <a href="/claims/" class="nav-link">
            <span class="nav-icon">üé´</span>
            <span class="nav-text">–ó–∞—è–≤–∫–∏ (–õ–æ—Ç–µ—Ä–µ—è)</span>
        </a>
        <a href="/support/" class="nav-link">
            <span class="nav-icon">üí¨</span>
            <span class="nav-text">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
        </a>
    </div>

    <div class="nav-actions">
        <a href="/auth/logout" class="nav-logout">
            <span class="nav-icon">üö™</span>
            <span class="nav-text">–í—ã–π—Ç–∏</span>
        </a>
    </div>
</div>

    <header>
        <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏</h1>
        <p class="summary">–í—Å–µ–≥–æ —á–∞—Ç–æ–≤: {{ total_chats }}</p>
    </header>

    <div class="filters">
        <form id="filter-form" method="GET">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                    <input type="text" id="username" name="username" value="{{ username or '' }}"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
                </div>

                <div class="filter-group">
    <label for="user_id">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
    <input type="number" id="user_id" name="user_id" value="{{ user_id or '' }}"
           placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
</div>

                <div class="filter-group">
                    <label for="date_from">–î–∞—Ç–∞ –æ—Ç:</label>
                    <input type="date" id="date_from" name="date_from" value="{{ date_from or '' }}">
                </div>

                <div class="filter-group">
                    <label for="date_to">–î–∞—Ç–∞ –¥–æ:</label>
                    <input type="date" id="date_to" name="date_to" value="{{ date_to or '' }}">
                </div>

                <div class="filter-group">
                    <label for="has_unread" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="has_unread" name="has_unread"
                               {% if has_unread %}checked{% endif %}>
                        –¢–æ–ª—å–∫–æ —Å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
                    </label>
                </div>

                <input type="hidden" name="page" value="1">

                <button type="submit" class="filter-button">üîç –§–∏–ª—å—Ç—Ä</button>
                <button type="button" class="filter-button" onclick="resetFilters()" style="background-color: #8f8f8f;">‚ùå –°–±—Ä–æ—Å</button>
            </div>
        </form>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
    {% if total_chats > 0 %}
    <div class="pagination-info">
        –ü–æ–∫–∞–∑–∞–Ω—ã —á–∞—Ç—ã —Å {{ start_chat }} –ø–æ {{ end_chat }} –∏–∑ {{ total_chats }}
    </div>
    {% endif %}

    {% for chat in chats %}
    <div class="chat-item" data-user-id="{{ chat.user_id }}">
        <div class="chat-header" onclick="toggleChatDetails(this.parentElement)">
            <div class="chat-user-info">
                <div>
                    <div class="chat-username">
                        {% if chat.unread_count > 0 %}
                        <span style="color: red;">üì© </span>
                        {% endif %}
                        {{ chat.username }}
                    </div>
                    <div class="chat-user-id">ID: {{ chat.user_id }}</div>
                </div>
            </div>

            <div class="chat-stats">
                {% if chat.unread_count > 0 %}
                <div class="unread-badge">{{ chat.unread_count }}</div>
                {% endif %}

                <div class="chat-status {% if chat.banned == '1' %}status-banned{% else %}status-active{% endif %}">
                    {% if chat.banned == '1' %}üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω{% else %}‚úÖ –ê–∫—Ç–∏–≤–µ–Ω{% endif %}
                </div>

                <span class="toggle-icon">‚ñº</span>
            </div>
        </div>

        <div class="chat-details">
            <div class="chat-info">
                <div class="info-item">
                    <strong>üë§ –ü–æ–ª–Ω–æ–µ –∏–º—è:</strong><br>
                    {{ chat.full_name }}
                </div>
                <div class="info-item">
    <strong>üìÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</strong><br>
    <span class="last-message-date" data-timestamp="{{ chat.last_message_date.isoformat() }}">
        {{ chat.last_message_date.strftime('%d.%m.%Y %H:%M') }}
    </span>
</div>
                <div class="info-item">
                    <strong>üìä –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π:</strong><br>
                    {{ chat.message_count }}
                </div>
                <div class="info-item">
                    <strong>üëÅÔ∏è –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:</strong><br>
                    {{ chat.unread_count }}
                </div>
            </div>

            <div class="chat-actions">
                <button class="btn-open-chat" onclick="openChatModalWithDragDrop({{ chat.user_id }}, '{{ chat.username }}')">
                    üí¨ –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
                </button>

                {% if chat.banned == '1' %}
                <button class="btn-unban" onclick="toggleUserBan({{ chat.user_id }}, false)">
                    ‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                </button>
                {% else %}
                <button class="btn-ban" onclick="toggleUserBan({{ chat.user_id }}, true)">
                    üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                </button>
                {% endif %}

                <button class="btn-delete-chat" onclick="deleteChat({{ chat.user_id }})">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–∞—Ç
                </button>

                <a href="/payments/create/" class="btn-pay">üí∏ –û—Ñ–æ—Ä–º–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É</a>
            </div>
        </div>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; background: white; border-radius: var(--radius); box-shadow: 0 4px 12px var(--shadow);">
        <h3>üì≠ –ù–µ—Ç —á–∞—Ç–æ–≤</h3>
        <p>–ß–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</p>
    </div>
    {% endfor %}

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages > 1 %}
    <div class="pagination">
        <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <a href="?page=1{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
           class="page-btn {% if current_page == 1 %}disabled{% endif %}">
            ¬´ –ü–µ—Ä–≤–∞—è
        </a>

        <!-- –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <a href="?page={{ current_page - 1 }}{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
           class="page-btn {% if current_page == 1 %}disabled{% endif %}">
            ‚Äπ –ù–∞–∑–∞–¥
        </a>

        <!-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü -->
        {% for page_num in range(1, total_pages + 1) %}
            {% if page_num >= current_page - 2 and page_num <= current_page + 2 %}
            <a href="?page={{ page_num }}{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
               class="page-btn {% if page_num == current_page %}active{% endif %}">
                {{ page_num }}
            </a>
            {% endif %}
        {% endfor %}

        <!-- –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <a href="?page={{ current_page + 1 }}{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
           class="page-btn {% if current_page == total_pages %}disabled{% endif %}">
            –í–ø–µ—Ä–µ–¥ ‚Ä∫
        </a>

        <!-- –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <a href="?page={{ total_pages }}{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
           class="page-btn {% if current_page == total_pages %}disabled{% endif %}">
            –ü–æ—Å–ª–µ–¥–Ω—è—è ¬ª
        </a>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
<div id="chatModal" class="chat-modal">
    <div class="chat-modal-content" id="chatModalContent">
        <div class="chat-modal-header" id="chatModalHeader">
            <h3 id="chatModalTitle">–ß–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</h3>
            <div class="chat-modal-controls">
                <button class="chat-modal-close" onclick="closeChatModal()" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
            </div>
        </div>

        <div class="chat-messages" id="chatModalMessages">
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>
        <div class="chat-input-area">

    <form class="chat-input-form" onsubmit="sendChatMessage(event)">
        <textarea id="chatMessageInput"
          class="chat-input"
          placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
          rows="1"
          style="resize: none;"
          oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"
          onkeydown="if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); document.querySelector('.chat-input-form').dispatchEvent(new Event('submit', { cancelable: true })); }"
        ></textarea>
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 5px;">
        <label for="fileInput" class="chat-attach-btn" title="üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
            üìé
        </label>
        <input type="file" id="fileInput" style="display: none;" accept="*/*">
        <div id="fileStatus" style="font-size: 0.9rem; color: var(--gray); flex: 1;"></div>
    </div>
        <button type="submit" class="chat-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
</div>
    </div>
</div>

<script>
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º
let currentChatUserId = null;
let chatPollInterval = null;
let isUserScrolling = false;
let lastScrollTop = 0;
let isResizing = false;
let startX, startY, startWidth, startHeight;
let originalSize = { width: 800, height: 600 };
let isMinimized = false;
let originalPosition = {};

function resetFilters() {
    window.location.href = '/chats/';
}

function toggleChatDetails(element) {
    element.classList.toggle('expanded');
}

// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –¥–∞—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.last-message-date').forEach(element => {
        const timestamp = element.getAttribute('data-timestamp');
        if (timestamp) {
            element.textContent = formatMoscowTime(timestamp, true); // true - —Å –¥–∞—Ç–æ–π
        }
    });
});

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function linkify(htmlString) {
    if (!htmlString) return '';
    // –°–ø–∏—Å–æ–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.tiff', '.ico'];
    // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è URL
    const urlRegex = /(\bhttps?:\/\/[^\s<>"{}|\\^`\[\]]+|\bwww\.[^\s<>"{}|\\^`\[\]]+)/gi;

    return htmlString.replace(urlRegex, match => {
        if (/<\/?a\b|<img\b/i.test(match)) return match;

        const lowerMatch = match.toLowerCase();
        const isImage = imageExtensions.some(ext => lowerMatch.endsWith(ext));

        if (isImage) {
            const imgId = `inline-img-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            // –£–ë–ò–†–ê–ï–ú –í–°–ï –ü–ï–†–ï–ù–û–°–´ –°–¢–†–û–ö –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏!
            return `<div class="inline-image-container" style="margin: 8px 0; max-width: 100%; max-height: 250px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); background: #f8f9fa; text-align: center;"><img id="${imgId}" src="${match}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="max-width: 100%; max-height: 200px; height: auto; object-fit: contain; cursor: zoom-in; display: block; margin: 0 auto;" onload="this.style.opacity='1'; this.style.transition='opacity 0.3s ease'" onerror="this.parentElement.innerHTML='<div style=&quot;padding:10px;color:var(--danger);&quot;>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>'" onclick="openInlinePhotoModal('${match}', '${imgId}')"></div>`;
        }

        const url = match.startsWith('http') ? match : 'https://' + match;
        return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="font-weight: bold !important; color: #2563eb !important; text-decoration: none !important; word-break: break-all;" class="text-blue-600 hover:text-blue-800 no-underline">${match}</a>`;
    });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —á–∞—Ç–∞—Ö
function handleInlineImageLoad(imgId) {
    const img = document.getElementById(imgId);
    if (img) {
        img.style.opacity = '1';
        img.style.transition = 'opacity 0.3s ease';
        img.style.cursor = 'zoom-in';
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —á–∞—Ç–∞—Ö
function handleInlineImageError(imgId) {
    const img = document.getElementById(imgId);
    if (img) {
        img.parentElement.innerHTML = `
            <div style="text-align: center; color: var(--danger); padding: 8px;
                        background: #ffeaea; border-radius: 4px; font-size: 0.9rem;">
                ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            </div>
        `;
    }
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —á–∞—Ç–∞—Ö
function openInlinePhotoModal(imageUrl, imgId) {
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–¥–∞–ª—å–Ω—ã–π –æ–∫–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å
    const oldModal = document.getElementById('chatsPhotoModal');
    if (oldModal) oldModal.remove();

    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —á–∞—Ç–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
    const modal = document.createElement('div');
    modal.id = 'chatsPhotoModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer; /* –ö—É—Ä—Å–æ—Ä —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –º–æ–∂–Ω–æ –∫–ª–∏–∫–Ω—É—Ç—å */
    `;

    // –°–æ–∑–¥–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–æ—Ç–æ—Ä—ã–π –ù–ï –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –∫–ª–∏–∫–µ
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        position: relative;
        width: 95%;
        height: 95%;
        max-width: 1200px;
        max-height: 900px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: default; /* –í–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫—É—Ä—Å–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    `;

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
    let scale = 1;
    const minScale = 0.3;
    const maxScale = 3;
    const scaleStep = 0.2;
    let isDragging = false;
    let startX = 0, startY = 0, scrollLeft = 0, scrollTop = 0;

    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modalContent.innerHTML = `
        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 10001; cursor: default;">
            <button id="chatsZoomIn"
                    style="background: rgba(255,255,255,0.2); color: white; border: none;
                           width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem;
                           cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                    title="–£–≤–µ–ª–∏—á–∏—Ç—å">
                +
            </button>

            <span id="chatsScaleIndicator"
                  style="color: white; font-size: 0.9rem; min-width: 50px; text-align: center;
                         line-height: 40px; background: rgba(0,0,0,0.5); padding: 0 10px; border-radius: 20px;
                         cursor: default;">
                100%
            </span>

            <button id="chatsZoomOut"
                    style="background: rgba(255,255,255,0.2); color: white; border: none;
                           width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem;
                           cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                    title="–£–º–µ–Ω—å—à–∏—Ç—å">
                ‚àí
            </button>

            <button id="chatsResetZoom"
                    style="background: rgba(255,255,255,0.2); color: white; border: none;
                           width: 40px; height: 40px; border-radius: 50%; font-size: 0.9rem;
                           cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                    title="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±">
                ‚ü≤
            </button>

            <button id="chatsDownloadInline"
                    style="background: rgba(255,255,255,0.2); color: white; border: none;
                           width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem;
                           cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                    title="–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ">
                ‚§ì
            </button>

            <button id="chatsCloseModal"
                    style="background: rgba(239, 68, 68, 0.2); color: #fecaca; border: none;
                           width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem;
                           cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'"
                    onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'"
                    title="–ó–∞–∫—Ä—ã—Ç—å">
                √ó
            </button>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π -->
        <div id="chatsPhotoContainer" style="position: relative; width: 100%; height: 100%; overflow: auto; cursor: default;">
            <img id="chatsModalPhoto"
                 src="${imageUrl}"
                 alt="–í—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞"
                 style="position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%) scale(1);
                        max-width: 95%;
                        max-height: 90vh;
                        object-fit: contain;
                        border-radius: 4px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                        transition: transform 0.3s ease;
                        cursor: move;"
                 onerror="alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Å—Å—ã–ª–∫–∏')">
        </div>


    `;

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';

    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const modalPhoto = document.getElementById('chatsModalPhoto');
    const scaleIndicator = document.getElementById('chatsScaleIndicator');
    const photoContainer = document.getElementById('chatsPhotoContainer');

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–∞
    function updateScale() {
        modalPhoto.style.transform = `translate(-50%, -50%) scale(${scale})`;
        scaleIndicator.textContent = `${Math.round(scale * 100)}%`;

        // –ò–∑–º–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏
        modalPhoto.style.cursor = scale > 1 ? 'grab' : 'move';
    }

    // –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('chatsZoomIn').onclick = function(e) {
        e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ
        if (scale < maxScale) {
            scale = Math.min(maxScale, scale + scaleStep);
            updateScale();
        }
    };

    document.getElementById('chatsZoomOut').onclick = function(e) {
        e.stopPropagation();
        if (scale > minScale) {
            scale = Math.max(minScale, scale - scaleStep);
            updateScale();
        }
    };

    document.getElementById('chatsResetZoom').onclick = function(e) {
        e.stopPropagation();
        scale = 1;
        updateScale();
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        photoContainer.scrollLeft = (photoContainer.scrollWidth - photoContainer.clientWidth) / 2;
        photoContainer.scrollTop = (photoContainer.scrollHeight - photoContainer.clientHeight) / 2;
    };

    // –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    document.getElementById('chatsDownloadInline').onclick = function(e) {
        e.stopPropagation();
        supportDownloadInlinePhoto(imageUrl);
    };

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è
    document.getElementById('chatsCloseModal').onclick = function(e) {
        e.stopPropagation();
        closeChatsPhotoModal();
    };

    // Drag to move (–ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ)
    modalPhoto.addEventListener('mousedown', (e) => {
        if (scale > 1) {
            isDragging = true;
            startX = e.pageX - photoContainer.offsetLeft;
            startY = e.pageY - photoContainer.offsetTop;
            scrollLeft = photoContainer.scrollLeft;
            scrollTop = photoContainer.scrollTop;
            modalPhoto.style.cursor = 'grabbing';
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ –Ω–∞ —Å–∞–º–æ–º –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    modal.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.pageX - photoContainer.offsetLeft;
        const y = e.pageY - photoContainer.offsetTop;
        const walkX = (x - startX) * 2;
        const walkY = (y - startY) * 2;
        photoContainer.scrollLeft = scrollLeft - walkX;
        photoContainer.scrollTop = scrollTop - walkY;
    });

    modal.addEventListener('mouseup', () => {
        isDragging = false;
        modalPhoto.style.cursor = scale > 1 ? 'grab' : 'move';
    });

    // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–µ—Å–æ–º –º—ã—à–∏
    modal.addEventListener('wheel', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (e.deltaY < 0) {
            // –ö–æ–ª–µ—Å–æ –≤–≤–µ—Ä—Ö - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º
            if (scale < maxScale) {
                scale = Math.min(maxScale, scale + scaleStep);
                updateScale();
            }
        } else {
            // –ö–æ–ª–µ—Å–æ –≤–Ω–∏–∑ - —É–º–µ–Ω—å—à–∞–µ–º
            if (scale > minScale) {
                scale = Math.max(minScale, scale - scaleStep);
                updateScale();
            }
        }
    });

    // –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï: –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    modal.addEventListener('click', function(e) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –Ω–∞ modal (—Ñ–æ–Ω)
        // –∞ –Ω–µ –Ω–∞ modalContent –∏–ª–∏ –µ–≥–æ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        if (e.target === modal) {
            closeChatsPhotoModal();
        }
    });

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    modalContent.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
    const escapeHandler = function(e) {
        if (e.key === 'Escape') {
            closeChatsPhotoModal();
        }
    };
    document.addEventListener('keydown', escapeHandler);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–∑–∂–µ
    modal._escapeHandler = escapeHandler;

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
    setTimeout(() => {
        const hint = modalContent.querySelector('div[style*="bottom: 20px"]');
        if (hint) {
            hint.style.opacity = '0';
            setTimeout(() => hint.style.display = 'none', 1000);
        }
    }, 3000);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateScale();
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å —Ñ–æ—Ç–æ –≤ —á–∞—Ç–∞—Ö
function closeChatsPhotoModal() {
    const modal = document.getElementById('chatsPhotoModal');
    if (modal) {
        // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Escape
        if (modal._escapeHandler) {
            document.removeEventListener('keydown', modal._escapeHandler);
        }
        modal.remove();
        document.body.style.overflow = '';
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ –≤ —á–∞—Ç–∞—Ö
async function supportDownloadInlinePhoto(imageUrl) {
    try {
        const response = await fetch(imageUrl);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);

        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ URL –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–º—è
        let filename = 'chat_image.jpg';
        try {
            const urlObj = new URL(imageUrl);
            const pathname = urlObj.pathname;
            const lastSegment = pathname.split('/').pop();
            if (lastSegment && lastSegment.includes('.')) {
                filename = lastSegment;
            }
        } catch (e) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∏–º—è, –µ—Å–ª–∏ URL –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
            filename = `chat_image_${Date.now()}.jpg`;
        }

        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
        setTimeout(() => {
            URL.revokeObjectURL(url);
        }, 100);

    } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ –∏–∑ —á–∞—Ç–∞:', err);
        alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${err.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É'}`);
    }
}


////////////////////////////////////////////////////////////
//////////////// –Ω–∞—á–∞–ª–æ —Å–µ–∫—Ü–∏–∏ drag'n'drop –¥–ª—è —á–∞—Ç–æ–≤

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ drag'n'drop –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —á–∞—Ç–∞
function initDragAndDropForChatModal() {
    const modal = document.getElementById('chatModal');
    const chatContainer = document.querySelector('.chat-modal-content');

    if (!modal || !chatContainer) return;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∂–µ –ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    if (chatContainer.dataset.dragInitialized) return;
    chatContainer.dataset.dragInitialized = "true";

    let dragCounter = 0;
    let overlay = null;

    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–≤–µ—Ä–ª–µ—è
    function createOverlay() {
        if (overlay) return;

        overlay = document.createElement('div');
        overlay.className = 'drag-overlay-chats';
        overlay.innerHTML = `
            <div style="
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(67, 97, 238, 0.9);
                color: white;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                border-radius: var(--radius);
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s ease;
            ">
                <div style="
                    text-align: center;
                    padding: 2rem;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 12px;
                    backdrop-filter: blur(10px);
                    border: 3px dashed white;
                ">
                    <span style="font-size: 4rem;">üìÅ</span>
                    <p style="font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0;">
                        –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞
                    </p>
                    <p style="font-size: 0.9rem; opacity: 0.8;">
                        –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50 –ú–ë
                    </p>
                </div>
            </div>
        `;

        chatContainer.appendChild(overlay);
    }

    function showOverlay() {
        createOverlay();
        overlay.style.opacity = '1';
        overlay.style.pointerEvents = 'auto';
    }

    function hideOverlay() {
        if (overlay) {
            overlay.style.opacity = '0';
            overlay.style.pointerEvents = 'none';
        }
    }

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
        chatContainer.addEventListener(evt, e => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    chatContainer.addEventListener('dragenter', e => {
        dragCounter++;
        if (dragCounter === 1) showOverlay();
    });

    chatContainer.addEventListener('dragover', e => {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏
        if (overlay) {
            const rect = chatContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            overlay.style.setProperty('--mouse-x', `${x}px`);
            overlay.style.setProperty('--mouse-y', `${y}px`);
        }
    });

    chatContainer.addEventListener('dragleave', e => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤—ã—à–ª–∏ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        const rect = chatContainer.getBoundingClientRect();
        const x = e.clientX;
        const y = e.clientY;

        // –ï—Å–ª–∏ –∫—É—Ä—Å–æ—Ä –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        if (x <= rect.left || x >= rect.right || y <= rect.top || y >= rect.bottom) {
            dragCounter--;
            if (dragCounter <= 0) {
                dragCounter = 0;
                hideOverlay();
            }
        }
    });

    chatContainer.addEventListener('drop', async e => {
        e.stopPropagation();
        dragCounter = 0;
        hideOverlay();

        const files = e.dataTransfer?.files;
        if (!files || files.length === 0) return;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —á–∞—Ç –æ—Ç–∫—Ä—ã—Ç
        if (!currentChatUserId) {
            alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
            return;
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã
        for (let file of files) {
            await sendFileToChat(currentChatUserId, file);
        }
    });

    if (!document.getElementById('drag-drop-styles')) {
        const style = document.createElement('style');
        style.id = 'drag-drop-styles';
        style.textContent = `
            .drag-overlay-chats {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(67, 97, 238, 0.9);
                color: white;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                border-radius: var(--radius);
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .drag-overlay-chats.active {
                opacity: 1;
                pointer-events: auto;
            }

            .drag-overlay-chats > div {
                text-align: center;
                padding: 2rem;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                backdrop-filter: blur(10px);
                border: 3px dashed white;
                animation: pulse 1.5s infinite;
            }

            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.02); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ –≤ —á–∞—Ç
async function sendFileToChat(userId, file) {
    const maxSize = 50 * 1024 * 1024; // 50 –ú–ë
    if (file.size > maxSize) {
        alert(`‚ùå –§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50 –ú–ë)`);
        return;
    }

    // –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫: –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    const tempId = `temp-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
    const messagesContainer = document.getElementById('chatModalMessages');

    if (!messagesContainer) {
        console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }

    const isImage = file.type.startsWith('image/');
    let preview = '';

    if (isImage) {
        const blobUrl = URL.createObjectURL(file);
        preview = `<img src="${blobUrl}" style="max-width: 200px; max-height: 150px; border-radius: 6px; opacity: 0.6; display: block; margin: 0 auto;">`;
        // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º URL –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
    } else {
        const fileName = escapeHtml(file.name);
        const fileSize = formatFileSize(file.size);
        preview = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.5rem;">üìÅ</span>
                <div style="overflow: hidden; text-overflow: ellipsis;">
                    <strong style="display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${fileName}</strong>
                    <small style="color: #666;">${fileSize}</small>
                </div>
            </div>
        `;
    }

    const tempMsg = document.createElement('div');
    tempMsg.id = tempId;
    tempMsg.className = `message operator message-sending`;
    tempMsg.style.cssText = `
        max-width: 300px !important;
        min-width: 0;
        align-self: flex-end;
        margin-left: auto;
    `;

    tempMsg.innerHTML = `
        <div style="
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        ">
            ${preview}
            <div style="font-size: 0.8rem; color: #0c5460; margin-top: 5px; text-align: center;">
                <div class="sending-indicator" style="display: inline-flex; align-items: center; gap: 5px;">
                    <span class="dots" style="display: inline-flex; gap: 2px;">
                        <span style="animation: dot1 1.5s infinite;">.</span>
                        <span style="animation: dot2 1.5s infinite;">.</span>
                        <span style="animation: dot3 1.5s infinite;">.</span>
                    </span>
                    –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞
                </div>
            </div>
        </div>
        <div class="message-time">${formatMoscowTime(Date.now())}</div>
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Ç–æ—á–µ–∫
    const style = document.createElement('style');
    style.textContent = `
        @keyframes dot1 {
            0%, 20% { opacity: 0.2; }
            40% { opacity: 1; }
            60%, 100% { opacity: 0.2; }
        }
        @keyframes dot2 {
            0%, 40% { opacity: 0.2; }
            60% { opacity: 1; }
            80%, 100% { opacity: 0.2; }
        }
        @keyframes dot3 {
            0%, 60% { opacity: 0.2; }
            80% { opacity: 1; }
            100% { opacity: 0.2; }
        }
    `;
    document.head.appendChild(style);

    messagesContainer.appendChild(tempMsg);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    try {
        const formData = new FormData();
        formData.append('user_id', userId);
        formData.append('file', file);

        // –î–æ–±–∞–≤–ª—è–µ–º caption –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
        const caption = document.getElementById('chatMessageInput')?.value.trim();
        if (caption) {
            formData.append('caption', caption);
        }

        const response = await fetch('/chats/send/file/', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.detail || result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }

        // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        tempMsg.remove();

        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        const input = document.getElementById('chatMessageInput');
        if (input && caption) {
            input.value = '';
            input.style.height = 'auto';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
        await loadChatHistory(userId, messagesContainer);

        // –£–¥–∞–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        if (style.parentNode) {
            style.remove();
        }

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞:', error);

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—à–∏–±–∫–æ–π
        const errorDiv = tempMsg.querySelector('.sending-indicator');
        if (errorDiv) {
            errorDiv.innerHTML = `<span style="color: #e63946;">‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</span>`;
        }

        // –£–¥–∞–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        if (style.parentNode) {
            style.remove();
        }

        // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            if (document.getElementById(tempId)) {
                tempMsg.remove();
            }
        }, 3000);

        alert(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª: ${error.message}`);
    }
}

// –í—ã–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function initChatModalDragAndDrop() {
    // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã DOM –æ–±–Ω–æ–≤–∏–ª—Å—è
    setTimeout(() => {
        initDragAndDropForChatModal();
    }, 100);
}

function openChatModalWithDragDrop(userId, username) {
    currentChatUserId = userId;
    const modal = document.getElementById('chatModal');
    const title = document.getElementById('chatModalTitle');
    const messagesContainer = document.getElementById('chatModalMessages');
    const modalContent = document.getElementById('chatModalContent');

    title.textContent = `–ß–∞—Ç —Å ${username} (ID: ${userId})`;
    modal.style.display = 'flex';

    setModalMaximized();

    loadChatHistory(userId, messagesContainer);

    startChatPolling(userId, messagesContainer);

    initChatModalDragAndDrop();
}

// –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
function updateChatOpenButtons() {
    document.querySelectorAll('.btn-open-chat').forEach(button => {
        button.onclick = function() {
            const userId = this.closest('.chat-item').dataset.userId;
            const username = this.closest('.chat-item').querySelector('.chat-username').textContent.trim();
            openChatModalWithDragDrop(userId, username);
        };
    });
}

//////////////// –∫–æ–Ω–µ—Ü —Å–µ–∫—Ü–∏–∏ drag'n'drop –¥–ª—è —á–∞—Ç–æ–≤
////////////////////////////////////////////////////////////






function formatMoscowTime(timestamp, includeDate = false) {
    try {
        let date;

        if (typeof timestamp === 'number') {
            if (timestamp < 10000000000) {
                date = new Date(timestamp * 1000);
            } else {
                date = new Date(timestamp);
            }
        } else if (typeof timestamp === 'string') {
            date = new Date(timestamp);
        } else {
            console.warn('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç timestamp:', timestamp);
            return '--:--';
        }

        if (isNaN(date.getTime())) {
            console.warn('Invalid date –¥–ª—è timestamp:', timestamp);
            return '--:--';
        }

        const moscowOffset = 3 * 60 * 60 * 1000;
        const moscowTime = new Date(date.getTime() + moscowOffset);

        if (includeDate) {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
            return moscowTime.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        } else {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è (–∫–∞–∫ –±—ã–ª–æ)
            return moscowTime.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤ formatMoscowTime:', error, 'timestamp:', timestamp);
        return '--:--';
    }
}

function openChatModal(userId, username) {
    currentChatUserId = userId;
    const modal = document.getElementById('chatModal');
    const title = document.getElementById('chatModalTitle');
    const messagesContainer = document.getElementById('chatModalMessages');
    const modalContent = document.getElementById('chatModalContent');

    title.textContent = `–ß–∞—Ç —Å ${username} (ID: ${userId})`;
    modal.style.display = 'flex';

    setModalMaximized();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
    loadChatHistory(userId, messagesContainer);

    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞
    startChatPolling(userId, messagesContainer);

}

function closeChatModal() {
    const modal = document.getElementById('chatModal');
    modal.style.display = 'none';
    currentChatUserId = null;
    isMinimized = false;

    if (chatPollInterval) {
        clearInterval(chatPollInterval);
        chatPollInterval = null;
    }
}



function setModalMaximized() {
    const modalContent = document.getElementById('chatModalContent');
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Å —É—á–µ—Ç–æ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä–æ–≤
    modalContent.style.width = '95vw';
    modalContent.style.height = '95vh';
    modalContent.style.left = '2.5vw';
    modalContent.style.top = '2.5vh';
    modalContent.style.overflow = 'hidden';

    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã
    const messages = document.getElementById('chatModalMessages');
    if (messages) {
        messages.style.maxWidth = '100%';
        messages.style.overflowX = 'hidden';
    }
}

async function loadChatHistory(userId, container) {
    try {
        const response = await fetch(`/chats/history/?user_id=${userId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const messages = await response.json();

        const wasAtBottom = isScrolledToBottom(container);
        const previousScrollTop = container.scrollTop;
        const previousHeight = container.scrollHeight;

        container.innerHTML = '';

        const textStyles = 'word-wrap: break-word; word-break: break-word; white-space: pre-wrap; margin: 0;';

        messages.forEach((msg, index) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.from_operator ? 'operator' : 'user'}`;

            const messageTime = formatMoscowTime(msg.date);
            let content = '';

            // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç (–∏–ª–∏ caption) –≤ linkify
            const renderText = (text) => text ? `<div style="margin-top: 8px; ${textStyles}">${linkify(text)}</div>` : '';

            // 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞–≥—Ä—É–ø–ø—ã (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ)
            if (Array.isArray(msg.media_group) && msg.media_group.length > 0) {
                const photosHtml = msg.media_group.map(item => {
                    const photoId = item.id || item.message_id || msg.id;
                    const caption = item.caption || msg.caption;
                    return `
                        <div style="margin-bottom: 12px;">
                            <img src="/chats/photo/${photoId}"
                                 alt="–§–æ—Ç–æ –∏–∑ —á–∞—Ç–∞"
                                 style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--primary); cursor: pointer;"
                                 onclick="openChatPhoto('${photoId}')"
                                 onerror="console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: ${photoId}'); this.style.display='none'">

                        </div>
                    `;
                }).join('');

                content = photosHtml + renderText(msg.caption || msg.message);
            }
            // 2. –û–¥–∏–Ω–æ—á–Ω–æ–µ —Ñ–æ—Ç–æ
            else if (msg.has_photo) {
                const photoId = msg.id;
                content = `
                    <div style="margin-bottom: 12px;">
                        <img src="/chats/photo/${photoId}"
                             alt="–§–æ—Ç–æ –∏–∑ —á–∞—Ç–∞"
                             style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--primary); cursor: pointer;"
                             onclick="openChatPhoto('${photoId}')"
                             onerror="console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: ${photoId}'); this.style.display='none'">

                    </div>
                    ${renderText(msg.caption || msg.message)}
                `;
            }
            // 3. –î–æ–∫—É–º–µ–Ω—Ç ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∫–∞–∫ —Å—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            else if (msg.has_document) {
    const fileName = msg.file_name || '–§–∞–π–ª';
    content = `<div style="display: flex; align-items: center; margin: 0;">üìÇ&nbsp;<a href="/chats/download-simple/${msg.id}" style="font-weight: bold; ${textStyles} color: var(--primary); text-decoration: none; cursor: pointer;" title="–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª">${escapeHtml(fileName)}</a></div>${msg.caption ? renderText(msg.caption) : ''}`;
}

            // 7. –û–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            else {
    content = `<div style="
        ${textStyles}
        max-width: 100%;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
    ">${linkify(msg.message || '(–ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)')}</div>`;
}

            content += `<div class="message-time">${messageTime}</div>`;
            messageDiv.innerHTML = content;
            container.appendChild(messageDiv);
        });

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞
        if (wasAtBottom || isUserScrolling) {
            container.scrollTop = container.scrollHeight;
        } else {
            const newHeight = container.scrollHeight;
            container.scrollTop = previousScrollTop + (newHeight - previousHeight);
        }

    } catch (error) {
        console.error('‚ùå loadChatHistory error:', error);
        container.innerHTML = `<div style="text-align: center; color: var(--danger); padding: 20px;">
            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞.<br>
            ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
        </div>`;
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function formatFileSize(bytes) {
    if (!bytes) return '';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1024 / 1024).toFixed(1) + ' MB';
}

async function openChatPhoto(messageId) {
    try {
        const photoUrl = `/chats/photo/${messageId}`;

        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; padding: 20px;
        `;

        let scale = 1;
        const minScale = 0.3;
        const maxScale = 3;
        const scaleStep = 0.2;

        modal.innerHTML = `
            <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 10001;">
                <button onclick="downloadCurrentPhoto('${messageId}')"
                        style="background: rgba(255,255,255,0.2); color: white; border: none;
                               width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem;
                               cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s;"
                        onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                        onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                        title="–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ">
                    ‚§ì
                </button>

            </div>

            <div id="photoContainer" style="position: relative; display: flex; justify-content: center; align-items: center;">
                <img id="modalPhoto" src="${photoUrl}"
                     alt="–§–æ—Ç–æ –∏–∑ —á–∞—Ç–∞"
                     style="max-width: 95%; max-height: 85vh; object-fit: contain;
                            border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                            transform: scale(1); transition: transform 0.3s ease; cursor: move;"
                     onerror="alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ')">

                <!-- –ö–Ω–æ–ø–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div style="position: absolute; bottom: -60px; left: 50%; transform: translateX(-50%);
                            display: flex; gap: 15px; align-items: center; background: rgba(0,0,0,0.5);
                            padding: 10px 20px; border-radius: 25px; backdrop-filter: blur(10px);">
                    <button onclick="zoomOut()"
                            style="background: rgba(255,255,255,0.2); color: white; border: none;
                                   width: 36px; height: 36px; border-radius: 50%; font-size: 1.2rem;
                                   cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                            onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                            title="–£–º–µ–Ω—å—à–∏—Ç—å">
                        ‚àí
                    </button>

                    <span id="scaleIndicator"
                          style="color: white; font-size: 0.9rem; min-width: 50px; text-align: center;">
                        100%
                    </span>

                    <button onclick="zoomIn()"
                            style="background: rgba(255,255,255,0.2); color: white; border: none;
                                   width: 36px; height: 36px; border-radius: 50%; font-size: 1.2rem;
                                   cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                            onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                            title="–£–≤–µ–ª–∏—á–∏—Ç—å">
                        +
                    </button>

                    <button onclick="resetZoom()"
                            style="background: rgba(255,255,255,0.2); color: white; border: none;
                                   width: 36px; height: 36px; border-radius: 50%; font-size: 0.9rem;
                                   cursor: pointer; transition: all 0.2s; margin-left: 10px;"
                            onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                            onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                            title="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±">
                        ‚ü≥
                    </button>
                </div>
            </div>
        `;

        // –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        window.zoomIn = function() {
            if (scale < maxScale) {
                scale = Math.min(maxScale, scale + scaleStep);
                updateScale();
            }
        };

        window.zoomOut = function() {
            if (scale > minScale) {
                scale = Math.max(minScale, scale - scaleStep);
                updateScale();
            }
        };

        window.resetZoom = function() {
            scale = 1;
            updateScale();
        };

        function updateScale() {
            const img = modal.querySelector('#modalPhoto');
            const indicator = modal.querySelector('#scaleIndicator');
            if (img) {
                img.style.transform = `scale(${scale})`;
                indicator.textContent = `${Math.round(scale * 100)}%`;
            }
        }

        // Drag to move (–ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
        let isDragging = false;
        let startX, startY, scrollLeft, scrollTop;

        const photoContainer = modal.querySelector('#photoContainer');
        const img = modal.querySelector('#modalPhoto');

        img.addEventListener('mousedown', (e) => {
            if (scale > 1) {
                isDragging = true;
                startX = e.pageX - photoContainer.offsetLeft;
                startY = e.pageY - photoContainer.offsetTop;
                scrollLeft = photoContainer.scrollLeft;
                scrollTop = photoContainer.scrollTop;
                img.style.cursor = 'grabbing';
            }
        });

        modal.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const x = e.pageX - photoContainer.offsetLeft;
            const y = e.pageY - photoContainer.offsetTop;
            const walkX = (x - startX) * 2;
            const walkY = (y - startY) * 2;
            photoContainer.scrollLeft = scrollLeft - walkX;
            photoContainer.scrollTop = scrollTop - walkY;
        });

        modal.addEventListener('mouseup', () => {
            isDragging = false;
            img.style.cursor = scale > 1 ? 'grab' : 'move';
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω –∏–ª–∏ Escape
        modal.onclick = (e) => {
            if (e.target === modal) modal.remove();
        };

        document.addEventListener('keydown', function escClose(e) {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', escClose);
            }
        });

        // Wheel zoom
        modal.addEventListener('wheel', (e) => {
            e.preventDefault();
            if (e.deltaY < 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        });

        document.body.appendChild(modal);

    } catch (error) {
        console.error("‚ùå openChatPhoto error:", error);
        alert(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ: ${error.message}`);
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
function downloadCurrentPhoto(messageId) {
    const a = document.createElement('a');
    a.href = `/chats/photo/${messageId}`;
    a.download = `photo_${messageId}.jpg`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function adjustTextareaHeight(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.max(textarea.scrollHeight, 40) + 'px';
}

async function sendChatMessage(event) {
    event.preventDefault();
    const input = document.getElementById('chatMessageInput');
    const text = input.value.trim();

    if (!text || !currentChatUserId) return;

    try {
        const response = await fetch('/chats/send/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user_id: currentChatUserId, text})
        });

        const result = await response.json();

        if (result.ok) {
            input.value = '';
            adjustTextareaHeight(input);
            await loadChatHistory(currentChatUserId, document.getElementById('chatModalMessages'));
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
}

// === –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ ===
document.getElementById('fileInput').addEventListener('change', async function(e) {
    const fileInput = e.target;
    const file = fileInput.files[0];
    const statusDiv = document.getElementById('fileStatus');
    const chatInput = document.getElementById('chatMessageInput');

    if (!file || !currentChatUserId) return;

    // –û—á–∏—Å—Ç–∏–º —Å—Ç–∞—Ç—É—Å
    statusDiv.textContent = `üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ ${file.name}...`;
    statusDiv.style.color = '#6c757d';

    const formData = new FormData();
    formData.append('user_id', currentChatUserId);
    formData.append('file', file);
    const caption = chatInput.value.trim();
    if (caption) {
        formData.append('caption', caption);
    }

    try {
        const response = await fetch('/chats/send/file/', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok && result.ok) {
            statusDiv.textContent = `‚úÖ ${file.name} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`;
            statusDiv.style.color = '#4cc9f0';
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –∏ –∏–Ω–ø—É—Ç
            chatInput.value = '';
            adjustTextareaHeight(chatInput);
            fileInput.value = ''; // —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
            // –û–±–Ω–æ–≤–∏–º —á–∞—Ç
            await loadChatHistory(currentChatUserId, document.getElementById('chatModalMessages'));
        } else {
            throw new Error(result.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞:', error);
        statusDiv.textContent = `‚ùå ${error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª'}`;
        statusDiv.style.color = '#e63946';
        // –ù–µ –æ—á–∏—â–∞–µ–º —Ñ–∞–π–ª ‚Äî –¥–∞–¥–∏–º –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
    }

    // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫
    setTimeout(() => {
        statusDiv.textContent = '';
    }, 3000);
});


function startChatPolling(userId, container) {
    if (chatPollInterval) {
        clearInterval(chatPollInterval);
    }

    container.addEventListener('scroll', handleChatScroll);

    chatPollInterval = setInterval(async () => {
        if (currentChatUserId === userId && !isUserScrolling) {
            await loadChatHistory(userId, container);
        }
    }, 10000);
}

function handleChatScroll(event) {
    const container = event.target;
    const scrollTop = container.scrollTop;

    if (Math.abs(scrollTop - lastScrollTop) > 5) {
        isUserScrolling = true;

        clearTimeout(window.scrollTimeout);
        window.scrollTimeout = setTimeout(() => {
            isUserScrolling = false;
        }, 2000);
    }

    lastScrollTop = scrollTop;
}

function isScrolledToBottom(container) {
    const threshold = 100;
    return container.scrollHeight - container.scrollTop - container.clientHeight <= threshold;
}

async function toggleUserBan(userId, ban) {
    const action = ban ? '–±–ª–æ–∫–∏—Ä–æ–≤–∫—É' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É';

    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å ${action} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}?`)) {
        return;
    }

    try {
        const endpoint = ban ? '/chats/user/ban' : '/chats/user/unban';

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: parseInt(userId)
            })
        });

        const result = await response.json();

        if (result.ok) {
            alert(`‚úÖ ${result.message}`);
            location.reload();
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeChatModal();
    }
});

async function deleteChat(userId) {
    if (!confirm(`‚ùå –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤–µ—Å—å —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${userId}?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏. –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!`)) {
        return;
    }

    try {
        const response = await fetch('/chats/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: parseInt(userId)
            })
        });

        const result = await response.json();

        if (result.ok) {
            alert(`‚úÖ ${result.message}`);
            const chatElement = document.querySelector(`[data-user-id="${userId}"]`);
            if (chatElement) {
                chatElement.style.opacity = '0';
                chatElement.style.transform = 'translateX(-100%)';
                setTimeout(() => {
                    chatElement.remove();
                    updateChatsCount();
                }, 300);
            }
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
}

function updateChatsCount() {
    const chatItems = document.querySelectorAll('.chat-item');
    const summaryElement = document.querySelector('.summary');

    if (summaryElement) {
        const currentText = summaryElement.textContent;
        const newCount = chatItems.length;
        summaryElement.textContent = currentText.replace(/\d+/, newCount);
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
let refreshInterval = null;

function startAutoRefresh() {
    refreshInterval = setInterval(() => {
        refreshChatsList();
    }, 30000);

    console.log("üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω–æ");
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
        console.log("‚èπÔ∏è –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
    }
}

async function refreshChatsList() {
    try {
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);

        const username = params.get('username') || '';
        const dateFrom = params.get('date_from') || '';
        const dateTo = params.get('date_to') || '';
        const hasUnread = params.get('has_unread') || '';
        const page = params.get('page') || '1';

        let refreshUrl = `/chats/?page=${page}`;
        if (username) refreshUrl += `&username=${encodeURIComponent(username)}`;
        if (dateFrom) refreshUrl += `&date_from=${dateFrom}`;
        if (dateTo) refreshUrl += `&date_to=${dateTo}`;
        if (hasUnread) refreshUrl += `&has_unread=${hasUnread}`;

        const response = await fetch(refreshUrl);
        const html = await response.text();

        const parser = new DOMParser();
        const newDocument = parser.parseFromString(html, 'text/html');
        const newChatsContainer = newDocument.querySelector('.container');

        if (newChatsContainer) {
            const currentlyOpen = [];
            document.querySelectorAll('.chat-item.expanded').forEach(chat => {
                const userId = chat.dataset.userId;
                if (userId) currentlyOpen.push(userId);
            });

            document.querySelector('.container').innerHTML = newChatsContainer.innerHTML;

            currentlyOpen.forEach(userId => {
                const chatElement = document.querySelector(`[data-user-id="${userId}"]`);
                if (chatElement) {
                    chatElement.classList.add('expanded');
                }
            });

            console.log("‚úÖ –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω");
        }

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–≤:', error);
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    startAutoRefresh();
});



function downloadPhoto(messageId, filename = `photo_${messageId}.jpg`) {
    try {
        const url = `/chats/photo/${messageId}`;
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
        }, 100);
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ:', e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ');
    }
}

</script>
</body>
</html>
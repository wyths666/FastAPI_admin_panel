<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏</title>
    <style>
        :root {
            --primary: #4361ee;
            --success: #4cc9f0;
            --warning: #ff5c1a;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.1);
            --radius: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-logout {
            background: var(--danger);
            padding: 10px 20px;
            font-size: 1rem;
            display: inline-block;
            color: white;
            text-decoration: none;
            border-radius: var(--radius);
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn-back {
            display: inline-block;
            padding: 10px 20px;
            background: var(--gray);
            color: white;
            text-decoration: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
        }

        .filters {
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px var(--shadow);
            padding: 20px;
            margin-bottom: 30px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
        }

        .filter-button {
            height: 40px;
            line-height: 40px;
            text-align: center;
            padding: 0 20px;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            width: 120px;
            box-sizing: border-box;
            background-color: var(--primary);
            color: white;
        }

        .filter-button:hover {
            background-color: #3a56e4;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px var(--shadow);
        }

        h1 {
            font-size: 2.2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .summary {
            font-size: 1.2rem;
            color: var(--gray);
        }

        .chat-item {
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 10px var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .chat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--shadow);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(to right, #f1f3f9, #e9ecef);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-username {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .chat-user-id {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .chat-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .unread-badge {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .chat-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
        }

        .status-active { background: #d1ecf1; color: #0c5460; }
        .status-banned { background: #f8d7da; color: #721c24; }

        .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .chat-item.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .chat-details {
            display: none;
            padding: 20px;
            background: white;
        }

        .chat-item.expanded .chat-details {
            display: block;
        }

        .chat-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .info-item strong {
            color: var(--dark);
        }

        .chat-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-open-chat {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-ban {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-unban {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-pay {
            display: inline-block;
            padding: 10px 20px;
            background: #09ad50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ */
        .chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .chat-modal-content {
            background: white;
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            position: absolute;
            min-width: 400px;
            min-height: 300px;
            max-width: 95vw;
            max-height: 95vh;
            resize: both;
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .chat-modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .chat-modal-close {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .chat-modal-close:hover {
            background: #c1121f;
            transform: scale(1.1);
        }

        .chat-modal-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .modal-control-btn {
            background: var(--gray);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .modal-control-btn:hover {
            background: #5a6268;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px;
            border-radius: 12px;
            position: relative;
        }

        .message.operator {
            background: #e3f2fd;
            align-self: flex-end;
            text-align: right;
        }

        .message.user {
            background: #f5f5f5;
            align-self: flex-start;
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: #f8f9fa;
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
        }

        .chat-send {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            gap: 10px;
        }

        .pagination-info {
            text-align: center;
            margin-bottom: 15px;
            color: var(--gray);
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            color: var(--dark);
        }

        .page-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.disabled:hover {
            background: white;
            color: var(--dark);
            border-color: var(--border);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ */
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 10;
        }

        .resize-handle.right {
            right: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: ew-resize;
        }

        .resize-handle.bottom {
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            cursor: ns-resize;
        }

        .resize-handle.corner {
            right: 0;
            bottom: 0;
            width: 15px;
            height: 15px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, var(--primary) 50%);
            border-radius: 0 0 10px 0;
        }

        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
            }
            .filter-button {
                align-self: stretch;
            }
            .chat-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .chat-stats {
                align-self: stretch;
                justify-content: space-between;
            }
            .message {
                max-width: 85%;
            }
            .chat-modal-content {
                min-width: 95vw;
                min-height: 80vh;
                resize: none;
            }
        }
        .chat-header.has-unread {
            background: linear-gradient(to right, #fff3cd, #ffeaa7) !important;
            border-left: 4px solid #ffc107 !important;
        }

        .chat-header.has-unread .chat-username {
            color: #e74c3c !important;
            font-weight: bold !important;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
        @keyframes pulse-new {
            0% { background-color: transparent; }
            50% { background-color: #fff3cd; }
            100% { background-color: transparent; }
        }

        .chat-header.new-message {
            animation: pulse-new 2s ease-in-out;
        }
        .btn-delete-chat {
            background: var(--warning);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-delete-chat:hover {
            background: #e71d36;
            transform: translateY(-2px);
        }
        .chat-input {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            background: white;
        }
        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ */
        .resize-indicator {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .chat-modal-content.resizing .resize-indicator {
            opacity: 1;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header-actions">
        <a href="/" class="btn-back">‚Üê –ù–∞–∑–∞–¥</a>
        <a href="/auth/logout" class="btn-logout">üö™ –í—ã–π—Ç–∏</a>
    </div>

    <header>
        <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏</h1>
        <p class="summary">–í—Å–µ–≥–æ —á–∞—Ç–æ–≤: {{ total_chats }}</p>
    </header>

    <div class="filters">
        <form id="filter-form" method="GET">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                    <input type="text" id="username" name="username" value="{{ username or '' }}"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
                </div>

                <div class="filter-group">
    <label for="user_id">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
    <input type="number" id="user_id" name="user_id" value="{{ user_id or '' }}"
           placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
</div>

                <div class="filter-group">
                    <label for="date_from">–î–∞—Ç–∞ –æ—Ç:</label>
                    <input type="date" id="date_from" name="date_from" value="{{ date_from or '' }}">
                </div>

                <div class="filter-group">
                    <label for="date_to">–î–∞—Ç–∞ –¥–æ:</label>
                    <input type="date" id="date_to" name="date_to" value="{{ date_to or '' }}">
                </div>

                <div class="filter-group">
                    <label for="has_unread" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="has_unread" name="has_unread"
                               {% if has_unread %}checked{% endif %}>
                        –¢–æ–ª—å–∫–æ —Å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
                    </label>
                </div>

                <input type="hidden" name="page" value="1">

                <button type="submit" class="filter-button">üîç –§–∏–ª—å—Ç—Ä</button>
                <button type="button" class="filter-button" onclick="resetFilters()" style="background-color: #8f8f8f;">‚ùå –°–±—Ä–æ—Å</button>
            </div>
        </form>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
    {% if total_chats > 0 %}
    <div class="pagination-info">
        –ü–æ–∫–∞–∑–∞–Ω—ã —á–∞—Ç—ã —Å {{ start_chat }} –ø–æ {{ end_chat }} –∏–∑ {{ total_chats }}
    </div>
    {% endif %}

    {% for chat in chats %}
    <div class="chat-item" data-user-id="{{ chat.user_id }}">
        <div class="chat-header" onclick="toggleChatDetails(this.parentElement)">
            <div class="chat-user-info">
                <div>
                    <div class="chat-username">
                        {% if chat.unread_count > 0 %}
                        <span style="color: red;">üì© </span>
                        {% endif %}
                        {{ chat.username }}
                    </div>
                    <div class="chat-user-id">ID: {{ chat.user_id }}</div>
                </div>
            </div>

            <div class="chat-stats">
                {% if chat.unread_count > 0 %}
                <div class="unread-badge">{{ chat.unread_count }}</div>
                {% endif %}

                <div class="chat-status {% if chat.banned == '1' %}status-banned{% else %}status-active{% endif %}">
                    {% if chat.banned == '1' %}üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω{% else %}‚úÖ –ê–∫—Ç–∏–≤–µ–Ω{% endif %}
                </div>

                <span class="toggle-icon">‚ñº</span>
            </div>
        </div>

        <div class="chat-details">
            <div class="chat-info">
                <div class="info-item">
                    <strong>üë§ –ü–æ–ª–Ω–æ–µ –∏–º—è:</strong><br>
                    {{ chat.full_name }}
                </div>
                <div class="info-item">
                    <strong>üìÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</strong><br>
                    {{ chat.last_message_date.strftime('%d.%m.%Y %H:%M') }}
                </div>
                <div class="info-item">
                    <strong>üìä –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π:</strong><br>
                    {{ chat.message_count }}
                </div>
                <div class="info-item">
                    <strong>üëÅÔ∏è –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:</strong><br>
                    {{ chat.unread_count }}
                </div>
            </div>

            <div class="chat-actions">
                <button class="btn-open-chat" onclick="openChatModal({{ chat.user_id }}, '{{ chat.username }}')">
                    üí¨ –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
                </button>

                {% if chat.banned == '1' %}
                <button class="btn-unban" onclick="toggleUserBan({{ chat.user_id }}, false)">
                    ‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                </button>
                {% else %}
                <button class="btn-ban" onclick="toggleUserBan({{ chat.user_id }}, true)">
                    üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                </button>
                {% endif %}

                <button class="btn-delete-chat" onclick="deleteChat({{ chat.user_id }})">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–∞—Ç
                </button>

                <a href="/payments/create/" class="btn-pay">üí∏ –û—Ñ–æ—Ä–º–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É</a>
            </div>
        </div>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; background: white; border-radius: var(--radius); box-shadow: 0 4px 12px var(--shadow);">
        <h3>üì≠ –ù–µ—Ç —á–∞—Ç–æ–≤</h3>
        <p>–ß–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</p>
    </div>
    {% endfor %}

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages > 1 %}
    <div class="pagination">
        <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <a href="?page=1{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
           class="page-btn {% if current_page == 1 %}disabled{% endif %}">
            ¬´ –ü–µ—Ä–≤–∞—è
        </a>

        <!-- –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <a href="?page={{ current_page - 1 }}{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
           class="page-btn {% if current_page == 1 %}disabled{% endif %}">
            ‚Äπ –ù–∞–∑–∞–¥
        </a>

        <!-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü -->
        {% for page_num in range(1, total_pages + 1) %}
            {% if page_num >= current_page - 2 and page_num <= current_page + 2 %}
            <a href="?page={{ page_num }}{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
               class="page-btn {% if page_num == current_page %}active{% endif %}">
                {{ page_num }}
            </a>
            {% endif %}
        {% endfor %}

        <!-- –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <a href="?page={{ current_page + 1 }}{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
           class="page-btn {% if current_page == total_pages %}disabled{% endif %}">
            –í–ø–µ—Ä–µ–¥ ‚Ä∫
        </a>

        <!-- –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <a href="?page={{ total_pages }}{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
           class="page-btn {% if current_page == total_pages %}disabled{% endif %}">
            –ü–æ—Å–ª–µ–¥–Ω—è—è ¬ª
        </a>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
<div id="chatModal" class="chat-modal">
    <div class="chat-modal-content" id="chatModalContent">
        <div class="resize-handle right"></div>
        <div class="resize-handle bottom"></div>
        <div class="resize-handle corner"></div>
        <div class="resize-indicator" id="resizeIndicator">800√ó600</div>

        <div class="chat-modal-header" id="chatModalHeader">
            <h3 id="chatModalTitle">–ß–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</h3>
            <div class="chat-modal-controls">
                <button class="modal-control-btn" onclick="minimizeModal()" title="–°–≤–µ—Ä–Ω—É—Ç—å">‚àí</button>
                <button class="modal-control-btn" onclick="maximizeModal()" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚õ∂</button>
                <button class="chat-modal-close" onclick="closeChatModal()" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
            </div>
        </div>

        <div class="chat-messages" id="chatModalMessages">
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>

        <div class="chat-input-area">
            <form class="chat-input-form" onsubmit="sendChatMessage(event)">
                <textarea id="chatMessageInput"
          class="chat-input"
          placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
          rows="1"
          style="resize: none;"
          oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"
          onkeydown="if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); document.querySelector('.chat-input-form').dispatchEvent(new Event('submit', { cancelable: true })); }"
></textarea>
                <button type="submit" class="chat-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>
</div>

<script>
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º
let currentChatUserId = null;
let chatPollInterval = null;
let isUserScrolling = false;
let lastScrollTop = 0;
let isResizing = false;
let startX, startY, startWidth, startHeight;
let originalSize = { width: 800, height: 600 };
let isMinimized = false;
let originalPosition = {};

function resetFilters() {
    window.location.href = '/chats/';
}

function toggleChatDetails(element) {
    element.classList.toggle('expanded');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –î–µ–ª–∞–µ—Ç —Å—Å—ã–ª–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç XSS
function linkify(text) {
    if (!text) return '';
    const escaped = escapeHtml(text);
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ https://, http://, www.
    const urlRegex = /(\b(?:https?:\/\/|www\.)[^\s<>"{}|\\^`[\]]*\b)/gi;
    return escaped.replace(urlRegex, (url) => {
        const fullUrl = url.startsWith('http') ? url : 'http://' + url;
        return `<a href="${fullUrl}" target="_blank" rel="noopener noreferrer"
                   style="color: var(--primary); text-decoration: underline;">${url}</a>`;
    });
}

function formatMoscowTime(timestamp) {
    try {
        let date;

        if (typeof timestamp === 'number') {
            if (timestamp < 10000000000) {
                date = new Date(timestamp * 1000);
            } else {
                date = new Date(timestamp);
            }
        } else if (typeof timestamp === 'string') {
            date = new Date(timestamp);
        } else {
            console.warn('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç timestamp:', timestamp);
            return '--:--';
        }

        if (isNaN(date.getTime())) {
            console.warn('Invalid date –¥–ª—è timestamp:', timestamp);
            return '--:--';
        }

        const moscowOffset = 3 * 60 * 60 * 1000;
        const moscowTime = new Date(date.getTime() + moscowOffset);

        return moscowTime.toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤ formatMoscowTime:', error, 'timestamp:', timestamp);
        return '--:--';
    }
}

function openChatModal(userId, username) {
    currentChatUserId = userId;
    const modal = document.getElementById('chatModal');
    const title = document.getElementById('chatModalTitle');
    const messagesContainer = document.getElementById('chatModalMessages');
    const modalContent = document.getElementById('chatModalContent');

    title.textContent = `–ß–∞—Ç —Å ${username} (ID: ${userId})`;
    modal.style.display = 'flex';

    setModalMaximized();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
    loadChatHistory(userId, messagesContainer);

    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞
    startChatPolling(userId, messagesContainer);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
    initModalDragAndResize();
}

function closeChatModal() {
    const modal = document.getElementById('chatModal');
    modal.style.display = 'none';
    currentChatUserId = null;
    isMinimized = false;

    if (chatPollInterval) {
        clearInterval(chatPollInterval);
        chatPollInterval = null;
    }
}

function minimizeModal() {
    const modalContent = document.getElementById('chatModalContent');
    if (!isMinimized) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏ –ø–æ–∑–∏—Ü–∏—é
        originalSize = {
            width: modalContent.offsetWidth,
            height: modalContent.offsetHeight
        };
        originalPosition = {
            left: modalContent.style.left,
            top: modalContent.style.top
        };

        // –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ–º
        modalContent.style.width = '400px';
        modalContent.style.height = '200px';
        modalContent.style.left = 'calc(100% - 420px)';
        modalContent.style.top = 'calc(100% - 220px)';
        isMinimized = true;
        updateResizeIndicator();
    } else {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
        modalContent.style.width = originalSize.width + 'px';
        modalContent.style.height = originalSize.height + 'px';
        modalContent.style.left = originalPosition.left;
        modalContent.style.top = originalPosition.top;
        isMinimized = false;
        updateResizeIndicator();
    }
}

function setModalMaximized() {
    const modalContent = document.getElementById('chatModalContent');
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–∞–∫ "–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π"
    originalSize = {
        width: modalContent.offsetWidth,
        height: modalContent.offsetHeight
    };
    originalPosition = {
        left: modalContent.style.left || 'calc(50% - 400px)',
        top: modalContent.style.top || 'calc(50% - 300px)'
    };
    // –ú–∞–∫—Å–∏–º–∏–∑–∏—Ä—É–µ–º
    modalContent.style.width = '95vw';
    modalContent.style.height = '95vh';
    modalContent.style.left = '2.5vw';
    modalContent.style.top = '2.5vh';
    updateResizeIndicator();
}

function maximizeModal() {
    const modalContent = document.getElementById('chatModalContent');
    const modal = document.getElementById('chatModal');

    if (modalContent.style.width === '95vw' && modalContent.style.height === '95vh') {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞–∑–º–µ—Ä
        modalContent.style.width = originalSize.width + 'px';
        modalContent.style.height = originalSize.height + 'px';
        modalContent.style.left = originalPosition.left;
        modalContent.style.top = originalPosition.top;
    } else {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –∏ –ø–æ–∑–∏—Ü–∏—é
        originalSize = {
            width: modalContent.offsetWidth,
            height: modalContent.offsetHeight
        };
        originalPosition = {
            left: modalContent.style.left,
            top: modalContent.style.top
        };

        // –ú–∞–∫—Å–∏–º–∏–∑–∏—Ä—É–µ–º
        modalContent.style.width = '95vw';
        modalContent.style.height = '95vh';
        modalContent.style.left = '2.5vw';
        modalContent.style.top = '2.5vh';
    }
    updateResizeIndicator();
}

function updateResizeIndicator() {
    const modalContent = document.getElementById('chatModalContent');
    const resizeIndicator = document.getElementById('resizeIndicator');
    if (!modalContent || !resizeIndicator) return;
    const width = modalContent.offsetWidth;
    const height = modalContent.offsetHeight;
    resizeIndicator.textContent = `${width}√ó${height}`;
}

function initModalDragAndResize() {
    const modalContent = document.getElementById('chatModalContent');
    const header = document.getElementById('chatModalHeader');
    const resizeHandles = modalContent.querySelectorAll('.resize-handle');

    // // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∑–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
    // let isDragging = false;
    // let dragOffset = { x: 0, y: 0 };
    //
    // document.addEventListener('mousemove', drag);
    // document.addEventListener('mouseup', stopDrag);
    //
    // function startDrag(e) {
    //     if (e.target.closest('.modal-control-btn, .chat-modal-close')) return;
    //
    //     isDragging = true;
    //     const rect = modalContent.getBoundingClientRect();
    //     dragOffset.x = e.clientX - rect.left;
    //     dragOffset.y = e.clientY - rect.top;
    //     modalContent.style.cursor = 'grabbing';
    // }
    //
    // function drag(e) {
    //     if (!isDragging) return;
    //
    //     const x = e.clientX - dragOffset.x;
    //     const y = e.clientY - dragOffset.y;
    //
    //     // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–∫–Ω–∞
    //     const maxX = window.innerWidth - modalContent.offsetWidth;
    //     const maxY = window.innerHeight - modalContent.offsetHeight;
    //
    //     modalContent.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
    //     modalContent.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
    // }
    //
    // function stopDrag() {
    //     isDragging = false;
    //     modalContent.style.cursor = '';
    // }

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
    resizeHandles.forEach(handle => {
        handle.addEventListener('mousedown', startResize);
    });

    function startResize(e) {
        e.preventDefault();
        e.stopPropagation();

        isResizing = true;
        startX = e.clientX;
        startY = e.clientY;
        startWidth = parseInt(document.defaultView.getComputedStyle(modalContent).width, 10);
        startHeight = parseInt(document.defaultView.getComputedStyle(modalContent).height, 10);

        modalContent.classList.add('resizing');

        document.addEventListener('mousemove', resize);
        document.addEventListener('mouseup', stopResize);
    }

    function resize(e) {
        if (!isResizing) return;

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        let newWidth = startWidth;
        let newHeight = startHeight;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∑–∞ –∫–∞–∫–æ–π –∫—Ä–∞–π —Ç—è–Ω–µ–º
        if (e.target.classList.contains('right') || e.target.classList.contains('corner')) {
            newWidth = Math.max(400, startWidth + dx);
        }
        if (e.target.classList.contains('bottom') || e.target.classList.contains('corner')) {
            newHeight = Math.max(300, startHeight + dy);
        }

        modalContent.style.width = newWidth + 'px';
        modalContent.style.height = newHeight + 'px';

        updateResizeIndicator();
    }

    function stopResize() {
        isResizing = false;
        modalContent.classList.remove('resizing');
        document.removeEventListener('mousemove', resize);
        document.removeEventListener('mouseup', stopResize);
    }


}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (loadChatHistory, sendChatMessage, etc.)
async function loadChatHistory(userId, container) {
    try {
        const response = await fetch(`/chats/history/?user_id=${userId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const messages = await response.json();

        const wasAtBottom = isScrolledToBottom(container);
        const previousScrollTop = container.scrollTop;
        const previousHeight = container.scrollHeight;

        container.innerHTML = '';

        const textStyles = 'word-wrap: break-word; word-break: break-word; white-space: pre-wrap; margin: 0;';

        messages.forEach((msg, index) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.from_operator ? 'operator' : 'user'}`;

            const messageTime = formatMoscowTime(msg.date);
            let content = '';

            // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç (–∏–ª–∏ caption) –≤ linkify
            const renderText = (text) => text ? `<div style="margin-top: 8px; ${textStyles}">${linkify(text)}</div>` : '';

            // 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞–≥—Ä—É–ø–ø—ã (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ)
            if (Array.isArray(msg.media_group) && msg.media_group.length > 0) {
                const photosHtml = msg.media_group.map(item => {
                    const photoId = item.id || item.message_id || msg.id;
                    const caption = item.caption || msg.caption;
                    return `
                        <div style="margin-bottom: 12px;">
                            <img src="/chats/photo/${photoId}"
                                 alt="–§–æ—Ç–æ –∏–∑ —á–∞—Ç–∞"
                                 style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--primary); cursor: pointer;"
                                 onclick="openChatPhoto('${photoId}')"
                                 onerror="console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: ${photoId}'); this.style.display='none'">

                        </div>
                    `;
                }).join('');

                content = photosHtml + renderText(msg.caption || msg.message);
            }
            // 2. –û–¥–∏–Ω–æ—á–Ω–æ–µ —Ñ–æ—Ç–æ
            else if (msg.has_photo) {
                const photoId = msg.id;
                content = `
                    <div style="margin-bottom: 12px;">
                        <img src="/chats/photo/${photoId}"
                             alt="–§–æ—Ç–æ –∏–∑ —á–∞—Ç–∞"
                             style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--primary); cursor: pointer;"
                             onclick="openChatPhoto('${photoId}')"
                             onerror="console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: ${photoId}'); this.style.display='none'">

                    </div>
                    ${renderText(msg.caption || msg.message)}
                `;
            }
            // 3. –î–æ–∫—É–º–µ–Ω—Ç ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∫–∞–∫ —Å—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            else if (msg.has_document) {
    const fileName = msg.file_name || '–§–∞–π–ª';
    content = `<div style="display: flex; align-items: center; margin: 0;">üìÇ&nbsp;<a href="/chats/download-simple/${msg.id}" style="font-weight: bold; ${textStyles} color: var(--primary); text-decoration: none; cursor: pointer;" title="–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª">${escapeHtml(fileName)}</a></div>${msg.caption ? renderText(msg.caption) : ''}`;
}

            // 7. –û–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            else {
                content = `<div style="${textStyles}">${linkify(msg.message || '(–ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)')}</div>`;
            }

            content += `<div class="message-time">${messageTime}</div>`;
            messageDiv.innerHTML = content;
            container.appendChild(messageDiv);
        });

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞
        if (wasAtBottom || isUserScrolling) {
            container.scrollTop = container.scrollHeight;
        } else {
            const newHeight = container.scrollHeight;
            container.scrollTop = previousScrollTop + (newHeight - previousHeight);
        }

    } catch (error) {
        console.error('‚ùå loadChatHistory error:', error);
        container.innerHTML = `<div style="text-align: center; color: var(--danger); padding: 20px;">
            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞.<br>
            ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
        </div>`;
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function formatFileSize(bytes) {
    if (!bytes) return '';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1024 / 1024).toFixed(1) + ' MB';
}

async function openChatPhoto(messageId) {
    try {
        const photoUrl = `/chats/photo/${messageId}`;

        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; padding: 20px;
        `;

        let scale = 1;
        const minScale = 0.3;
        const maxScale = 3;
        const scaleStep = 0.2;

        modal.innerHTML = `
            <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 10001;">
                <button onclick="downloadCurrentPhoto('${messageId}')"
                        style="background: rgba(255,255,255,0.2); color: white; border: none;
                               width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem;
                               cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s;"
                        onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                        onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                        title="–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ">
                    ‚§ì
                </button>
                <button onclick="this.closest('div').remove()"
                        style="background: rgba(255,255,255,0.2); color: white; border: none;
                               width: 40px; height: 40px; border-radius: 50%; font-size: 1.4rem;
                               cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s;"
                        onmouseover="this.style.background='rgba(255,0,0,0.3)'"
                        onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                        title="–ó–∞–∫—Ä—ã—Ç—å">
                    √ó
                </button>
            </div>

            <div id="photoContainer" style="position: relative; display: flex; justify-content: center; align-items: center;">
                <img id="modalPhoto" src="${photoUrl}"
                     alt="–§–æ—Ç–æ –∏–∑ —á–∞—Ç–∞"
                     style="max-width: 95%; max-height: 85vh; object-fit: contain;
                            border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                            transform: scale(1); transition: transform 0.3s ease; cursor: move;"
                     onerror="alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ')">

                <!-- –ö–Ω–æ–ø–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div style="position: absolute; bottom: -60px; left: 50%; transform: translateX(-50%);
                            display: flex; gap: 15px; align-items: center; background: rgba(0,0,0,0.5);
                            padding: 10px 20px; border-radius: 25px; backdrop-filter: blur(10px);">
                    <button onclick="zoomOut()"
                            style="background: rgba(255,255,255,0.2); color: white; border: none;
                                   width: 36px; height: 36px; border-radius: 50%; font-size: 1.2rem;
                                   cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                            onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                            title="–£–º–µ–Ω—å—à–∏—Ç—å">
                        ‚àí
                    </button>

                    <span id="scaleIndicator"
                          style="color: white; font-size: 0.9rem; min-width: 50px; text-align: center;">
                        100%
                    </span>

                    <button onclick="zoomIn()"
                            style="background: rgba(255,255,255,0.2); color: white; border: none;
                                   width: 36px; height: 36px; border-radius: 50%; font-size: 1.2rem;
                                   cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                            onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                            title="–£–≤–µ–ª–∏—á–∏—Ç—å">
                        +
                    </button>

                    <button onclick="resetZoom()"
                            style="background: rgba(255,255,255,0.2); color: white; border: none;
                                   width: 36px; height: 36px; border-radius: 50%; font-size: 0.9rem;
                                   cursor: pointer; transition: all 0.2s; margin-left: 10px;"
                            onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                            onmouseout="this.style.background='rgba(255,255,255,0.2)'"
                            title="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±">
                        ‚ü≥
                    </button>
                </div>
            </div>
        `;

        // –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        window.zoomIn = function() {
            if (scale < maxScale) {
                scale = Math.min(maxScale, scale + scaleStep);
                updateScale();
            }
        };

        window.zoomOut = function() {
            if (scale > minScale) {
                scale = Math.max(minScale, scale - scaleStep);
                updateScale();
            }
        };

        window.resetZoom = function() {
            scale = 1;
            updateScale();
        };

        function updateScale() {
            const img = modal.querySelector('#modalPhoto');
            const indicator = modal.querySelector('#scaleIndicator');
            if (img) {
                img.style.transform = `scale(${scale})`;
                indicator.textContent = `${Math.round(scale * 100)}%`;
            }
        }

        // Drag to move (–ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
        let isDragging = false;
        let startX, startY, scrollLeft, scrollTop;

        const photoContainer = modal.querySelector('#photoContainer');
        const img = modal.querySelector('#modalPhoto');

        img.addEventListener('mousedown', (e) => {
            if (scale > 1) {
                isDragging = true;
                startX = e.pageX - photoContainer.offsetLeft;
                startY = e.pageY - photoContainer.offsetTop;
                scrollLeft = photoContainer.scrollLeft;
                scrollTop = photoContainer.scrollTop;
                img.style.cursor = 'grabbing';
            }
        });

        modal.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const x = e.pageX - photoContainer.offsetLeft;
            const y = e.pageY - photoContainer.offsetTop;
            const walkX = (x - startX) * 2;
            const walkY = (y - startY) * 2;
            photoContainer.scrollLeft = scrollLeft - walkX;
            photoContainer.scrollTop = scrollTop - walkY;
        });

        modal.addEventListener('mouseup', () => {
            isDragging = false;
            img.style.cursor = scale > 1 ? 'grab' : 'move';
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω –∏–ª–∏ Escape
        modal.onclick = (e) => {
            if (e.target === modal) modal.remove();
        };

        document.addEventListener('keydown', function escClose(e) {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', escClose);
            }
        });

        // Wheel zoom
        modal.addEventListener('wheel', (e) => {
            e.preventDefault();
            if (e.deltaY < 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        });

        document.body.appendChild(modal);

    } catch (error) {
        console.error("‚ùå openChatPhoto error:", error);
        alert(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ: ${error.message}`);
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
function downloadCurrentPhoto(messageId) {
    const a = document.createElement('a');
    a.href = `/chats/photo/${messageId}`;
    a.download = `photo_${messageId}.jpg`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function adjustTextareaHeight(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.max(textarea.scrollHeight, 40) + 'px';
}

async function sendChatMessage(event) {
    event.preventDefault();
    const input = document.getElementById('chatMessageInput');
    const text = input.value.trim();

    if (!text || !currentChatUserId) return;

    try {
        const response = await fetch('/chats/send/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user_id: currentChatUserId, text})
        });

        const result = await response.json();

        if (result.ok) {
            input.value = '';
            adjustTextareaHeight(input);
            await loadChatHistory(currentChatUserId, document.getElementById('chatModalMessages'));
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
}

function startChatPolling(userId, container) {
    if (chatPollInterval) {
        clearInterval(chatPollInterval);
    }

    container.addEventListener('scroll', handleChatScroll);

    chatPollInterval = setInterval(async () => {
        if (currentChatUserId === userId && !isUserScrolling) {
            await loadChatHistory(userId, container);
        }
    }, 10000);
}

function handleChatScroll(event) {
    const container = event.target;
    const scrollTop = container.scrollTop;

    if (Math.abs(scrollTop - lastScrollTop) > 5) {
        isUserScrolling = true;

        clearTimeout(window.scrollTimeout);
        window.scrollTimeout = setTimeout(() => {
            isUserScrolling = false;
        }, 2000);
    }

    lastScrollTop = scrollTop;
}

function isScrolledToBottom(container) {
    const threshold = 100;
    return container.scrollHeight - container.scrollTop - container.clientHeight <= threshold;
}

async function toggleUserBan(userId, ban) {
    const action = ban ? '–±–ª–æ–∫–∏—Ä–æ–≤–∫—É' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É';

    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å ${action} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}?`)) {
        return;
    }

    try {
        const endpoint = ban ? '/chats/user/ban' : '/chats/user/unban';

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: parseInt(userId)
            })
        });

        const result = await response.json();

        if (result.ok) {
            alert(`‚úÖ ${result.message}`);
            location.reload();
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeChatModal();
    }
});

async function deleteChat(userId) {
    if (!confirm(`‚ùå –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤–µ—Å—å —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${userId}?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏. –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!`)) {
        return;
    }

    try {
        const response = await fetch('/chats/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: parseInt(userId)
            })
        });

        const result = await response.json();

        if (result.ok) {
            alert(`‚úÖ ${result.message}`);
            const chatElement = document.querySelector(`[data-user-id="${userId}"]`);
            if (chatElement) {
                chatElement.style.opacity = '0';
                chatElement.style.transform = 'translateX(-100%)';
                setTimeout(() => {
                    chatElement.remove();
                    updateChatsCount();
                }, 300);
            }
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
}

function updateChatsCount() {
    const chatItems = document.querySelectorAll('.chat-item');
    const summaryElement = document.querySelector('.summary');

    if (summaryElement) {
        const currentText = summaryElement.textContent;
        const newCount = chatItems.length;
        summaryElement.textContent = currentText.replace(/\d+/, newCount);
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
let refreshInterval = null;

function startAutoRefresh() {
    refreshInterval = setInterval(() => {
        refreshChatsList();
    }, 30000);

    console.log("üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω–æ");
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
        console.log("‚èπÔ∏è –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
    }
}

async function refreshChatsList() {
    try {
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);

        const username = params.get('username') || '';
        const dateFrom = params.get('date_from') || '';
        const dateTo = params.get('date_to') || '';
        const hasUnread = params.get('has_unread') || '';
        const page = params.get('page') || '1';

        let refreshUrl = `/chats/?page=${page}`;
        if (username) refreshUrl += `&username=${encodeURIComponent(username)}`;
        if (dateFrom) refreshUrl += `&date_from=${dateFrom}`;
        if (dateTo) refreshUrl += `&date_to=${dateTo}`;
        if (hasUnread) refreshUrl += `&has_unread=${hasUnread}`;

        const response = await fetch(refreshUrl);
        const html = await response.text();

        const parser = new DOMParser();
        const newDocument = parser.parseFromString(html, 'text/html');
        const newChatsContainer = newDocument.querySelector('.container');

        if (newChatsContainer) {
            const currentlyOpen = [];
            document.querySelectorAll('.chat-item.expanded').forEach(chat => {
                const userId = chat.dataset.userId;
                if (userId) currentlyOpen.push(userId);
            });

            document.querySelector('.container').innerHTML = newChatsContainer.innerHTML;

            currentlyOpen.forEach(userId => {
                const chatElement = document.querySelector(`[data-user-id="${userId}"]`);
                if (chatElement) {
                    chatElement.classList.add('expanded');
                }
            });

            console.log("‚úÖ –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω");
        }

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–≤:', error);
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    startAutoRefresh();
});



function downloadPhoto(messageId, filename = `photo_${messageId}.jpg`) {
    try {
        const url = `/chats/photo/${messageId}`;
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
        }, 100);
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ:', e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ');
    }
}

</script>
</body>
</html>
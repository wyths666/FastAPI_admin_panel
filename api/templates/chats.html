<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏</title>
    <style>
        :root {
            --primary: #4361ee;
            --success: #4cc9f0;
            --warning: #ff5c1a;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.1);
            --radius: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-logout {
            background: var(--danger);
            padding: 10px 20px;
            font-size: 1rem;
            display: inline-block;
            color: white;
            text-decoration: none;
            border-radius: var(--radius);
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn-back {
            display: inline-block;
            padding: 10px 20px;
            background: var(--gray);
            color: white;
            text-decoration: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
        }

        .filters {
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px var(--shadow);
            padding: 20px;
            margin-bottom: 30px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
        }

        .filter-button {
            height: 40px;
            line-height: 40px;
            text-align: center;
            padding: 0 20px;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            width: 120px;
            box-sizing: border-box;
            background-color: var(--primary);
            color: white;
        }

        .filter-button:hover {
            background-color: #3a56e4;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px var(--shadow);
        }

        h1 {
            font-size: 2.2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .summary {
            font-size: 1.2rem;
            color: var(--gray);
        }

        .chat-item {
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 10px var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .chat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--shadow);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(to right, #f1f3f9, #e9ecef);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-username {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .chat-user-id {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .chat-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .unread-badge {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .chat-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
        }

        .status-active { background: #d1ecf1; color: #0c5460; }
        .status-banned { background: #f8d7da; color: #721c24; }

        .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .chat-item.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .chat-details {
            display: none;
            padding: 20px;
            background: white;
        }

        .chat-item.expanded .chat-details {
            display: block;
        }

        .chat-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .info-item strong {
            color: var(--dark);
        }

        .chat-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-open-chat {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-ban {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-unban {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-pay {
            display: inline-block;
            padding: 10px 20px;
            background: #09ad50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ */
        .chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .chat-modal-content {
            background: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 800px;
            height: 80%;
            display: flex;
            flex-direction: column;
        }

        .chat-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-modal-close {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px;
            border-radius: 12px;
            position: relative;
        }

        .message.operator {
            background: #e3f2fd;
            align-self: flex-end;
            text-align: right;
        }

        .message.user {
            background: #f5f5f5;
            align-self: flex-start;
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
        }

        .chat-send {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            gap: 10px;
        }

        .pagination-info {
            text-align: center;
            margin-bottom: 15px;
            color: var(--gray);
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            color: var(--dark);
        }

        .page-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.disabled:hover {
            background: white;
            color: var(--dark);
            border-color: var(--border);
        }

        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
            }
            .filter-button {
                align-self: stretch;
            }
            .chat-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .chat-stats {
                align-self: stretch;
                justify-content: space-between;
            }
            .message {
                max-width: 85%;
            }
        }
        .chat-header.has-unread {
    background: linear-gradient(to right, #fff3cd, #ffeaa7) !important;
    border-left: 4px solid #ffc107 !important;
}

.chat-header.has-unread .chat-username {
    color: #e74c3c !important;
    font-weight: bold !important;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
@keyframes pulse-new {
    0% { background-color: transparent; }
    50% { background-color: #fff3cd; }
    100% { background-color: transparent; }
}

.chat-header.new-message {
    animation: pulse-new 2s ease-in-out;
}
.btn-delete-chat {
    background: var(--warning);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;

    transition: all 0.3s ease;
}

.btn-delete-chat:hover {
    background: #e71d36;
    transform: translateY(-2px);
}
    </style>
</head>
<body>
<div class="container">
    <div class="header-actions">
        <a href="/" class="btn-back">‚Üê –ù–∞–∑–∞–¥</a>
        <a href="/auth/logout" class="btn-logout">üö™ –í—ã–π—Ç–∏</a>
    </div>

    <header>
        <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏</h1>
        <p class="summary">–í—Å–µ–≥–æ —á–∞—Ç–æ–≤: {{ total_chats }}</p>
    </header>

    <div class="filters">
        <form id="filter-form" method="GET">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                    <input type="text" id="username" name="username" value="{{ username or '' }}"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
                </div>

                <div class="filter-group">
                    <label for="date_from">–î–∞—Ç–∞ –æ—Ç:</label>
                    <input type="date" id="date_from" name="date_from" value="{{ date_from or '' }}">
                </div>

                <div class="filter-group">
                    <label for="date_to">–î–∞—Ç–∞ –¥–æ:</label>
                    <input type="date" id="date_to" name="date_to" value="{{ date_to or '' }}">
                </div>

                <div class="filter-group">
                    <label for="has_unread" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="has_unread" name="has_unread"
                               {% if has_unread %}checked{% endif %}>
                        –¢–æ–ª—å–∫–æ —Å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
                    </label>
                </div>

                <input type="hidden" name="page" value="1">

                <button type="submit" class="filter-button">üîç –§–∏–ª—å—Ç—Ä</button>
                <button type="button" class="filter-button" onclick="resetFilters()" style="background-color: #8f8f8f;">‚ùå –°–±—Ä–æ—Å</button>
            </div>
        </form>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
    {% if total_chats > 0 %}
    <div class="pagination-info">
        –ü–æ–∫–∞–∑–∞–Ω—ã —á–∞—Ç—ã —Å {{ start_chat }} –ø–æ {{ end_chat }} –∏–∑ {{ total_chats }}
    </div>
    {% endif %}

    {% for chat in chats %}
    <div class="chat-item" data-user-id="{{ chat.user_id }}">
        <div class="chat-header" onclick="toggleChatDetails(this.parentElement)">
            <div class="chat-user-info">
                <div>
                    <div class="chat-username">
                        {% if chat.unread_count > 0 %}
                        <span style="color: red;">üì© </span>
                        {% endif %}
                        {{ chat.username }}
                    </div>
                    <div class="chat-user-id">ID: {{ chat.user_id }}</div>
                </div>
            </div>

            <div class="chat-stats">
                {% if chat.unread_count > 0 %}
                <div class="unread-badge">{{ chat.unread_count }}</div>
                {% endif %}

                <div class="chat-status {% if chat.banned == '1' %}status-banned{% else %}status-active{% endif %}">
                    {% if chat.banned == '1' %}üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω{% else %}‚úÖ –ê–∫—Ç–∏–≤–µ–Ω{% endif %}
                </div>

                <span class="toggle-icon">‚ñº</span>
            </div>
        </div>

        <div class="chat-details">
            <div class="chat-info">
                <div class="info-item">
                    <strong>üë§ –ü–æ–ª–Ω–æ–µ –∏–º—è:</strong><br>
                    {{ chat.full_name }}
                </div>
                <div class="info-item">
                    <strong>üìÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</strong><br>
                    {{ chat.last_message_date.strftime('%d.%m.%Y %H:%M') }}
                </div>
                <div class="info-item">
                    <strong>üìä –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π:</strong><br>
                    {{ chat.message_count }}
                </div>
                <div class="info-item">
                    <strong>üëÅÔ∏è –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:</strong><br>
                    {{ chat.unread_count }}
                </div>
            </div>



            <div class="chat-actions">
    <button class="btn-open-chat" onclick="openChatModal({{ chat.user_id }}, '{{ chat.username }}')">
        üí¨ –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
    </button>

    {% if chat.banned == '1' %}
    <button class="btn-unban" onclick="toggleUserBan({{ chat.user_id }}, false)">
        ‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
    </button>
    {% else %}
    <button class="btn-ban" onclick="toggleUserBan({{ chat.user_id }}, true)">
        üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
    </button>
    {% endif %}

    <button class="btn-delete-chat" onclick="deleteChat({{ chat.user_id }})">
        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–∞—Ç
    </button>

    <a href="/payments/create/" class="btn-pay">üí∏ –û—Ñ–æ—Ä–º–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É</a>
            </div>
        </div>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; background: white; border-radius: var(--radius); box-shadow: 0 4px 12px var(--shadow);">
        <h3>üì≠ –ù–µ—Ç —á–∞—Ç–æ–≤</h3>
        <p>–ß–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</p>
    </div>
    {% endfor %}

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages > 1 %}
    <div class="pagination">
        <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <a href="?page=1{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
           class="page-btn {% if current_page == 1 %}disabled{% endif %}">
            ¬´ –ü–µ—Ä–≤–∞—è
        </a>

        <!-- –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <a href="?page={{ current_page - 1 }}{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
           class="page-btn {% if current_page == 1 %}disabled{% endif %}">
            ‚Äπ –ù–∞–∑–∞–¥
        </a>

        <!-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü -->
        {% for page_num in range(1, total_pages + 1) %}
            {% if page_num >= current_page - 2 and page_num <= current_page + 2 %}
            <a href="?page={{ page_num }}{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
               class="page-btn {% if page_num == current_page %}active{% endif %}">
                {{ page_num }}
            </a>
            {% endif %}
        {% endfor %}

        <!-- –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <a href="?page={{ current_page + 1 }}{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
           class="page-btn {% if current_page == total_pages %}disabled{% endif %}">
            –í–ø–µ—Ä–µ–¥ ‚Ä∫
        </a>

        <!-- –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <a href="?page={{ total_pages }}{% if username %}&username={{ username }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if has_unread %}&has_unread=true{% endif %}"
           class="page-btn {% if current_page == total_pages %}disabled{% endif %}">
            –ü–æ—Å–ª–µ–¥–Ω—è—è ¬ª
        </a>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
<div id="chatModal" class="chat-modal">
    <div class="chat-modal-content">
        <div class="chat-modal-header">
            <h3 id="chatModalTitle">–ß–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</h3>
            <button class="chat-modal-close" onclick="closeChatModal()">√ó</button>
        </div>

        <div class="chat-messages" id="chatModalMessages">
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>

        <div class="chat-input-area">
            <form class="chat-input-form" onsubmit="sendChatMessage(event)">
                <input type="text" class="chat-input" id="chatMessageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required>
                <button type="submit" class="chat-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>
</div>

<script>
function resetFilters() {
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
    window.location.href = '/chats/';
}

let currentChatUserId = null;
let chatPollInterval = null;
let isUserScrolling = false;
let lastScrollTop = 0;

function toggleChatDetails(element) {
    element.classList.toggle('expanded');
}

function openChatModal(userId, username) {
    currentChatUserId = userId;
    const modal = document.getElementById('chatModal');
    const title = document.getElementById('chatModalTitle');
    const messagesContainer = document.getElementById('chatModalMessages');

    title.textContent = `–ß–∞—Ç —Å ${username} (ID: ${userId})`;
    modal.style.display = 'flex';

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
    loadChatHistory(userId, messagesContainer);

    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
    startChatPolling(userId, messagesContainer);
}

function closeChatModal() {
    const modal = document.getElementById('chatModal');
    modal.style.display = 'none';
    currentChatUserId = null;

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ä–æ—Å
    if (chatPollInterval) {
        clearInterval(chatPollInterval);
        chatPollInterval = null;
    }
}

async function loadChatHistory(userId, container) {
    try {
        const response = await fetch(`/chats/history/?user_id=${userId}`);
        const messages = await response.json();

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        const wasAtBottom = isScrolledToBottom(container);
        const previousScrollTop = container.scrollTop;
        const previousHeight = container.scrollHeight;

        container.innerHTML = '';

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        messages.forEach((msg, index) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.from_operator ? 'operator' : 'user'}`;

            const messageTime = new Date(msg.date).toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });

            let content = '';

            if (msg.has_photo) {
                // –§–æ—Ç–æ
                content = `
                    <div style="margin-bottom: 8px;">
                            <img src="/chats/photo/${msg.id}"
                             alt="–§–æ—Ç–æ –∏–∑ —á–∞—Ç–∞"
                 style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--primary); cursor: pointer;"
                 onclick="openChatPhoto('${msg.id}')"
                 onerror="console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: ${msg.id}'); this.style.display='none'">
        </div>
                    ${msg.message ? `<div style="margin-top: 8px;">${msg.message}</div>` : ''}
    `;
} else if (msg.has_document) {
                // –î–æ–∫—É–º–µ–Ω—Ç (—Ñ–∞–π–ª)
                const fileSize = msg.file_size ? ` (${formatFileSize(msg.file_size)})` : '';
                content = `
                    <div style="margin-bottom: 8px; padding: 10px; background: #f0f8ff; border-radius: 8px; border: 1px solid #d1e7ff;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">üìé</span>
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${msg.file_name || '–§–∞–π–ª'}</div>
                                <div style="font-size: 0.8rem; color: #666;">
                                    ${msg.mime_type || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø'}${fileSize}
                                </div>
                            </div>
                            <button onclick="downloadFile('${msg.id}')"
                                    style="background: var(--primary); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                –°–∫–∞—á–∞—Ç—å
                            </button>
                        </div>
                    </div>
                    ${msg.message ? `<div style="margin-top: 8px;">${msg.message}</div>` : ''}
                `;
            } else if (msg.has_audio) {
                // –ê—É–¥–∏–æ –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ
                const isVoice = msg.file_type === 'voice';
                const icon = isVoice ? 'üé§' : 'üéµ';
                const label = isVoice ? '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ' : '–ê—É–¥–∏–æ';
                const fileSize = msg.file_size ? ` (${formatFileSize(msg.file_size)})` : '';

                content = `
                    <div style="margin-bottom: 8px; padding: 10px; background: #fff0f5; border-radius: 8px; border: 1px solid #ffd1dc;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">${icon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${label}</div>
                                <div style="font-size: 0.8rem; color: #666;">
                                    ${msg.mime_type || ''}${fileSize}
                                </div>
                            </div>
                            <button onclick="playAudio('${msg.id}')"
                                    style="background: var(--success); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                ‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
                            </button>
                        </div>
                    </div>
                    ${msg.message ? `<div style="margin-top: 8px;">${msg.message}</div>` : ''}
                `;
            } else if (msg.has_video) {
                // –í–∏–¥–µ–æ
                const isVideoNote = msg.file_type === 'video_note';
                const icon = isVideoNote ? 'üìπ' : 'üé•';
                const label = isVideoNote ? '–í–∏–¥–µ–æ-–∫—Ä—É–∂–æ—á–µ–∫' : '–í–∏–¥–µ–æ';
                const fileSize = msg.file_size ? ` (${formatFileSize(msg.file_size)})` : '';

                content = `
                    <div style="margin-bottom: 8px; padding: 10px; background: #f0f0f0; border-radius: 8px; border: 1px solid #ddd;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">${icon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${label}</div>
                                <div style="font-size: 0.8rem; color: #666;">
                                    ${msg.mime_type || ''}${fileSize}
                                </div>
                            </div>
                            <button onclick="playVideo('${msg.id}')"
                                    style="background: var(--warning); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                ‚ñ∂Ô∏è –°–º–æ—Ç—Ä–µ—Ç—å
                            </button>
                        </div>
                    </div>
                    ${msg.message ? `<div style="margin-top: 8px;">${msg.message}</div>` : ''}
                `;
            } else if (msg.file_type === 'sticker') {
                // –°—Ç–∏–∫–µ—Ä
                content = `
                    <div style="margin-bottom: 8px; text-align: center;">
                        <div style="font-size: 3rem;">${msg.message}</div>
                        <div style="font-size: 0.8rem; color: #666;">–°—Ç–∏–∫–µ—Ä</div>
                    </div>
                `;
            } else {
                // –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                content = `
                    <div>${msg.message || ''}</div>
                `;
            }

            content += `<div class="message-time">${messageTime}</div>`;
            messageDiv.innerHTML = content;
            container.appendChild(messageDiv);
        });

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        if (wasAtBottom || isUserScrolling) {
            container.scrollTop = container.scrollHeight;
        } else {
            const newHeight = container.scrollHeight;
            container.scrollTop = previousScrollTop + (newHeight - previousHeight);
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        container.innerHTML = '<div style="text-align: center; color: var(--gray);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function formatFileSize(bytes) {
    if (!bytes) return '';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1024 / 1024).toFixed(1) + ' MB';
}

function downloadFile(messageId) {
    // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    window.open(`/chats/download/${messageId}`, '_blank');
}

function playAudio(messageId) {
    // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ
    window.open(`/chats/audio/${messageId}`, '_blank');
}

function playVideo(messageId) {
    // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ
    window.open(`/chats/video/${messageId}`, '_blank');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ç–æ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
async function openChatPhoto(messageId) {
    try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ proxy —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        const photoUrl = `/chats/photo/${messageId}`;

        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; padding: 20px;
        `;

        modal.innerHTML = `
            <button onclick="this.parentElement.remove()"
                    style="align-self: flex-end; background: #fff; color: #000;
                           border: none; width: 36px; height: 36px; border-radius: 50%;
                           font-size: 1.4rem; margin-bottom: 10px; cursor: pointer;">
                √ó
            </button>
            <img src="${photoUrl}"
                 alt="–§–æ—Ç–æ –∏–∑ —á–∞—Ç–∞"
                 style="max-width: 95%; max-height: 85vh; object-fit: contain;
                        border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);"
                 onerror="alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ')">
        `;

        modal.onclick = (e) => {
            if (e.target === modal) modal.remove();
        };

        document.addEventListener('keydown', function escClose(e) {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', escClose);
            }
        });

        document.body.appendChild(modal);

    } catch (error) {
        console.error("‚ùå openChatPhoto error:", error);
        alert(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ: ${error.message}`);
    }
}


async function sendChatMessage(event) {
    event.preventDefault();
    const input = document.getElementById('chatMessageInput');
    const text = input.value.trim();

    if (!text || !currentChatUserId) return;

    try {
        const response = await fetch('/chats/send/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user_id: currentChatUserId, text})
        });

        const result = await response.json();

        if (result.ok) {
            input.value = '';
            // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
            await loadChatHistory(currentChatUserId, document.getElementById('chatModalMessages'));
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
}

function startChatPolling(userId, container) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
    if (chatPollInterval) {
        clearInterval(chatPollInterval);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    container.addEventListener('scroll', handleChatScroll);

    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ (–≤–º–µ—Å—Ç–æ 3)
    chatPollInterval = setInterval(async () => {
        if (currentChatUserId === userId && !isUserScrolling) {
            await loadChatHistory(userId, container);
        }
    }, 10000); // 10 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ 3
}
function handleChatScroll(event) {
    const container = event.target;
    const scrollTop = container.scrollTop;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–∫—Ä–æ–ª–ª–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if (Math.abs(scrollTop - lastScrollTop) > 5) {
        isUserScrolling = true;

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞
        clearTimeout(window.scrollTimeout);
        window.scrollTimeout = setTimeout(() => {
            isUserScrolling = false;
        }, 2000); // –°—á–∏—Ç–∞–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫–æ–Ω—á–∏–ª —Å–∫—Ä–æ–ª–ª–∏—Ç—å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    }

    lastScrollTop = scrollTop;
}

function isScrolledToBottom(container) {
    const threshold = 100; // –ø–∏–∫—Å–µ–ª–µ–π –æ—Ç –Ω–∏–∑–∞
    return container.scrollHeight - container.scrollTop - container.clientHeight <= threshold;
}

async function toggleUserBan(userId, ban) {
    const action = ban ? '–±–ª–æ–∫–∏—Ä–æ–≤–∫—É' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É';

    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å ${action} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}?`)) {
        return;
    }

    try {
        const endpoint = ban ? '/chats/user/ban' : '/chats/user/unban';

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: parseInt(userId)
            })
        });

        const result = await response.json();

        if (result.ok) {
            alert(`‚úÖ ${result.message}`);
            location.reload();
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeChatModal();
    }
});

async function deleteChat(userId) {
    if (!confirm(`‚ùå –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤–µ—Å—å —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${userId}?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏. –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!`)) {
        return;
    }

    try {
        const response = await fetch('/chats/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: parseInt(userId)
            })
        });

        const result = await response.json();

        if (result.ok) {
            alert(`‚úÖ ${result.message}`);
            // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç —á–∞—Ç–∞ –∏–∑ DOM
            const chatElement = document.querySelector(`[data-user-id="${userId}"]`);
            if (chatElement) {
                chatElement.style.opacity = '0';
                chatElement.style.transform = 'translateX(-100%)';
                setTimeout(() => {
                    chatElement.remove();
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —á–∞—Ç–æ–≤
                    updateChatsCount();
                }, 300);
            }
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ —á–∞—Ç–æ–≤
function updateChatsCount() {
    const chatItems = document.querySelectorAll('.chat-item');
    const summaryElement = document.querySelector('.summary');

    if (summaryElement) {
        const currentText = summaryElement.textContent;
        const newCount = chatItems.length;
        summaryElement.textContent = currentText.replace(/\d+/, newCount);
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
let refreshInterval = null;

function startAutoRefresh() {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    refreshInterval = setInterval(() => {
        refreshChatsList();
    }, 30000); // 30 —Å–µ–∫—É–Ω–¥

    console.log("üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω–æ");
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
        console.log("‚èπÔ∏è –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
    }
}

async function refreshChatsList() {
    try {
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        const username = params.get('username') || '';
        const dateFrom = params.get('date_from') || '';
        const dateTo = params.get('date_to') || '';
        const hasUnread = params.get('has_unread') || '';
        const page = params.get('page') || '1';

        // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        let refreshUrl = `/chats/?page=${page}`;
        if (username) refreshUrl += `&username=${encodeURIComponent(username)}`;
        if (dateFrom) refreshUrl += `&date_from=${dateFrom}`;
        if (dateTo) refreshUrl += `&date_to=${dateTo}`;
        if (hasUnread) refreshUrl += `&has_unread=${hasUnread}`;

        const response = await fetch(refreshUrl);
        const html = await response.text();

        // –ü–∞—Ä—Å–∏–º HTML –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        const parser = new DOMParser();
        const newDocument = parser.parseFromString(html, 'text/html');
        const newChatsContainer = newDocument.querySelector('.container');

        if (newChatsContainer) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —á–∞—Ç–æ–≤
            const currentlyOpen = [];
            document.querySelectorAll('.chat-item.expanded').forEach(chat => {
                const userId = chat.dataset.userId;
                if (userId) currentlyOpen.push(userId);
            });

            // –ó–∞–º–µ–Ω—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            document.querySelector('.container').innerHTML = newChatsContainer.innerHTML;

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ —á–∞—Ç—ã
            currentlyOpen.forEach(userId => {
                const chatElement = document.querySelector(`[data-user-id="${userId}"]`);
                if (chatElement) {
                    chatElement.classList.add('expanded');
                }
            });

            console.log("‚úÖ –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω");
        }

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–≤:', error);
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    startAutoRefresh();
});

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', () => {
    stopAutoRefresh();
});
</script>
</body>
</html>
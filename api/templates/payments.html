<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
    <style>
        :root {
            --primary: #4361ee;
            --success: #4cc9f0;
            --warning: #ff5c1a;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.1);
            --radius: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        /* –ù–∞–≤–±–∞—Ä */
.navbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 0 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    min-height: 64px;
}

.nav-brand {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.nav-logo {
    font-size: 1.5rem;
}

.nav-title {
    color: white;
    font-weight: 600;
    font-size: 1.25rem;
}

.nav-links {
    display: flex;
    gap: 0.5rem;
}

.nav-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    transition: all 0.2s;
    font-weight: 500;
}

.nav-link:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    transform: translateY(-1px);
}

.nav-link.active {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.nav-icon {
    font-size: 1.125rem;
}

.nav-text {
    font-size: 0.875rem;
}

.nav-actions {
    display: flex;
    align-items: center;
}

.nav-logout {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #fecaca;
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: all 0.2s;
    font-weight: 500;
    background: rgba(239, 68, 68, 0.2);
}

.nav-logout:hover {
    background: rgba(239, 68, 68, 0.3);
    transform: translateY(-1px);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 1024px) {
    .nav-text {
        display: none;
    }

    .nav-link {
        padding: 0.75rem;
    }

    .nav-brand .nav-title {
        display: none;
    }
}

@media (max-width: 768px) {
    .navbar {
        flex-direction: column;
        padding: 1rem;
        gap: 1rem;
    }

    .nav-links {
        flex-wrap: wrap;
        justify-content: center;
    }
}
        .btn-logout {
            background: var(--danger);
            padding: 10px 20px;
            font-size: 1rem;
            display: inline-block;
            color: white;
            text-decoration: none;
            border-radius: var(--radius);
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn-back {
            display: inline-block;
            padding: 10px 20px;
            background: var(--gray);
            color: white;
            text-decoration: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px var(--shadow);
        }

        h1 {
            font-size: 2.2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .payment-form {
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px var(--shadow);
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 16px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .payment-section {
            display: none;
            padding: 15px;
            background: var(--light);
            border-radius: 4px;
            margin-top: 10px;
        }

        .btn-pay {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-pay:hover {
            background: #3a56e4;
        }

        .btn-pay:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }

        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d1edff;
            color: #0c5460;
            border: 1px solid #b8daff;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 10px;
        }

        @media (max-width: 768px) {
            .header-actions {
                flex-direction: column;
                gap: 10px;
            }

            .btn-back,
            .btn-logout {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="navbar">


    <div class="nav-links">
        <a href="/chats/" class="nav-link">
            <span class="nav-icon">ü§ñ</span>
            <span class="nav-text">–ß–∞—Ç—ã (–í—ã–∫—É–ø—ã)</span>
        </a>

        <a href="/claims/" class="nav-link">
            <span class="nav-icon">üé´</span>
            <span class="nav-text">–ó–∞—è–≤–∫–∏ (–õ–æ—Ç–µ—Ä–µ—è)</span>
        </a>
         <a href="/support/" class="nav-link">
            <span class="nav-icon">üí¨</span>
            <span class="nav-text">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
        </a>
    </div>

    <div class="nav-actions">
        <a href="/auth/logout" class="nav-logout">
            <span class="nav-icon">üö™</span>
            <span class="nav-text">–í—ã–π—Ç–∏</span>
        </a>
    </div>
</div>

    <header>
        <h1>üì§ –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã</h1>
        <p class="summary">–†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Konsol API</p>
    </header>

    <div class="alert" id="alert"></div>

    <div class="payment-form">
        <form id="paymentForm">
            <!-- –¢–∏–ø –≤—ã–ø–ª–∞—Ç—ã -->
            <div class="form-group">
                <label for="payment_type">üí≥ –¢–∏–ø –≤—ã–ø–ª–∞—Ç—ã:</label>
                <select id="payment_type" name="payment_type" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤—ã–ø–ª–∞—Ç—ã</option>
                    <option value="card">üí≥ –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É</option>
                    <option value="fps">üì± –ü–µ—Ä–µ–≤–æ–¥ –ø–æ –°–ë–ü</option>
                </select>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –∫–∞—Ä—Ç—ã -->
            <div id="cardSection" class="payment-section">
                <div class="form-group">
                    <label for="card_number">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</label>
                    <input type="text" id="card_number" name="card_number"
       placeholder="0000 0000 0000 0000" maxlength="19"
       autocomplete="cc-number">
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –°–ë–ü -->
            <div id="fpsSection" class="payment-section">
                <div class="form-group">
                    <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                    <input type="tel" id="phone" name="phone"
       placeholder="+7 900 123-45-67"
       autocomplete="tel">
                </div>
                <div class="form-group">
                    <label for="bank_member_id">–ë–∞–Ω–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
                    <select id="bank_member_id" name="bank_member_id">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫</option>
                        {% for bank_id, bank_name in banks.items() %}
                        <option value="{{ bank_id }}">{{ bank_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- –°—É–º–º–∞ -->
            <div class="form-group">
                <label for="amount">üí∞ –°—É–º–º–∞ –≤—ã–ø–ª–∞—Ç—ã (—Ä—É–±):</label>
                <input type="number" id="amount" name="amount"
                       step="0.01" min="1" required placeholder="100.00">
            </div>

            <!-- –ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è -->
            <div class="form-group">
                <label for="first_name">üë§ –ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
                <input type="text" id="first_name" name="first_name" value="–í—ã–ø–ª–∞—Ç–∞" required>
            </div>

            <!-- –§–∞–º–∏–ª–∏—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è -->
            <div class="form-group">
                <label for="last_name">üë§ –§–∞–º–∏–ª–∏—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
                <input type="text" id="last_name" name="last_name" value="–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è" required>
            </div>

            <!-- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ -->
            <div class="form-group">
                <label for="purpose">üìù –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:</label>
                <input type="text" id="purpose" name="purpose"
                       value="–í—ã–ø–ª–∞—Ç–∞" required>
            </div>

            <button type="submit" class="btn-pay" id="submitBtn">
                üí∏ –°–æ–∑–¥–∞—Ç—å –≤—ã–ø–ª–∞—Ç—É
            </button>
        </form>

        <div id="loading" class="loading">
            ‚è≥ –°–æ–∑–¥–∞–µ–º –≤—ã–ø–ª–∞—Ç—É...
        </div>
    </div>
</div>

<script>
    // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function formatCardNumber(value) {
        let cleanValue = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        return cleanValue.replace(/(.{4})/g, '$1 ').trim().substring(0, 19);
    }

    function formatPhoneNumber(value) {
        let cleanValue = value.replace(/\D/g, '');

        if (cleanValue.startsWith('7')) {
            cleanValue = cleanValue.substring(1);
        } else if (cleanValue.startsWith('8')) {
            cleanValue = cleanValue.substring(1);
        }

        let formatted = '+7';
        if (cleanValue.length > 0) {
            formatted += ' ' + cleanValue.substring(0, 3);
        }
        if (cleanValue.length > 3) {
            formatted += ' ' + cleanValue.substring(3, 6);
        }
        if (cleanValue.length > 6) {
            formatted += '-' + cleanValue.substring(6, 8);
        }
        if (cleanValue.length > 8) {
            formatted += '-' + cleanValue.substring(8, 10);
        }

        return formatted.substring(0, 16);
    }

    function cleanCardNumber(value) {
        return value ? value.replace(/\s/g, '') : '';
    }

    function cleanPhoneNumber(value) {
        return value ? value.replace(/\s/g, '').replace(/-/g, '').replace('+', '') : '';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π
    function initializeFieldHandlers() {
        const cardInput = document.getElementById('card_number');
        const phoneInput = document.getElementById('phone');

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ä—Ç—ã
        if (cardInput) {
            const handleCardInput = (event, source) => {
                console.log(`üí≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ä—Ç—ã (${source}):`, event.target.value);
                event.target.value = formatCardNumber(event.target.value);
            };

            cardInput.addEventListener('input', (e) => handleCardInput(e, 'input'));
            cardInput.addEventListener('change', (e) => handleCardInput(e, 'change'));
            cardInput.addEventListener('blur', (e) => handleCardInput(e, 'blur'));

            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            setTimeout(() => {
                if (cardInput.value) {
                    cardInput.value = formatCardNumber(cardInput.value);
                }
            }, 100);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        if (phoneInput) {
            const handlePhoneInput = (event, source) => {
                console.log(`üì± –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (${source}):`, event.target.value);
                event.target.value = formatPhoneNumber(event.target.value);
            };

            phoneInput.addEventListener('input', (e) => handlePhoneInput(e, 'input'));
            phoneInput.addEventListener('change', (e) => handlePhoneInput(e, 'change'));
            phoneInput.addEventListener('blur', (e) => handlePhoneInput(e, 'blur'));

            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            setTimeout(() => {
                if (phoneInput.value) {
                    phoneInput.value = formatPhoneNumber(phoneInput.value);
                }
            }, 100);
        }
    }

    // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ —Å–µ–∫—Ü–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≤—ã–ø–ª–∞—Ç—ã
    function initializePaymentTypeHandler() {
        const paymentTypeSelect = document.getElementById('payment_type');
        if (paymentTypeSelect) {
            paymentTypeSelect.addEventListener('change', function() {
                const type = this.value;
                document.getElementById('cardSection').style.display =
                    type === 'card' ? 'block' : 'none';
                document.getElementById('fpsSection').style.display =
                    type === 'fps' ? 'block' : 'none';
            });
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    function initializeFormHandler() {
        const form = document.getElementById('paymentForm');
        if (!form) return;

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            console.log('üì§ –ù–∞—á–∞–ª–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã...');

            const formData = new FormData(this);
            const rawData = Object.fromEntries(formData);

            console.log('üìù –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã:', rawData);

            // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            const data = {
                ...rawData,
                card_number: cleanCardNumber(rawData.card_number),
                phone: cleanPhoneNumber(rawData.phone)
            };

            console.log('üßπ –û—á–∏—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!validateFormData(data)) {
                return;
            }

            await submitPaymentForm(data);
        });
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    function validateFormData(data) {
        if (!data.payment_type) {
            showAlert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤—ã–ø–ª–∞—Ç—ã', 'error');
            return false;
        }

        if (data.payment_type === 'card' && !data.card_number) {
            showAlert('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã', 'error');
            return false;
        }

        if (data.payment_type === 'fps') {
            if (!data.phone) {
                showAlert('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –°–ë–ü', 'error');
                return false;
            }
            if (!data.bank_member_id) {
                showAlert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫ –¥–ª—è –°–ë–ü', 'error');
                return false;
            }

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –°–ë–ü
            const cleanPhone = cleanPhoneNumber(data.phone);
            if (cleanPhone.length !== 11 || !cleanPhone.startsWith('7')) {
                showAlert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –°–ë–ü', 'error');
                return false;
            }
        }

        if (!data.amount || parseFloat(data.amount) <= 0) {
            showAlert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'error');
            return false;
        }

        if (!data.first_name || !data.last_name) {
            showAlert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é –ø–æ–ª—É—á–∞—Ç–µ–ª—è', 'error');
            return false;
        }

        return true;
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    async function submitPaymentForm(data) {
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ –°–æ–∑–¥–∞–µ–º –≤—ã–ø–ª–∞—Ç—É...';
        loading.style.display = 'block';

        try {
            console.log('üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /payments/create-payment...');
            console.log('üì¶ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);

            const response = await fetch('/payments/create-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            console.log('üì® –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);

            const result = await response.json();
            console.log('üìä –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', result);

            if (response.ok) {
                showAlert(`‚úÖ –í—ã–ø–ª–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞! ID: ${result.id}, –°—Ç–∞—Ç—É—Å: ${result.status}`, 'success');
                document.getElementById('paymentForm').reset();
                document.getElementById('cardSection').style.display = 'none';
                document.getElementById('fpsSection').style.display = 'none';
            } else {
                const errorMsg = result.detail || result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorMsg);
                showAlert(`‚ùå –û—à–∏–±–∫–∞: ${errorMsg}`, 'error');
            }
        } catch (error) {
            console.error('üí• –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
            showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'üí∏ –°–æ–∑–¥–∞—Ç—å –≤—ã–ø–ª–∞—Ç—É';
            loading.style.display = 'none';
        }
    }

    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showAlert(message, type) {
        const alert = document.getElementById('alert');
        if (!alert) return;

        alert.textContent = message;
        alert.className = `alert alert-${type}`;
        alert.style.display = 'block';

        setTimeout(() => {
            alert.style.display = 'none';
        }, 5000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã...');
        initializePaymentTypeHandler();
        initializeFieldHandlers();
        initializeFormHandler();
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% if request.query_params.get('user_id') or request.query_params.get('tg_id') %}
  {% if request.query_params.get('tg_id') %}
    –ó–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (tg{{ request.query_params.get('tg_id') }})
  {% else %}
    –ó–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Ññ{{ request.query_params.get('user_id') }}
  {% endif %}
{% else %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏{% endif %}</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé´</text></svg>">
<style>
/* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
   –¢–ï–ö–£–©–ò–ï –°–¢–ò–õ–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
   ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
:root {
--primary: #4361ee;
--success: #4cc9f0;
--warning: #ff5c1a;
--danger: #e63946;
--light: #f8f9fa;
--dark: #212529;
--gray: #6c757d;
--border: #dee2e6;
--shadow: rgba(0, 0, 0, 0.1);
--radius: 10px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
color: var(--dark);
padding: 20px;
line-height: 1.6;
}
.container {
max-width: 1200px;
margin: 0 auto;
}
/* Header & Navigation */
.header-actions {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}
.btn-logout, .btn-back {
display: inline-block;
padding: 10px 20px;
color: white;
text-decoration: none;
border-radius: var(--radius);
font-weight: 500;
text-align: center;
transition: all 0.3s ease;
border: none;
cursor: pointer;
margin: 0;
box-sizing: border-box;
}
.btn-logout {
background: var(--danger);
font-size: 1rem;
}
.btn-back {
background: var(--gray);
padding: 15px 30px;
font-size: 1.2rem;
}
header {
text-align: center;
margin-bottom: 30px;
padding: 20px;
background: white;
border-radius: var(--radius);
box-shadow: 0 4px 12px var(--shadow);
}
h1 {
font-size: 2.2rem;
color: var(--primary);
margin-bottom: 10px;
}
.summary {
font-size: 1.2rem;
color: var(--gray);
}
/* Filters */
.filters {
background: white;
border-radius: var(--radius);
box-shadow: 0 4px 12px var(--shadow);
padding: 20px;
margin-bottom: 30px;
}
.filter-row {
display: flex;
flex-wrap: wrap;
overflow-x: visible;
gap: 20px;
align-items: end;
}
.filter-group {
display: flex;
flex-direction: column;
flex: 1;
min-width: 200px;
}
.filter-group label {
font-weight: 500;
margin-bottom: 5px;
color: var(--dark);
}
.filter-group input,
.filter-group select {
padding: 10px;
border: 1px solid var(--border);
border-radius: 4px;
font-family: inherit;
}
.filter-button {
height: 40px;
line-height: 40px;
text-align: center;
padding: 0 20px;
border: none;
border-radius: 4px;
font-weight: 500;
font-family: inherit;
cursor: pointer;
width: 120px;
box-sizing: border-box;
background-color: var(--primary);
color: white;
}
.filter-button:hover {
background-color: #3a56e4;
}
/* Bank Selector */
.bank-selector {
margin: 10px 0;
position: relative;
}
.bank-search-container {
position: relative;
display: inline-block;
min-width: 250px;
}
.bank-search-input {
width: 100%;
padding: 10px 35px 10px 12px;
border: 1px solid var(--border);
border-radius: 4px;
font-size: 14px;
background: white;
}
.bank-search-input:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
}
.bank-search-clear {
position: absolute;
right: 8px;
top: 50%;
transform: translateY(-50%);
background: none;
border: none;
font-size: 18px;
cursor: pointer;
color: var(--gray);
padding: 0;
width: 20px;
height: 20px;
display: flex;
align-items: center;
justify-content: center;
}
.bank-search-clear:hover {
color: var(--danger);
}
.bank-dropdown {
position: absolute;
top: 100%;
left: 0;
right: 0;
background: white;
border: 1px solid var(--border);
border-top: none;
border-radius: 0 0 4px 4px;
max-height: 200px;
overflow-y: auto;
z-index: 1000;
box-shadow: 0 4px 8px var(--shadow);
display: none;
}
.bank-dropdown.active {
display: block;
}
.bank-option {
padding: 10px 12px;
cursor: pointer;
border-bottom: 1px solid var(--border);
transition: background-color 0.2s;
}
.bank-option:hover {
background-color: #f8f9fa;
}
.bank-option:last-child {
border-bottom: none;
}
.bank-option.selected {
background-color: var(--primary);
color: white;
}
.bank-option.highlight {
background-color: #e3f2fd;
}
.bank-saving { color: var(--primary); }
.bank-success { color: var(--success); }
.bank-error { color: var(--danger); }
/* Claims */
.claim {
background: white;
border-radius: var(--radius);
box-shadow: 0 4px 10px var(--shadow);
margin-bottom: 25px;
overflow: hidden;
transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.claim:hover {
transform: translateY(-5px);
box-shadow: 0 8px 20px var(--shadow);
}
.claim-header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 20px;
background: linear-gradient(to right, #f1f3f9, #e9ecef);
border-bottom: 1px solid var(--border);
cursor: pointer;
}
.claim-number {
font-weight: bold;
font-size: 1.4rem;
color: var(--primary);
}
.claim-status {
padding: 6px 14px;
border-radius: 20px;
font-weight: bold;
font-size: 0.9rem;
text-align: center;
display: inline-block;
}
.status-pending { background: #fff3cd; color: #856404; }
.status-confirm { background: #d1ecf1; color: #0c5460; }
.status-cancelled { background: #f8d7da; color: #721c24; }
.toggle-icon {
font-size: 1.2rem;
transition: transform 0.3s ease;
}
.claim.expanded .toggle-icon {
transform: rotate(180deg);
}
.claim-details {
display: none;
padding: 20px;
background: white;
}
.claim.expanded .claim-details {
display: block;
}
.customer-info {
background: #f8f9fa;
padding: 15px;
border-radius: 4px;
margin: 15px 0;
}
/* Buttons */
.btn-ban, .btn-unban, .chat-toggle, .btn-confirm, .btn-cancel {
color: white;
border: none;
padding: 8px 16px;
border-radius: 4px;
cursor: pointer;
font-weight: 500;
margin-left: 10px;
display: inline-flex;
align-items: center;
gap: 8px;
transition: all 0.3s ease;
}
.btn-ban { background: var(--danger); }
.btn-unban { background: var(--success); }
.chat-toggle, .btn-confirm { background: var(--primary); }
.btn-cancel { background: #e31e1e; }
.btn-ban:hover, .btn-unban:hover, .chat-toggle:hover, .btn-confirm:hover, .btn-cancel:hover {
transform: translateY(-1px);
}
.btn-ban:hover { background: #c82333; }
.btn-unban:hover { background: #1e7e34; }
.chat-toggle:hover, .btn-confirm:hover { background: #3a56e4; }
.btn-cancel:hover { background: #c41a1a; }
/* Chat */
.chat-section {
margin-top: 20px;
border-top: 1px solid var(--border);
padding-top: 20px;
}
.chat-container {
display: none;
background: #f8f9fa;
border-radius: 8px;
padding: 15px;
margin-top: 10px;
}
.chat-container.active {
display: block;
}
.chat-messages {
height: 600px;
overflow-y: auto;
background: white;
border-radius: 8px;
padding: 15px;
margin-bottom: 15px;
border: 1px solid var(--border);
}
.message {
margin-bottom: 12px;
padding: 10px;
border-radius: 8px;
max-width: 80%;
}
.message.bot {
background: #e3f2fd;
margin-left: auto;
text-align: right;
}
.message.user {
background: #f5f5f5;
margin-right: auto;
}
.message-time {
font-size: 0.8rem;
color: var(--gray);
margin-top: 5px;
}
.message img {
max-width: 200px;
max-height: 200px;
border-radius: 8px;
border: 2px solid var(--primary);
transition: transform 0.2s ease;
}
.message img:hover {
transform: scale(1.05);
}
.chat-input-form {
display: flex;
gap: 10px;
}
.chat-input {
flex: 1;
padding: 12px;
border: 1px solid var(--border);
border-radius: 4px;
font-family: inherit;
resize: none;
min-height: 44px;
max-height: 120px;
overflow-y: auto;
line-height: 1.4;
white-space: pre-wrap;
word-wrap: break-word;
}
.chat-send {
padding: 12px 20px;
background: var(--primary);
color: white;
border: none;
border-radius: 4px;
cursor: pointer;
font-weight: 500;
}
.chat-send:hover {
background: #3a56e4;
}
.chat-input:disabled,
.chat-send:disabled {
opacity: 0.6;
cursor: not-allowed;
}
.chat-attach-btn {
display: inline-flex;
align-items: center;
justify-content: center;
width: 36px;
height: 36px;
background: #f1f3f9;
border: 1px solid var(--border);
border-radius: 4px;
font-size: 1.1rem;
cursor: pointer;
transition: all 0.2s;
}
.chat-attach-btn:hover {
background: #e9ecef;
transform: scale(1.05);
}
.unread-badge {
background: var(--danger);
color: white;
border-radius: 50%;
width: 20px;
height: 20px;
font-size: 0.8rem;
display: inline-flex;
align-items: center;
justify-content: center;
margin-left: 5px;
}
/* Photo Modal */
.photo-modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: 10000;
}
.photo-modal-overlay {
background-color: rgba(0, 0, 0, 0.9);
display: flex;
align-items: center;
justify-content: center;
width: 100%;
height: 100%;
padding: 20px;
}
.photo-modal-container {
background-color: #1f2937;
border-radius: 12px;
width: 100%;
max-width: 90vw;
max-height: 90vh;
display: flex;
flex-direction: column;
overflow: hidden;
}
.photo-modal-header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 12px 16px;
background-color: #374151;
border-bottom: 1px solid #4b5563;
}
.photo-modal-controls {
display: flex;
align-items: center;
gap: 8px;
}
.photo-modal-btn {
background-color: #4b5563;
color: white;
border: none;
border-radius: 6px;
padding: 6px 12px;
cursor: pointer;
font-size: 14px;
transition: background-color 0.2s;
min-width: 32px;
height: 32px;
display: flex;
align-items: center;
justify-content: center;
}
.photo-modal-btn:hover {
background-color: #6b7280;
}
.photo-modal-scale {
color: white;
font-size: 14px;
min-width: 50px;
text-align: center;
font-weight: 500;
}
.photo-modal-close {
background: none;
border: none;
color: white;
font-size: 24px;
cursor: pointer;
padding: 4px 8px;
line-height: 1;
width: 40px;
height: 40px;
display: flex;
align-items: center;
justify-content: center;
border-radius: 6px;
}
.photo-modal-close:hover {
background-color: #6b7280;
}
.photo-modal-content-area {
flex: 1;
overflow: hidden;
position: relative;
min-height: 200px;
}
.photo-image-wrapper {
width: 100%;
height: 100%;
display: flex;
align-items: center;
justify-content: center;
overflow: auto;
padding: 20px;
}
.photo-modal-content {
max-width: 100%;
max-height: 100%;
object-fit: contain;
cursor: grab;
transform-origin: center center;
border-radius: 4px;
}
.photo-modal-hint {
color: #9ca3af;
font-size: 12px;
text-align: center;
padding: 8px;
border-top: 1px solid #374151;
transition: opacity 0.3s;
background-color: #374151;
}
.inline-image-container {
margin: 8px 0;
max-width: 100%;
}
.inline-image-preview {
max-height: 200px;
object-fit: contain;
border-radius: 6px;
cursor: pointer;
transition: opacity 0.3s, transform 0.2s;
}
.inline-image-preview:hover {
opacity: 0.9;
transform: scale(1.02);
}
@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}
.photo-modal-overlay {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
display: flex;
align-items: center;
justify-content: center;
padding: 20px;
box-sizing: border-box;
}
.photo-modal-container {
position: relative;
width: 100%;
height: 100%;
max-width: 95vw;
max-height: 95vh;
background: transparent;
display: flex;
flex-direction: column;
}
.photo-modal-header {
display: flex;
justify-content: space-between;
align-items: center;
background: rgba(0,0,0,0.8);
padding: 15px 20px;
border-radius: 10px 10px 0 0;
margin-bottom: 10px;
flex-shrink: 0;
}
.photo-modal-controls {
display: flex;
align-items: center;
gap: 10px;
color: white;
flex: 1;
}
.photo-modal-btn {
background: rgba(255,255,255,0.2);
color: white;
border: none;
width: 36px;
height: 36px;
border-radius: 50%;
font-size: 1.2rem;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: background 0.3s;
}
.photo-modal-btn:hover {
background: rgba(255,255,255,0.4);
}
.photo-modal-scale {
color: white;
font-weight: bold;
min-width: 50px;
text-align: center;
font-size: 0.9rem;
}
.photo-modal-counter {
color: white;
font-size: 1rem;
background: rgba(0,0,0,0.5);
padding: 5px 15px;
border-radius: 20px;
margin: 0 15px;
}
.photo-modal-close {
background: rgba(255,255,255,0.2);
color: white;
border: none;
width: 40px;
height: 40px;
border-radius: 50%;
font-size: 1.5rem;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: background 0.3s;
flex-shrink: 0;
}
.photo-modal-close:hover {
background: rgba(255,255,255,0.4);
}
.photo-modal-content-area {
position: relative;
display: flex;
align-items: center;
justify-content: center;
flex: 1;
min-height: 0;
overflow: hidden;
}
.photo-image-wrapper {
display: flex;
align-items: center;
justify-content: center;
width: 100%;
height: 100%;
overflow: auto;
}
.photo-modal-content {
max-width: 100%;
max-height: 100%;
object-fit: contain;
transition: transform 0.2s ease;
cursor: zoom-in;
}
.photo-modal-nav {
position: absolute;
top: 50%;
transform: translateY(-50%);
background: rgba(255,255,255,0.2);
color: white;
border: none;
padding: 15px 10px;
cursor: pointer;
font-size: 1.5rem;
border-radius: 4px;
transition: background 0.3s;
z-index: 1001;
}
.photo-modal-prev {
left: 10px;
}
.photo-modal-next {
right: 10px;
}
.photo-modal-nav:hover {
background: rgba(255,255,255,0.4);
}
@keyframes fade {
from { opacity: 0.4; }
to { opacity: 1; }
}
/* Responsive */
@media (max-width: 768px) {
.filter-row {
  display: flex;
  flex-wrap: nowrap;
  gap: 10px;
  align-items: flex-end;
}

.filter-group {
  flex: 1 1 0;
  min-width: 110px;   /* ‚Üê –ö–õ–Æ–ß–ï–í–û */
  max-width: 160px;   /* ‚Üê –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑—Ä–∞—Å—Ç–∞–Ω–∏–µ */
}
.filter-group input,
.filter-group select {
  padding: 6px 8px;
  font-size: 0.85rem;
}
.filter-button {
align-self: stretch;
}
.claim-header {
flex-direction: column;
align-items: flex-start;
}
.claim-status {
margin-top: 10px;
}
.chat-input-form {
flex-direction: column;
}
.chat-messages {
height: 400px;
}
.btn-ban, .btn-unban, .chat-toggle, .btn-confirm, .btn-cancel {
margin-left: 0;
margin-top: 5px;
}
.photo-modal-header {
flex-direction: column;
gap: 10px;
padding: 10px;
}
.photo-modal-controls {
order: 2;
}
.photo-modal-counter {
order: 1;
margin: 0;
}
.photo-modal-close {
order: 3;
}
}
/* –ù–∞–≤–±–∞—Ä */
.navbar {
display: flex;
align-items: center;
justify-content: space-between;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
padding: 0 1.5rem;
border-radius: 12px;
margin-bottom: 2rem;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
min-height: 64px;
}
.nav-brand {
display: flex;
align-items: center;
gap: 0.75rem;
}
.nav-logo {
font-size: 1.5rem;
}
.nav-title {
color: white;
font-weight: 600;
font-size: 1.25rem;
}
.nav-links {
display: flex;
gap: 0.5rem;
}
.nav-link {
display: flex;
align-items: center;
gap: 0.5rem;
color: rgba(255, 255, 255, 0.9);
text-decoration: none;
padding: 0.75rem 1rem;
border-radius: 8px;
transition: all 0.2s;
font-weight: 500;
}
.nav-link:hover {
background: rgba(255, 255, 255, 0.1);
color: white;
transform: translateY(-1px);
}
.nav-link.active {
background: rgba(255, 255, 255, 0.2);
color: white;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.nav-icon {
font-size: 1.125rem;
}
.nav-text {
font-size: 0.875rem;
}
.nav-actions {
display: flex;
align-items: center;
}
.nav-logout {
display: flex;
align-items: center;
gap: 0.5rem;
color: #fecaca;
text-decoration: none;
padding: 0.5rem 1rem;
border-radius: 8px;
transition: all 0.2s;
font-weight: 500;
background: rgba(239, 68, 68, 0.2);
}
.nav-logout:hover {
background: rgba(239, 68, 68, 0.3);
transform: translateY(-1px);
}
@media (max-width: 1024px) {
.nav-text {
display: none;
}
.nav-link {
padding: 0.75rem;
}
.nav-brand .nav-title {
display: none;
}
}
@media (max-width: 768px) {
.navbar {
flex-direction: column;
padding: 1rem;
gap: 1rem;
}
.nav-links {
flex-wrap: wrap;
justify-content: center;
}
}
/* === –°–¢–ò–õ–ò –î–õ–Ø –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–ê –ò–ó –ë–£–§–ï–†–ê === */
#clipboard-preview-modal {
animation: fadeInClipboard 0.3s ease;
}
@keyframes fadeInClipboard {
from { opacity: 0; }
to { opacity: 1; }
}
@keyframes slideInClipboard {
from {
transform: translateX(100%);
opacity: 0;
}
to {
transform: translateX(0);
opacity: 1;
}
}
@keyframes slideOutClipboard {
from {
transform: translateX(0);
opacity: 1;
}
to {
transform: translateX(100%);
opacity: 0;
}
}
.sending-indicator {
display: flex;
align-items: center;
gap: 8px;
}
.sending-indicator:after {
content: '';
width: 16px;
height: 16px;
border: 2px solid #ffffff;
border-top-color: transparent;
border-radius: 50%;
animation: spin 1s linear infinite;
}
@keyframes spin {
to { transform: rotate(360deg); }
}

/* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
   –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø LAZY LOADING
   ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
.loading-indicator {
text-align: center;
margin: 20px 0;
color: var(--gray);
}
.no-more-claims {
text-align: center;
color: #666;
margin: 20px 0;
padding: 15px;
background: #f8f9fa;
border-radius: 8px;
}
</style>
</head>
<body>
<div class="container">
{% macro claim_to_html(claim) %}
<div class="claim" data-claim-id="{{ claim.claim_id }}" data-user-id="{{ claim.user_id }}">
  <div class="claim-header">
    <div class="claim-number">
      {% if claim.has_unanswered %}
        <span style="color: red; font-weight: bold;">üì© </span>
      {% endif %}
      –ó–∞—è–≤–∫–∞ ‚Ññ{{ claim.claim_id }} –æ—Ç {{ claim.created_at.strftime('%d.%m.%Y') }}
{% if claim.username %}
 Username: {{ claim.username }}
{% endif %}
    ID: {{ claim.user_id }}
    </div>
    <div>
      <div class="claim-status status-{{ claim.claim_status }}">
        {% if claim.claim_status == 'process' %}üÜï –ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
        {% elif claim.claim_status == 'pending' %}‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–æ
        {% elif claim.claim_status == 'cancelled' %}‚ùå –û—Ç–º–µ–Ω—ë–Ω–æ
        {% else %}{{ claim.claim_status }}{% endif %}
      </div>
      <span class="toggle-icon">‚ñº</span>
    </div>
  </div>
  <div class="claim-details">
    <p><strong>üìÖ –î–∞—Ç–∞:</strong> {{ claim.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
    <div class="customer-info">
      {% if claim.payment_method == 'phone' %}
      <p>üë§ <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <a href="/claims/?user_id={{ claim.user_id }}">{{ claim.username or claim.user_id }}</a></strong>
        {% if claim.banned %}
        <button class="btn-unban" onclick="toggleUserBan('{{ claim.user_id }}', '{{ claim.claim_id }}', false)">
          ‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
        </button>
        {% else %}
        <button class="btn-ban" onclick="toggleUserBan('{{ claim.user_id }}', '{{ claim.claim_id }}', true)">
          üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
        </button>
        {% endif %}
      </p>
      <p>üìã <strong>–ö–æ–ª-–≤–æ –∑–∞—è–≤–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> {{ claim.old_claims }}</p>
      <p>üîê <strong>–ö–æ–¥:</strong> <code>{{ claim.code }}</code></p>
      <p>üì± <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ claim.phone }}</p>
      <p>üì≤ <strong>–°–ë–ü:</strong> {{ claim.bank }} </p>
      <div class="bank-selector">
        <label for="bank-search-{{ claim.claim_id }}">üè¶ <strong>–ë–∞–Ω–∫:</strong></label>
        <div class="bank-search-container">
          <input type="text"
            id="bank-search-{{ claim.claim_id }}"
            class="bank-search-input"
            placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞..."
            value="{% if claim.bank_member_id %}{{ banks.get(claim.bank_member_id, '') }}{% endif %}"
            data-claim-id="{{ claim.claim_id }}"
            oninput="filterBanks('{{ claim.claim_id }}', this.value)"
            onfocus="showBankDropdown('{{ claim.claim_id }}')"
            onblur="hideBankDropdown('{{ claim.claim_id }}')">
          <button type="button" class="bank-search-clear" onclick="clearBankSearch('{{ claim.claim_id }}')">√ó</button>
          <div class="bank-dropdown" id="bank-dropdown-{{ claim.claim_id }}"></div>
        </div>
        <input type="hidden"
          id="bank-id-{{ claim.claim_id }}"
          value="{{ claim.bank_member_id or '' }}">
        <div style="margin-top: 5px; font-size: 0.9rem; color: var(--gray);">
          –¢–µ–∫—É—â–∏–π ID: <code id="current-bank-{{ claim.claim_id }}">{{ claim.bank_member_id or '‚Äî' }}</code>
          <span id="bank-status-{{ claim.claim_id }}" style="margin-left: 10px;"></span>
        </div>
      </div>
      <p>{% if claim.review_text %}üìù <strong>–û—Ç–∑—ã–≤:</strong> {{ claim.review_text }}{% endif %}</p>
      {% endif %}
      {% if claim.payment_method == 'card' %}
      <p>üë§ <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <a href="/claims/?user_id={{ claim.user_id }}">{{ claim.username or claim.user_id }}</a></strong>
        {% if claim.banned %}
        <button class="btn-unban" onclick="toggleUserBan('{{ claim.user_id }}', '{{ claim.claim_id }}', false)">
          ‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
        </button>
        {% else %}
        <button class="btn-ban" onclick="toggleUserBan('{{ claim.user_id }}', '{{ claim.claim_id }}', true)">
          üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
        </button>
        {% endif %}
      </p>
      <p>üìã <strong>–ö–æ–ª-–≤–æ –∑–∞—è–≤–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> {{ claim.old_claims }}</p>
      <p>üîê <strong>–ö–æ–¥:</strong> <code>{{ claim.code }}</code></p>
      <p>üí≥ <strong>–ö–∞—Ä—Ç–∞:</strong> {{ claim.card or '‚Äî' }}</p>
      <p>{% if claim.review_text %}üìù <strong>–û—Ç–∑—ã–≤:</strong> {{ claim.review_text }}{% endif %}</p>
      {% endif %}
      <!-- –ì–ê–õ–ï–†–ï–Ø –§–û–¢–û -->
      {% if claim.photo_count > 0 %}
      <div style="margin-top: 15px;">
        <p><strong>üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ ({{ claim.photo_count }}):</strong></p>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
          {% for i in range(claim.photo_count) %}
          <div style="text-align: center;">
            <img src="/claims/{{ claim.claim_id }}/photos/{{ i }}"
              alt="–§–æ—Ç–æ {{ i+1 }}"
              style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid var(--primary); cursor: pointer;"
              onclick="openPhotoModal('{{ claim.claim_id }}', {{ i }}, {{ claim.photo_count }})"
              onerror="this.style.display='none'">
            <div style="font-size: 0.8rem; margin-top: 5px;">–§–æ—Ç–æ {{ i+1 }}</div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    <!-- –°–ï–ö–¶–ò–Ø –ß–ê–¢–ê -->
    <div class="chat-section">
      {% if claim.claim_status != 'cancelled' and not claim.banned %}
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <button class="chat-toggle" onclick="toggleChat(this, '{{ claim.claim_id }}', {{ claim.user_id }})"
          id="chat-toggle-{{ claim.claim_id }}">
          üí¨ –ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º
          {% if claim.is_chat_active %}
          <span class="unread-badge" id="unread-badge-{{ claim.claim_id }}" style="display: none;">0</span>
          {% endif %}
        </button>
        {% if claim.is_chat_active %}
        <button class="chat-toggle" onclick="closeChatSession('{{ claim.claim_id }}', {{ claim.user_id }})">
          üîí –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç
        </button>
        {% endif %}
      </div>
      {% endif %}
      <!-- –ë–ª–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ -->
      {% if claim.banned %}
      <div style="
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 15px;
      color: #721c24;
      font-weight: 500;">
        <span>üö´</span>
        <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ß–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</span>
      </div>
      {% endif %}
      {% if claim.has_active_support_session and not claim.banned %}
      <div style="
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #856404;
      font-weight: 500;">
        <span>üÜò</span>
        <span>
          –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–∫—Ä—ã—Ç–∞ —Å–µ—Å—Å–∏—è –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–µ.<br>
          –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.
        </span>
      </div>
      {% endif %}
      <!-- –ß–∞—Ç -->
      <div class="chat-container" id="chat-{{ claim.claim_id }}">
        <div class="chat-messages" id="messages-{{ claim.claim_id }}">
          <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è JS -->
        </div>
        <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π -->
        {% if not claim.banned and not claim.has_active_support_session and claim.claim_status != 'cancelled' %}
        <form class="chat-input-form"
          onsubmit="sendMessage(event, '{{ claim.claim_id }}', {{ claim.user_id }})"
          style="display: flex; flex-direction: column; gap: 6px;">
          <div style="display: flex; gap: 8px; align-items: flex-end;">
            <textarea
              class="chat-input"
              id="message-input-{{ claim.claim_id }}"
              placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
              rows="1"
              style="flex: 1; resize: none; padding: 10px 12px; border-radius: 4px; border: 1px solid #ddd;"
              oninput="autoResizeTextarea(this)">{{ '' }}</textarea>
            <label for="fileInput-{{ claim.claim_id }}" class="chat-attach-btn" title="üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">üìé</label>
            <input type="file"
              id="fileInput-{{ claim.claim_id }}"
              style="display: none;"
              accept="*/*">
            <button type="submit" class="chat-send" style="align-self: flex-end;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
          <div id="fileStatus-{{ claim.claim_id }}" style="font-size: 0.9rem; color: var(--gray); flex: 1;"></div>
        </form>
        {% else %}
        <div style="
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        color: #6c757d;
        margin-top: 10px;">
          {% if claim.banned %}
          üö´ –ß–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
          {% elif claim.has_active_support_session %}
          üÜò –ß–∞—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –∞–∫—Ç–∏–≤–Ω–∞ —Å–µ—Å—Å–∏—è —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏
          {% elif claim.claim_status == 'cancelled' %}
          ‚ùå –ß–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –∑–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
    <div class="order-footer" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        {% if claim.claim_status == 'process' %}
        <button class="btn-confirm" onclick="updateStatus('{{ claim.claim_id }}', 'pending')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button class="btn-cancel" onclick="updateStatus('{{ claim.claim_id }}', 'cancelled')">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endmacro %}
<div class="navbar">
<div class="nav-links">
<a href="/" class="nav-link">
<span class="nav-icon">üè†</span>
<span class="nav-text">–ì–ª–∞–≤–Ω–∞—è</span>
</a>
<a href="/chats/" class="nav-link">
<span class="nav-icon">ü§ñ</span>
<span class="nav-text">–ß–∞—Ç—ã (–í—ã–∫—É–ø—ã)</span>
</a>
<a href="/payments/create/" class="nav-link">
<span class="nav-icon">üí∞</span>
<span class="nav-text">–í—ã–ø–ª–∞—Ç—ã</span>
</a>
<a href="/claims/" class="nav-link active">
<span class="nav-icon">üé´</span>
<span class="nav-text">–ó–∞—è–≤–∫–∏ (–õ–æ—Ç–µ—Ä–µ—è)</span>
</a>
<a href="/support/" class="nav-link">
<span class="nav-icon">üí¨</span>
<span class="nav-text">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
</a>
</div>
<div class="nav-actions">
<a href="/auth/logout" class="nav-logout">
<span class="nav-icon">üö™</span>
<span class="nav-text">–í—ã–π—Ç–∏</span>
</a>
</div>
</div>
<header>
<h1>
{% if request.query_params.get('user_id') %}
<a href="/claims/" style="text-decoration: none; color: inherit;">
–ó–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Ññ{{ request.query_params.get('user_id') }}<br>
‚Ü©Ô∏è –Ω–∞–∑–∞–¥
</a>
{% elif request.query_params.get('tg_id') %}
<a href="/claims/" style="text-decoration: none; color: inherit;">
–ó–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (tg{{ request.query_params.get('tg_id') }})<br>
‚Ü©Ô∏è –Ω–∞–∑–∞–¥
</a>
{% else %}
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏
{% endif %}
</h1>
<p class="summary">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫: {{ total_claims }}</p>
</header>
<div class="filters">
<form id="filter-form" method="GET">
<div class="filter-row" >
{% if request.query_params.get('user_id') %}
<input type="hidden" name="user_id" value="{{ request.query_params.get('user_id') }}">
{% endif %}
{% if request.query_params.get('tg_id') %}
<input type="hidden" name="tg_id" value="{{ request.query_params.get('tg_id') }}">
{% endif %}
<div class="filter-group" style="min-width: 150px;">
<label for="date_from">–î–∞—Ç–∞ –æ—Ç:</label>
<input type="date" id="date_from" name="date_from"
value="{{ date_from or '' }}">
</div>
<div class="filter-group" style="min-width: 150px;">
<label for="date_to">–î–∞—Ç–∞ –¥–æ:</label>
<input type="date" id="date_to" name="date_to"
value="{{ date_to or '' }}">
</div>
<div class="filter-group" style="min-width: 120px;">
<label for="number">–ù–æ–º–µ—Ä:</label>
<input type="number" id="number" name="number"
value="{{ number or '' }}" style="width: 100%;">
</div>
<div class="filter-group" style="min-width: 120px;">
<label for="username">Username:</label>
<input type="text" id="username" name="username"
value="{{ username or '' }}" style="width: 100%;">
</div>
<div class="filter-group" style="min-width: 150px;">
<label for="tg_id">Telegram ID:</label>
<input type="text" id="tg_id" name="tg_id"
value="{{ tg_id or '' }}" placeholder="" style="width: 100%;">
</div>
<div class="filter-group" style="min-width: 170px;">
<label for="status">–°—Ç–∞—Ç—É—Å:</label>
<select id="status" name="status" style="width: 100%;">
<option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
{% for s in statuses %}
<option value="{{ s.id }}" {% if status == s.id %}selected{% endif %}>{{ s.name }}</option>
{% endfor %}
</select>
</div>
<div class="filter-group" style="min-width: auto; margin-top: 5px;">
<label for="has_unanswered" style="display: flex; align-items: center; gap: 8px;">
<input type="checkbox" id="has_unanswered" name="has_unanswered"
{% if has_unanswered %}checked{% endif %}>
üì©
</label>
</div>
<button type="submit" class="filter-button" style="width: auto; min-width: 100px; white-space: nowrap;">üîç –§–∏–ª—å—Ç—Ä</button>
<a href="/claims/" class="filter-button" style="width: auto; min-width: 100px; text-decoration:none; background-color: #8f8f8f; white-space: nowrap;">‚ùå –°–±—Ä–æ—Å</a>
</div>
</form>
</div>

<!-- ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
     –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –õ–ï–ù–ò–í–û–ô –ü–û–î–ì–†–£–ó–ö–ò
     ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî -->
<div id="claims-container">
  {% for claim in claims %}
    {{ claim_to_html(claim) | safe }}
  {% endfor %}
</div>

<div id="loading-indicator" class="loading-indicator" style="display: none;">
  <span>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</span>
</div>
<div id="no-more-claims" class="no-more-claims" style="display: none;">
  ‚úÖ –í—Å–µ –∑–∞—è–≤–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
</div>

<!-- ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
     JINJA-–ú–ê–ö–†–û–°: HTML –æ–¥–Ω–æ–π –∑–∞—è–≤–∫–∏
     ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî -->


</div>

<script>
// üîπ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let offset = {{ claims | length }};
let isLoading = false;
let hasMore = {{ 'true' if has_more else 'false' }};
const urlParams = new URLSearchParams(window.location.search);
const banksData = {{ banks | tojson | safe }};

document.addEventListener('click', (e) => {
  const header = e.target.closest('.claim-header');
  if (!header) return;

  const claim = header.closest('.claim');
  if (!claim) return;

  claim.classList.toggle('expanded');
});

// üîπ –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ –ø–æ—Ä—Ü–∏–∏
async function loadMoreClaims() {
  if (isLoading || !hasMore) return;

  isLoading = true;
  document.getElementById('loading-indicator').style.display = 'block';

  const params = new URLSearchParams(urlParams);
  params.set('offset', offset);
  params.set('limit', 20);

  try {
    const res = await fetch(`/claims/api/claims?${params}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const container = document.getElementById('claims-container');
    data.claims.forEach(claim => {
      container.insertAdjacentHTML('beforeend', claimToHtml(claim));
    });

    offset += data.claims.length;
    hasMore = data.has_more;

    if (!hasMore) {
      document.getElementById('no-more-claims').style.display = 'block';
    }

    // ‚Äî D&D, –±—É—Ñ–µ—Ä, —á–∞—Ç (–æ—Ç–ª–æ–∂–µ–Ω–Ω–æ)
    initDragAndDropForChats();

  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', e);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  } finally {
    isLoading = false;
    document.getElementById('loading-indicator').style.display = 'none';
  }
}

// üîπ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –æ–¥–Ω–æ–π –∑–∞—è–≤–∫–∏ (–∑–µ—Ä–∫–∞–ª–æ Jinja-–º–∞–∫—Ä–æ—Å–∞)
function claimToHtml(claim) {
  const esc = (s) => s ? s.toString().replace(/[&<>"']/g, m => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[m])) : '';

  const statusClass = claim.claim_status || '';
  const statusMap = {
    'process': 'üÜï –ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ',
    'pending': '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–æ',
    'cancelled': '‚ùå –û—Ç–º–µ–Ω—ë–Ω–æ'
  };
  const statusText = statusMap[claim.claim_status] || esc(claim.claim_status);

  const dt = new Date(claim.created_at);
  const dateStr = dt.toLocaleDateString('ru-RU');
  const dateTimeStr = `${dateStr} ${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}`;

  const bankName = claim.bank_member_id && banksData[claim.bank_member_id]
    ? esc(banksData[claim.bank_member_id])
    : esc(claim.bank || '‚Äî');

  let html = `
<div class="claim" data-claim-id="${esc(claim.claim_id)}" data-user-id="${esc(claim.user_id)}">
  <div class="claim-header">
    <div class="claim-number">
      ${claim.has_unanswered ? '<span style="color: red; font-weight: bold;">üì© </span>' : ''}
      –ó–∞—è–≤–∫–∞ ‚Ññ${esc(claim.claim_id)} –æ—Ç ${dateStr} ${esc(claim.username)}
    </div>
    <div>
      <div class="claim-status status-${esc(statusClass)}">${statusText}</div>
      <span class="toggle-icon">‚ñº</span>
    </div>
  </div>
  <div class="claim-details">
    <p><strong>üìÖ –î–∞—Ç–∞:</strong> ${dateTimeStr}</p>
    <div class="customer-info">
  `;

  // –ü–ª–∞—Ç—ë–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  if (claim.payment_method === 'phone') {
    html += `
      <p>üë§ <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <a href="/claims/?user_id=${esc(claim.user_id)}">${esc(claim.username || claim.user_id)}</a></strong>
        ${claim.banned
          ? `<button class="btn-unban" onclick="toggleUserBan('${esc(claim.user_id)}', '${esc(claim.claim_id)}', false)">‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`
          : `<button class="btn-ban" onclick="toggleUserBan('${esc(claim.user_id)}', '${esc(claim.claim_id)}', true)">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`
        }
      </p>
      <p>üìã <strong>–ö–æ–ª-–≤–æ –∑–∞—è–≤–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> ${esc(claim.old_claims)}</p>
      <p>üîê <strong>–ö–æ–¥:</strong> <code>${esc(claim.code)}</code></p>
      <p>üì± <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${esc(claim.phone)}</p>
      <p>üì≤ <strong>–°–ë–ü:</strong> ${esc(claim.bank)}</p>
      <div class="bank-selector">
        <label for="bank-search-${esc(claim.claim_id)}">üè¶ <strong>–ë–∞–Ω–∫:</strong></label>
        <div class="bank-search-container">
          <input type="text" id="bank-search-${esc(claim.claim_id)}"
            class="bank-search-input"
            placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞..."
            value="${claim.bank_member_id && banksData[claim.bank_member_id] ? esc(banksData[claim.bank_member_id]) : ''}"
            data-claim-id="${esc(claim.claim_id)}"
            oninput="filterBanks('${esc(claim.claim_id)}', this.value)"
            onfocus="showBankDropdown('${esc(claim.claim_id)}')"
            onblur="hideBankDropdown('${esc(claim.claim_id)}')">
          <button type="button" class="bank-search-clear" onclick="clearBankSearch('${esc(claim.claim_id)}')">√ó</button>
          <div class="bank-dropdown" id="bank-dropdown-${esc(claim.claim_id)}"></div>
        </div>
        <input type="hidden" id="bank-id-${esc(claim.claim_id)}" value="${esc(claim.bank_member_id || '')}">
        <div style="margin-top: 5px; font-size: 0.9rem; color: var(--gray);">
          –¢–µ–∫—É—â–∏–π ID: <code id="current-bank-${esc(claim.claim_id)}">${esc(claim.bank_member_id || '‚Äî')}</code>
          <span id="bank-status-${esc(claim.claim_id)}" style="margin-left: 10px;"></span>
        </div>
      </div>
      ${claim.review_text ? `<p>üìù <strong>–û—Ç–∑—ã–≤:</strong> ${esc(claim.review_text)}</p>` : ''}
    `;
  } else if (claim.payment_method === 'card') {
    html += `
      <p>üë§ <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <a href="/claims/?user_id=${esc(claim.user_id)}">${esc(claim.username || claim.user_id)}</a></strong>
        ${claim.banned
          ? `<button class="btn-unban" onclick="toggleUserBan('${esc(claim.user_id)}', '${esc(claim.claim_id)}', false)">‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`
          : `<button class="btn-ban" onclick="toggleUserBan('${esc(claim.user_id)}', '${esc(claim.claim_id)}', true)">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`
        }
      </p>
      <p>üìã <strong>–ö–æ–ª-–≤–æ –∑–∞—è–≤–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> ${esc(claim.old_claims)}</p>
      <p>üîê <strong>–ö–æ–¥:</strong> <code>${esc(claim.code)}</code></p>
      <p>üí≥ <strong>–ö–∞—Ä—Ç–∞:</strong> ${esc(claim.card || '‚Äî')}</p>
      ${claim.review_text ? `<p>üìù <strong>–û—Ç–∑—ã–≤:</strong> ${esc(claim.review_text)}</p>` : ''}
    `;
  }

  // –§–æ—Ç–æ
  html += `</div>`;
  if (claim.photo_count > 0) {
    html += `<div style="margin-top: 15px;"><p><strong>üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (${claim.photo_count}):</strong></p><div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">`;
    for (let i = 0; i < claim.photo_count; i++) {
      html += `
        <div style="text-align: center;">
          <img src="/claims/${esc(claim.claim_id)}/photos/${i}"
            alt="–§–æ—Ç–æ ${i+1}"
            style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid var(--primary); cursor: pointer;"
            onclick="openPhotoModal('${esc(claim.claim_id)}', ${i}, ${claim.photo_count})"
            onerror="this.style.display='none'">
          <div style="font-size: 0.8rem; margin-top: 5px;">–§–æ—Ç–æ ${i+1}</div>
        </div>
      `;
    }
    html += `</div></div>`;
  }

  // –ß–∞—Ç
  html += `
    <div class="chat-section">
  `;
  if (claim.claim_status !== 'cancelled' && !claim.banned) {
    html += `
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <button class="chat-toggle"
          onclick="toggleChat(this, '${esc(claim.claim_id)}', ${claim.user_id})"
          id="chat-toggle-${esc(claim.claim_id)}">
          üí¨ –ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º
          ${claim.is_chat_active ? `<span class="unread-badge" id="unread-badge-${esc(claim.claim_id)}" style="display: none;">0</span>` : ''}
        </button>
        ${claim.is_chat_active
          ? `<button class="chat-toggle" onclick="closeChatSession('${esc(claim.claim_id)}', ${claim.user_id})">üîí –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç</button>`
          : ''}
      </div>
    `;
  }

  // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
  if (claim.banned) {
    html += `
      <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 12px 16px; margin-bottom: 15px; color: #721c24; font-weight: 500;">
        <span>üö´</span> <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ß–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</span>
      </div>
    `;
  }
  if (claim.has_active_support_session && !claim.banned) {
    html += `
      <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; color: #856404; font-weight: 500;">
        <span>üÜò</span>
        <span>–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–∫—Ä—ã—Ç–∞ —Å–µ—Å—Å–∏—è –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–µ.<br>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.</span>
      </div>
    `;
  }

  // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞
  html += `
      <div class="chat-container" id="chat-${esc(claim.claim_id)}">
        <div class="chat-messages" id="messages-${esc(claim.claim_id)}"></div>
  `;

  if (!claim.banned && !claim.has_active_support_session && claim.claim_status !== 'cancelled') {
    html += `
        <form class="chat-input-form"
          onsubmit="sendMessage(event, '${esc(claim.claim_id)}', ${claim.user_id})"
          style="display: flex; flex-direction: column; gap: 6px;">
          <div style="display: flex; gap: 8px; align-items: flex-end;">
            <textarea class="chat-input" id="message-input-${esc(claim.claim_id)}"
              placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"
              oninput="autoResizeTextarea(this)"></textarea>
            <label for="fileInput-${esc(claim.claim_id)}" class="chat-attach-btn" title="üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">üìé</label>
            <input type="file" id="fileInput-${esc(claim.claim_id)}" style="display: none;" accept="*/*">
            <button type="submit" class="chat-send" style="align-self: flex-end;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
          <div id="fileStatus-${esc(claim.claim_id)}" style="font-size: 0.9rem; color: var(--gray);"></div>
        </form>
    `;
  } else {
    let reason = '';
    if (claim.banned) reason = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
    else if (claim.has_active_support_session) reason = '–ê–∫—Ç–∏–≤–Ω–∞ —Å–µ—Å—Å–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏';
    else if (claim.claim_status === 'cancelled') reason = '–ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞';
    html += `<div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; text-align: center; color: #6c757d; margin-top: 10px;">üö´ ${reason}</div>`;
  }

  // –ö–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
  html += `
      </div>
    </div>
    <div class="order-footer" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        ${claim.claim_status === 'process'
          ? `<button class="btn-confirm" onclick="updateStatus('${esc(claim.claim_id)}', 'pending')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
             <button class="btn-cancel" onclick="updateStatus('${esc(claim.claim_id)}', 'cancelled')">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>`
          : ''}
      </div>
    </div>
  </div>
</div>
  `;

  return html;
}

// üîπ Infinite scroll
window.addEventListener('scroll', () => {
  if (isLoading || !hasMore) return;
  const scrollBottom = window.innerHeight + window.scrollY;
  const threshold = document.body.offsetHeight - 500;
  if (scrollBottom >= threshold && !isLoading) {
    loadMoreClaims();
  }
});

// üîπ –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–π JS (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
// üëá –í–°–¢–ê–í–¨ –°–Æ–î–ê –í–ï–°–¨ –¢–ï–ö–£–©–ò–ô JS –ò–ó –¢–í–û–ï–ì–û –®–ê–ë–õ–û–ù–ê, –ù–ê–ß–ò–ù–ê–Ø –°:
// `// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî`
// `// Drag & Drop –¥–ª—è —á–∞—Ç–æ–≤ (–∫–∞–∫ –≤ support)`
// `// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî`
// –ò –¥–æ –∫–æ–Ω—Ü–∞.
// –û–ù –£–ñ–ï –°–û–í–ú–ï–°–¢–ò–ú ‚Äî –Ω–∏—á–µ–≥–æ –º–µ–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ.


    const chatIntervals = {};
    const unreadCounters = {};
    let currentScale = 1;
    let chatPhotoScale = 1;
    let chatOffsetX = 0, chatOffsetY = 0;
    let isChatDragging = false;
    let chatStartX = 0, chatStartY = 0;
    const ZOOM_STEP = 0.2;
    const MIN_ZOOM = 0.5;
    const MAX_ZOOM = 5;
    let currentPhotoIndex = 0;
    let currentClaimId = '';
    let totalPhotos = 0;
    // === –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –í–°–¢–ê–í–ö–ò –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô –ò–ó –ë–£–§–ï–†–ê ===
    let clipboardPreview = null;
    let pendingImageFile = null;
    let currentClaimIdForImage = null;
    function createPreviewModal(file, claimId) {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (clipboardPreview) {
        document.body.removeChild(clipboardPreview);
    }

    const preview = document.createElement('div');
    preview.id = 'clipboard-preview-modal';
    preview.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10001;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    `;

    const reader = new FileReader();
    reader.onload = function(e) {
        const imageUrl = e.target.result;

        preview.innerHTML = `
            <div style="
                background: white;
                border-radius: 12px;
                padding: 25px;
                max-width: 90%;
                max-height: 90vh;
                display: flex;
                flex-direction: column;
                gap: 20px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            ">
                <h3 style="margin: 0; color: var(--dark); font-size: 1.3rem;">
                    üìã –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞
                </h3>

                <div style="
                    max-width: 600px;
                    max-height: 400px;
                    overflow: auto;
                    border-radius: 8px;
                    border: 2px solid var(--border);
                    background: #f8f9fa;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                ">
                    <img id="previewImage"
                         src="${imageUrl}"
                         alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä"
                         style="
                            max-width: 100%;
                            max-height: 100%;
                            object-fit: contain;
                            border-radius: 6px;
                         "
                         onload="this.style.opacity='1'"
                         onerror="document.getElementById('previewError').style.display='block'">
                </div>

                <div id="previewError" style="
                    display: none;
                    color: var(--danger);
                    background: #ffeaea;
                    padding: 10px;
                    border-radius: 6px;
                    text-align: center;
                ">
                    ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                </div>

                <div style="
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    font-size: 0.9rem;
                    color: var(--gray);
                ">
                    <div>üìÑ –ò–º—è —Ñ–∞–π–ª–∞: <strong>${file.name || 'clipboard_image.png'}</strong></div>
                    <div>üìè –†–∞–∑–º–µ—Ä: <strong>${formatFileSize(file.size)}</strong></div>
                    <div>üñºÔ∏è –†–∞–∑–º–µ—Ä—ã: <span id="imageDimensions">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
                    <div>üìù –§–æ—Ä–º–∞—Ç: <strong>${file.type || 'image/png'}</strong></div>
                </div>

                <div style="
                    display: flex;
                    gap: 15px;
                    justify-content: center;
                    margin-top: 10px;
                ">
                    <button id="sendPreviewBtn"
                            style="
                                padding: 12px 30px;
                                background: var(--primary);
                                color: white;
                                border: none;
                                border-radius: 6px;
                                font-weight: 600;
                                font-size: 1rem;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                transition: all 0.2s;
                            "
                            onmouseover="this.style.backgroundColor='#3a56e4'"
                            onmouseout="this.style.backgroundColor='var(--primary)'">
                        üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>

                    <button id="cancelPreviewBtn"
                            style="
                                padding: 12px 30px;
                                background: var(--gray);
                                color: white;
                                border: none;
                                border-radius: 6px;
                                font-weight: 600;
                                font-size: 1rem;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                transition: all 0.2s;
                            "
                            onmouseover="this.style.backgroundColor='#5a6268'"
                            onmouseout="this.style.backgroundColor='var(--gray)'">
                        ‚ùå –û—Ç–º–µ–Ω–∞
                    </button>

                    <button id="addCaptionBtn"
                            style="
                                padding: 12px 30px;
                                background: #4cc9f0;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                font-weight: 600;
                                font-size: 1rem;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                transition: all 0.2s;
                            "
                            onmouseover="this.style.backgroundColor='#3ab4d9'"
                            onmouseout="this.style.backgroundColor='#4cc9f0'">
                        üìù –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ
                    </button>
                </div>

                <div id="captionContainer" style="display: none; margin-top: 10px;">
                    <textarea id="captionInput"
                              placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é..."
                              rows="3"
                              style="
                                width: 100%;
                                padding: 12px;
                                border: 1px solid var(--border);
                                border-radius: 6px;
                                font-family: inherit;
                                resize: vertical;
                                font-size: 0.95rem;
                              "></textarea>
                </div>

                <div style="
                    text-align: center;
                    font-size: 0.8rem;
                    color: var(--gray);
                    margin-top: 15px;
                    opacity: 0.7;
                ">
                    –ù–∞–∂–º–∏—Ç–µ Esc –¥–ª—è –æ—Ç–º–µ–Ω—ã
                </div>
            </div>
        `;

        // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        const img = preview.querySelector('#previewImage');
        img.onload = function() {
            const dimensions = preview.querySelector('#imageDimensions');
            dimensions.innerHTML = `<strong>${this.naturalWidth} √ó ${this.naturalHeight} px</strong>`;
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        preview.querySelector('#sendPreviewBtn').addEventListener('click', async () => {
            const captionInput = preview.querySelector('#captionInput');
            const caption = captionInput ? captionInput.value.trim() : '';

            if (caption) {
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —á–∞—Ç–∞
                const chatInput = document.getElementById(`message-input-${claimId}`);
                if (chatInput) {
                    chatInput.value = caption;
                    autoResizeTextarea(chatInput);
                }
            }

            await sendImageFromPreview(claimId);
        });

        preview.querySelector('#cancelPreviewBtn').addEventListener('click', () => {
            closePreviewModal();
        });

        preview.querySelector('#addCaptionBtn').addEventListener('click', () => {
            const captionContainer = preview.querySelector('#captionContainer');
            const captionBtn = preview.querySelector('#addCaptionBtn');

            if (captionContainer.style.display === 'none') {
                captionContainer.style.display = 'block';
                captionBtn.innerHTML = 'üìù –°–∫—Ä—ã—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ';
                captionBtn.style.background = '#ff9e00';
                captionBtn.onmouseover = function() {
                    this.style.backgroundColor = '#e68a00';
                };
                captionBtn.onmouseout = function() {
                    this.style.backgroundColor = '#ff9e00';
                };

                // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                setTimeout(() => {
                    const captionInput = preview.querySelector('#captionInput');
                    if (captionInput) captionInput.focus();
                }, 100);
            } else {
                captionContainer.style.display = 'none';
                captionBtn.innerHTML = 'üìù –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ';
                captionBtn.style.background = '#4cc9f0';
                captionBtn.onmouseover = function() {
                    this.style.backgroundColor = '#3ab4d9';
                };
                captionBtn.onmouseout = function() {
                    this.style.backgroundColor = '#4cc9f0';
                };
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
        preview.addEventListener('click', (e) => {
            if (e.target === preview) {
                closePreviewModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        const escapeHandler = (e) => {
            if (e.key === 'Escape') {
                closePreviewModal();
            }
        };
        document.addEventListener('keydown', escapeHandler);
        preview._escapeHandler = escapeHandler;
    };

    reader.readAsDataURL(file);

    document.body.appendChild(preview);
    clipboardPreview = preview;
    pendingImageFile = file;
    currentClaimIdForImage = claimId;

    return preview;
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
async function sendImageFromPreview(claimId) {
    if (!pendingImageFile || !claimId) return;

    const previewModal = document.getElementById('clipboard-preview-modal');
    if (previewModal) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏
        const sendBtn = previewModal.querySelector('#sendPreviewBtn');
        const originalText = sendBtn.innerHTML;
        sendBtn.innerHTML = '<div class="sending-indicator">üì§ –û—Ç–ø—Ä–∞–≤–∫–∞...</div>';
        sendBtn.disabled = true;
    }

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é sendFileToClaim
        await sendFileToClaim(claimId, null, pendingImageFile);

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        closePreviewModal();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
        showClipboardNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –±—É—Ñ–µ—Ä–∞:', error);

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        if (previewModal) {
            const sendBtn = previewModal.querySelector('#sendPreviewBtn');
            sendBtn.innerHTML = originalText;
            sendBtn.disabled = false;
        }

        showClipboardNotification(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
    }
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
function closePreviewModal() {
    if (clipboardPreview) {
        // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Escape
        if (clipboardPreview._escapeHandler) {
            document.removeEventListener('keydown', clipboardPreview._escapeHandler);
        }

        document.body.removeChild(clipboardPreview);
        clipboardPreview = null;
        pendingImageFile = null;
        currentClaimIdForImage = null;
    }
}

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –∏–∑ –±—É—Ñ–µ—Ä–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
function initClipboardPasteForClaim(claimId) {
    const chatInput = document.getElementById(`message-input-${claimId}`);

    if (!chatInput) return;

    chatInput.addEventListener('paste', function(e) {
        const items = e.clipboardData?.items;
        if (!items) return;

        let foundImage = false;

        // –ò—â–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –±—É—Ñ–µ—Ä–µ –æ–±–º–µ–Ω–∞
        for (const item of items) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            if (item.type.indexOf('image') !== -1) {
                e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å—Ç–∞–≤–∫—É —Ç–µ–∫—Å—Ç–∞
                foundImage = true;

                const file = item.getAsFile();
                if (!file) continue;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 20 –ú–ë)
                const maxSize = 20 * 1024 * 1024; // 20 –ú–ë
                if (file.size > maxSize) {
                    showClipboardNotification(`‚ùå –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (${formatFileSize(file.size)}). –ú–∞–∫—Å–∏–º—É–º 20 –ú–ë`, 'error');
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–º–µ—Å—Ç–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
                createPreviewModal(file, claimId);

                break; // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            }
        }

        // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Ä–∞–∑—Ä–µ—à–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –≤—Å—Ç–∞–≤–∫—É —Ç–µ–∫—Å—Ç–∞
        if (!foundImage) {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥–æ–Ω—è–µ–º –≤—ã—Å–æ—Ç—É textarea
            setTimeout(() => {
                autoResizeTextarea(chatInput);
            }, 0);
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showClipboardNotification(message, type = 'info') {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    const oldNotification = document.getElementById('clipboard-notification');
    if (oldNotification) oldNotification.remove();

    const notification = document.createElement('div');
    notification.id = 'clipboard-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'info' ? '#4361ee' : type === 'success' ? '#4cc9f0' : '#e63946'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideInClipboard 0.3s ease;
        max-width: 400px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 0.9rem;
    `;

    notification.innerHTML = `
        <span style="font-size: 1.2rem;">${type === 'info' ? 'üñºÔ∏è' : type === 'success' ? '‚úÖ' : '‚ùå'}</span>
        <span style="flex: 1;">${message}</span>
    `;

    document.body.appendChild(notification);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.style.animation = 'slideOutClipboard 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

    function linkify(htmlString) {
    if (!htmlString) return '';
    // –°–ø–∏—Å–æ–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.tiff', '.ico'];
    // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è URL
    const urlRegex = /(\bhttps?:\/\/[^\s<>"{}|\\^`\[\]]+|\bwww\.[^\s<>"{}|\\^`\[\]]+)/gi;

    return htmlString.replace(urlRegex, match => {
        if (/<\/?a\b|<img\b/i.test(match)) return match;

        const lowerMatch = match.toLowerCase();
        const isImage = imageExtensions.some(ext => lowerMatch.endsWith(ext));

        if (isImage) {
            const imgId = `inline-img-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            return `
                <div class="inline-image-container" style="margin: 0.5rem 0; max-width: 100%;">
                    <img id="${imgId}"
                         src="${match}"
                         alt="–í—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
                         class="max-w-full rounded cursor-pointer inline-image-preview"
                         style="max-height: 200px; object-fit: contain;"
                         onload="handleInlineImageLoad('${imgId}')"
                         onerror="handleInlineImageError('${imgId}')"
                         onclick="openInlinePhotoModal('${match}', '${imgId}')">
                </div>
            `;
        }

        const url = match.startsWith('http') ? match : 'https://' + match;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Å—Ç–∏–ª—å, —á—Ç–æ –∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤
        return `<a href="${url}" target="_blank" rel="noopener noreferrer"
                   style="font-weight: bold !important; color: #2563eb !important; text-decoration: none !important; word-break: break-all;"
                   class="text-blue-600 hover:text-blue-800 no-underline">${match}</a>`;
    });
}

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    function handleInlineImageLoad(imgId) {
        const img = document.getElementById(imgId);
        if (img) {
            img.style.opacity = '1';
            img.style.transition = 'opacity 0.3s ease';
        }
    }
    function handleInlineImageError(imgId) {
        const container = document.getElementById(imgId)?.parentElement;
        if (container) {
            container.innerHTML = `
                <div class="text-center text-red-500 py-1 px-2 bg-red-50 rounded text-xs">
                    ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                </div>
            `;
        }
    }
    function openInlinePhotoModal(imageUrl, imgId) {
    currentPhotoScale = 1;
    translateX = 0;
    translateY = 0;

    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–¥–∞–ª—å–Ω—ã–π –æ–∫–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å
    const oldModal = document.getElementById('claimPhotoModal');
    if (oldModal) oldModal.remove();

    const modal = document.createElement('div');
    modal.id = 'claimPhotoModal';
    modal.className = 'photo-modal';

    modal.innerHTML = `
        <div class="photo-modal-overlay">
            <div class="photo-modal-container">
                <div class="photo-modal-header">
                    <div class="photo-modal-controls">
                        <button class="photo-modal-btn" onclick="claimZoomIn()" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
                        <span class="photo-modal-scale" id="claimPhotoScale">100%</span>
                        <button class="photo-modal-btn" onclick="claimZoomOut()" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
                        <button class="photo-modal-btn" onclick="claimResetZoom()" title="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±">‚ü≤</button>
                        <button class="photo-modal-btn" onclick="claimDownloadUrlPhoto('${imageUrl}')" title="–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ">‚§ì</button>
                    </div>
                    <button class="photo-modal-close" onclick="closeClaimPhotoModal()" title="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
                </div>
                <div class="photo-modal-content-area">
                    <div id="claimPhotoContainer" style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        overflow: hidden;
                        cursor: grab;
                    ">
                        <img class="photo-modal-content" id="claimModalPhoto"
                             src="${imageUrl}"
                             alt="–í—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
                             style="
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%) scale(1);
                                max-width: 100%;
                                max-height: 100%;
                                object-fit: contain;
                                transform-origin: center center;
                                cursor: grab;
                             ">
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
    modal.querySelector('.photo-modal-overlay').onclick = function(event) {
        if (event.target === this) closeClaimPhotoModal();
    };

    document.addEventListener('keydown', handleClaimPhotoModalKeydown);

    // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π wheel listener –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
    modal.removeEventListener('wheel', handleClaimPhotoZoom);
    modal.addEventListener('wheel', handleClaimPhotoWheel, { passive: false });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag & drop
    initializeClaimPhotoDrag(modal);

    setTimeout(() => {
        const hint = document.getElementById('claimPhotoHint');
        if (hint) hint.style.opacity = '0';
    }, 3000);

    claimResetZoom();
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';

    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–æ–≤
    const modalPhoto = document.getElementById('claimModalPhoto');
    if (modalPhoto) {
        modalPhoto.onload = function() {
            calculateClaimMaxOffset();
        };
    }
}
// ==============================================
// –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù –§–û–¢–û (CLAIMS)
// ==============================================

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è claims —Ñ–æ—Ç–æ
let claimPhotoScale = 1;
let claimOffsetX = 0, claimOffsetY = 0;
let isClaimDragging = false;
let claimStartX = 0, claimStartY = 0;
const CLAIM_ZOOM_STEP = 0.2;
const CLAIM_MIN_ZOOM = 0.3;
const CLAIM_MAX_ZOOM = 5;

function initializeClaimPhotoDrag(modal) {
    const photoContainer = modal.querySelector('#claimPhotoContainer');
    const modalPhoto = modal.querySelector('#claimModalPhoto');

    if (!photoContainer || !modalPhoto) return;

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ
    function calculateClaimMaxOffset() {
        if (!modalPhoto.naturalWidth) return { maxX: 0, maxY: 0 };

        const containerRect = photoContainer.getBoundingClientRect();

        // –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞
        const imgWidth = modalPhoto.naturalWidth * claimPhotoScale;
        const imgHeight = modalPhoto.naturalHeight * claimPhotoScale;

        // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ (–ø–æ–ª–æ–≤–∏–Ω–∞ —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É —Ä–∞–∑–º–µ—Ä–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
        const maxX = Math.max(0, (imgWidth - containerRect.width) / 2);
        const maxY = Math.max(0, (imgHeight - containerRect.height) / 2);

        return { maxX, maxY };
    }

    function updateClaimPosition() {
        const { maxX, maxY } = calculateClaimMaxOffset();

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ
        claimOffsetX = Math.max(-maxX, Math.min(maxX, claimOffsetX));
        claimOffsetY = Math.max(-maxY, Math.min(maxY, claimOffsetY));

        modalPhoto.style.transform = `translate(calc(-50% + ${claimOffsetX}px), calc(-50% + ${claimOffsetY}px)) scale(${claimPhotoScale})`;

        const scaleIndicator = document.getElementById('claimPhotoScale');
        if (scaleIndicator) {
            scaleIndicator.textContent = `${Math.round(claimPhotoScale * 100)}%`;
        }

        // –ò–∑–º–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä
        modalPhoto.style.cursor = claimPhotoScale > 1 ? 'grab' : 'move';
        photoContainer.style.cursor = claimPhotoScale > 1 ? 'grab' : 'default';
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    window.calculateClaimMaxOffset = calculateClaimMaxOffset;
    window.updateClaimPosition = updateClaimPosition;

    // Drag to move (–ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ)
    photoContainer.addEventListener('mousedown', (e) => {
        if (claimPhotoScale > 1) {
            isClaimDragging = true;
            claimStartX = e.clientX - claimOffsetX;
            claimStartY = e.clientY - claimOffsetY;
            modalPhoto.style.cursor = 'grabbing';
            photoContainer.style.cursor = 'grabbing';
            e.preventDefault();
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏
    modal.addEventListener('mousemove', (e) => {
        if (!isClaimDragging) return;
        e.preventDefault();

        claimOffsetX = e.clientX - claimStartX;
        claimOffsetY = e.clientY - claimStartY;

        updateClaimPosition();
    });

    modal.addEventListener('mouseup', () => {
        isClaimDragging = false;
        modalPhoto.style.cursor = claimPhotoScale > 1 ? 'grab' : 'move';
        photoContainer.style.cursor = claimPhotoScale > 1 ? 'grab' : 'default';
    });

    // Touch events –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    photoContainer.addEventListener('touchstart', (e) => {
        if (claimPhotoScale > 1 && e.touches.length === 1) {
            isClaimDragging = true;
            claimStartX = e.touches[0].clientX - claimOffsetX;
            claimStartY = e.touches[0].clientY - claimOffsetY;
            e.preventDefault();
        }
    }, { passive: false });

    modal.addEventListener('touchmove', (e) => {
        if (!isClaimDragging || e.touches.length !== 1) return;
        e.preventDefault();

        claimOffsetX = e.touches[0].clientX - claimStartX;
        claimOffsetY = e.touches[0].clientY - claimStartY;

        updateClaimPosition();
    }, { passive: false });

    modal.addEventListener('touchend', () => {
        isClaimDragging = false;
    });
}
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è claims —Ñ–æ—Ç–æ
function claimZoomIn() {
    if (claimPhotoScale < CLAIM_MAX_ZOOM) {
        const oldScale = claimPhotoScale;
        claimPhotoScale = Math.min(CLAIM_MAX_ZOOM, claimPhotoScale + CLAIM_ZOOM_STEP);

        const photoContainer = document.getElementById('claimPhotoContainer');
        if (photoContainer) {
            const containerCenterX = photoContainer.clientWidth / 2;
            const containerCenterY = photoContainer.clientHeight / 2;
            const mouseX = containerCenterX;
            const mouseY = containerCenterY;

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
            claimOffsetX = claimOffsetX * (claimPhotoScale / oldScale) + (mouseX - containerCenterX) * (1 - claimPhotoScale / oldScale);
            claimOffsetY = claimOffsetY * (claimPhotoScale / oldScale) + (mouseY - containerCenterY) * (1 - claimPhotoScale / oldScale);

            updateClaimPosition();
        }
    }
}

function claimZoomOut() {
    if (claimPhotoScale > CLAIM_MIN_ZOOM) {
        const oldScale = claimPhotoScale;
        claimPhotoScale = Math.max(CLAIM_MIN_ZOOM, claimPhotoScale - CLAIM_ZOOM_STEP);

        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ
        claimOffsetX = claimOffsetX * (claimPhotoScale / oldScale);
        claimOffsetY = claimOffsetY * (claimPhotoScale / oldScale);

        updateClaimPosition();
    }
}

function claimResetZoom() {
    claimPhotoScale = 1;
    claimOffsetX = 0;
    claimOffsetY = 0;
    updateClaimPosition();
}
function handleClaimPhotoWheel(event) {
    event.preventDefault();
    event.stopPropagation();

    const photoContainer = document.getElementById('claimPhotoContainer');
    if (!photoContainer) return;

    const containerRect = photoContainer.getBoundingClientRect();
    const mouseX = event.clientX - containerRect.left;
    const mouseY = event.clientY - containerRect.top;

    const oldScale = claimPhotoScale;

    if (event.deltaY < 0) {
        // –ö–æ–ª–µ—Å–æ –≤–≤–µ—Ä—Ö - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º
        if (claimPhotoScale < CLAIM_MAX_ZOOM) {
            claimPhotoScale = Math.min(CLAIM_MAX_ZOOM, claimPhotoScale + CLAIM_ZOOM_STEP);
        }
    } else {
        // –ö–æ–ª–µ—Å–æ –≤–Ω–∏–∑ - —É–º–µ–Ω—å—à–∞–µ–º
        if (claimPhotoScale > CLAIM_MIN_ZOOM) {
            claimPhotoScale = Math.max(CLAIM_MIN_ZOOM, claimPhotoScale - CLAIM_ZOOM_STEP);
        }
    }

    if (oldScale !== claimPhotoScale) {
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
        const scaleRatio = claimPhotoScale / oldScale;
        claimOffsetX = mouseX - (mouseX - claimOffsetX) * scaleRatio;
        claimOffsetY = mouseY - (mouseY - claimOffsetY) * scaleRatio;

        updateClaimPosition();
    }
}
function applyClaimZoom() {
    const modalPhoto = document.getElementById('claimModalPhoto');
    const scaleIndicator = document.getElementById('claimPhotoScale');
    if (modalPhoto) {
        modalPhoto.style.transform = `scale(${currentPhotoScale}) translate(${translateX}px, ${translateY}px)`;
        modalPhoto.style.transition = 'transform 0.2s ease';
    }
    if (scaleIndicator) {
        scaleIndicator.textContent = `${Math.round(currentPhotoScale * 100)}%`;
    }
}
// –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ –∏–∑ claims –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
async function claimDownloadUrlPhoto(imageUrl) {
    try {
        const response = await fetch(imageUrl);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `claim_image_${Date.now()}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url); // –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
    } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
    }
}
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è claims —Ñ–æ—Ç–æ
function claimStartDrag(event) {
    if (event.button !== 0) return;
    isDragging = true;
    startX = event.clientX - translateX;
    startY = event.clientY - translateY;
    const modalPhoto = document.getElementById('claimModalPhoto');
    if (modalPhoto) modalPhoto.style.cursor = 'grabbing';
    event.preventDefault();
}

function claimDrag(event) {
    if (!isDragging) return;
    translateX = event.clientX - startX;
    translateY = event.clientY - startY;
    applyClaimZoom();
}

function claimEndDrag() {
    isDragging = false;
    const modalPhoto = document.getElementById('claimModalPhoto');
    if (modalPhoto) modalPhoto.style.cursor = 'grab';
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑—É–º–∞ –∫–æ–ª–µ—Å–æ–º –º—ã—à–∏
function handleClaimPhotoZoom(event) {
    event.preventDefault();
    if (event.deltaY < 0) {
        claimZoomIn();
    } else {
        claimZoomOut();
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à –¥–ª—è claims –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function handleClaimPhotoModalKeydown(event) {
    const modal = document.getElementById('claimPhotoModal');
    if (!modal || modal.style.display !== 'block') return;

    if (event.key === 'Escape') {
        closeClaimPhotoModal();
    } else if (event.key === '+' || event.key === '=') {
        event.preventDefault();
        claimZoomIn();
    } else if (event.key === '-' || event.key === '_') {
        event.preventDefault();
        claimZoomOut();
    } else if (event.key === '0') {
        event.preventDefault();
        claimResetZoom();
    } else if (event.key === 'ArrowLeft') {
        translateX -= 50;
        applyClaimZoom();
    } else if (event.key === 'ArrowRight') {
        translateX += 50;
        applyClaimZoom();
    } else if (event.key === 'ArrowUp') {
        translateY -= 50;
        applyClaimZoom();
    } else if (event.key === 'ArrowDown') {
        translateY += 50;
        applyClaimZoom();
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ claims
function closeClaimPhotoModal() {
    const modal = document.getElementById('claimPhotoModal');
    if (modal) {
        modal.remove();
    }
    document.removeEventListener('keydown', handleClaimPhotoModalKeydown);
    document.body.style.overflow = 'auto';
}

// –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ –∏–∑ claims –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function claimDownloadPhoto(imageUrl) {
    const link = document.createElement('a');
    link.href = imageUrl;
    link.download = `claim_image_${Date.now()}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à –¥–ª—è chat —Ñ–æ—Ç–æ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
function handleChatPhotoModalKeydown(event) {
    const modal = document.getElementById('chatPhotoModal');
    if (!modal || modal.style.display !== 'block') return;

    if (event.key === 'Escape') {
        closeChatPhotoModal();
    } else if (event.key === '+' || event.key === '=') {
        event.preventDefault();
        zoomInChat();
    } else if (event.key === '-' || event.key === '_') {
        event.preventDefault();
        zoomOutChat();
    } else if (event.key === '0') {
        event.preventDefault();
        resetZoomChat();
    }
}


    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Drag & Drop –¥–ª—è —á–∞—Ç–æ–≤ (–∫–∞–∫ –≤ support)
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function initDragAndDropForChats() {
        document.querySelectorAll('.chat-container').forEach(chatEl => {
            if (chatEl.dataset.dragInitialized) return;
            chatEl.dataset.dragInitialized = "true";

            let dragCounter = 0;
            let overlay = null;

            function createOverlay() {
                if (overlay) return;
                overlay = document.createElement('div');
                overlay.className = 'drag-overlay';
                overlay.innerHTML = `
<!--                    <div>-->
<!--                        <span style="font-size: 4rem;">üìÅ</span>-->
<!--                        <p style="font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</p>-->

<!--                    </div>-->
                `;
                chatEl.appendChild(overlay);
            }

            function showOverlay() {
                createOverlay();
                overlay.classList.add('active');
            }
            function hideOverlay() {
                if (overlay) overlay.classList.remove('active');
            }

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
                chatEl.addEventListener(evt, e => e.preventDefault(), false);
            });

            chatEl.addEventListener('dragenter', e => {
                e.stopPropagation();
                dragCounter++;
                if (dragCounter === 1) showOverlay();
            });

            chatEl.addEventListener('dragleave', e => {
                e.stopPropagation();
                dragCounter--;
                if (dragCounter === 0) hideOverlay();
            });

            chatEl.addEventListener('drop', async e => {
                e.stopPropagation();
                dragCounter = 0;
                hideOverlay();

                const files = e.dataTransfer?.files;
                if (!files || files.length === 0) return;

                const claimEl = chatEl.closest('.claim');
                const claimId = claimEl?.dataset.claimId;
                const userId = claimEl?.dataset.userId;
                if (!claimId || !userId) {
                    console.error('Claim ID or User ID not found for dropped file');
                    return;
                }

                for (let file of files) {
                    await sendFileToClaim(claimId, userId, file);
                }
            });
        });
    }

    async function sendFileToClaim(claimId, userId, file) {
    const maxSize = 50 * 1024 * 1024;
    if (file.size > maxSize) {
        alert(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 50 –ú–ë)`);
        return;
    }

    const messageId = `temp-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
    const messagesEl = document.getElementById(`messages-${claimId}`);
    if (!messagesEl) return;

    const isImage = file.type.startsWith('image/');
    const preview = isImage
        ? `<img src="${URL.createObjectURL(file)}" class="max-w-24 max-h-24 rounded opacity-60">`
        : `üìÅ <span class="font-medium break-all">${escapeHtml(file.name)}</span>`;

    const tempMsg = document.createElement('div');
    tempMsg.id = messageId;
    tempMsg.className = 'message bot';
    tempMsg.innerHTML = `
        <div style="background: #e3f2fd; padding: 0.5rem 0.75rem; border-radius: 8px; max-width: 70%; min-width: 120px;">
            ${preview}
            <div class="text-xs text-blue-700 mt-1">üì§ –û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶</div>
        </div>
    `;
    messagesEl.appendChild(tempMsg);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    try {
        const formData = new FormData();
        formData.append('claim_id', claimId);
        formData.append('file', file);

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ claimId
        const caption = document.getElementById(`message-input-${claimId}`)?.value.trim();
        if (caption) formData.append('caption', caption);

        const res = await fetch('/claims/chat/send-file', {
            method: 'POST',
            body: formData
        });

        const result = await res.json();
        if (!res.ok || !result.ok) throw new Error(result.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');

        tempMsg.remove();
        await loadChatHistory(claimId);

        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
        const chatInput = document.getElementById(`message-input-${claimId}`);
        if (chatInput) {
            chatInput.value = '';
            autoResizeTextarea(chatInput);
        }
    } catch (err) {
        console.error('Drag&drop upload failed:', err);
        const el = document.getElementById(messageId);
        if (el) {
            el.querySelector('.text-blue-700').textContent = `‚ùå ${err.message || '–æ—à–∏–±–∫–∞'}`;
            el.querySelector('.text-blue-700').style.color = '#ef4444';
        }
        setTimeout(() => el?.remove(), 3000);
    }
}

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;")
            .replace(/\n/g, '<br>');
    }

    function formatMessageTime(ts) {
        const d = new Date(ts);
        const now = new Date();
        const diff = (now - d) / 60000; // minutes
        if (diff < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        if (diff < 60) return `${Math.floor(diff)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
        if (diff < 60 * 24) return `${Math.floor(diff / 60)} —á –Ω–∞–∑–∞–¥`;
        return d.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    function formatFileSize(bytes) {
        if (!bytes) return '‚Äì';
        const k = 1024;
        const units = ['B', 'KB', 'MB'];
        let i = Math.floor(Math.log(bytes) / Math.log(k));
        i = Math.min(i, 2);
        return (bytes / Math.pow(k, i)).toFixed(i ? 1 : 0) + ' ' + units[i];
    }

    function autoResizeTextarea(textarea) {
        if (!textarea) return;
        textarea.style.height = 'auto';
        const newHeight = Math.min(150, Math.max(40, textarea.scrollHeight));
        textarea.style.height = newHeight + 'px';
    }


    let isDraggingChat = false;
    let startXChat, startYChat;
    let translateXChat = 0, translateYChat = 0;


    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function handleChatPhotoZoom(event) {
        event.preventDefault();
        if (event.deltaY < 0) zoomInChat(); else zoomOutChat();
    }
    function zoomInChat() {
        if (chatPhotoScale < MAX_ZOOM) {
            chatPhotoScale += ZOOM_STEP;
            applyZoomChat();
        }
    }
    function zoomOutChat() {
        if (chatPhotoScale > MIN_ZOOM) {
            chatPhotoScale -= ZOOM_STEP;
            applyZoomChat();
        }
    }
    function resetZoomChat() {
        chatPhotoScale = 1;
        translateXChat = 0;
        translateYChat = 0;
        applyZoomChat();
    }
    function applyZoomChat() {
        const img = document.getElementById('chatModalPhoto');
        const scaleIndicator = document.getElementById('chatPhotoScale');
        if (img) {
            img.style.transform = `scale(${chatPhotoScale}) translate(${translateXChat}px, ${translateYChat}px)`;
            img.style.transition = 'transform 0.2s ease';
        }
        if (scaleIndicator) {
            scaleIndicator.textContent = `${Math.round(chatPhotoScale * 100)}%`;
        }
    }

<!--    function toggleClaimDetails(element) {-->
<!--        element.classList.toggle('expanded');-->
<!--    }-->

    async function toggleUserBan(userId, claimId, ban) {
        const action = ban ? '–±–ª–æ–∫–∏—Ä–æ–≤–∫—É' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É';
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å ${action} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}?`)) return;
        try {
            const endpoint = ban ? '/claims/user/ban' : '/claims/user/unban';
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: parseInt(userId), claim_id: claimId})
            });
            const result = await response.json();
            if (result.ok) {
                alert(`‚úÖ ${result.message}`);
                location.reload();
            } else {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        }
    }

    function filterBanks(claimId, searchText) {
        const dropdown = document.getElementById(`bank-dropdown-${claimId}`);
        dropdown.innerHTML = '';
        if (!searchText.trim()) {
            populateBankDropdown(claimId, banksData);
            return;
        }
        const filteredBanks = {};
        const searchLower = searchText.toLowerCase();
        for (const [bankId, bankName] of Object.entries(banksData)) {
            if (bankName.toLowerCase().includes(searchLower)) {
                filteredBanks[bankId] = bankName;
            }
        }
        populateBankDropdown(claimId, filteredBanks);
        if (Object.keys(filteredBanks).length === 1) {
            const [singleBankId, singleBankName] = Object.entries(filteredBanks)[0];
            selectBank(claimId, singleBankId, singleBankName);
        }
    }
    function populateBankDropdown(claimId, banks) {
        const dropdown = document.getElementById(`bank-dropdown-${claimId}`);
        if (Object.keys(banks).length === 0) {
            dropdown.innerHTML = '<div class="bank-option">–ë–∞–Ω–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }
        for (const [bankId, bankName] of Object.entries(banks)) {
            const option = document.createElement('div');
            option.className = 'bank-option';
            option.textContent = bankName;
            option.dataset.bankId = bankId;
            option.dataset.bankName = bankName;
            option.onmousedown = (e) => {
                e.preventDefault();
                selectBank(claimId, bankId, bankName);
                hideBankDropdown(claimId);
            };
            dropdown.appendChild(option);
        }
    }
    function selectBank(claimId, bankId, bankName) {
        const searchInput = document.getElementById(`bank-search-${claimId}`);
        const hiddenInput = document.getElementById(`bank-id-${claimId}`);
        const currentBankElement = document.getElementById(`current-bank-${claimId}`);
        searchInput.value = bankName;
        hiddenInput.value = bankId;
        currentBankElement.textContent = bankId;
        updateBankMemberId(claimId, bankId);
    }
    function showBankDropdown(claimId) {
        const dropdown = document.getElementById(`bank-dropdown-${claimId}`);
        const searchInput = document.getElementById(`bank-search-${claimId}`);
        if (!searchInput.value.trim()) {
            populateBankDropdown(claimId, banksData);
        }
        dropdown.classList.add('active');
    }
    function hideBankDropdown(claimId) {
        setTimeout(() => {
            const dropdown = document.getElementById(`bank-dropdown-${claimId}`);
            dropdown.classList.remove('active');
        }, 200);
    }
    function clearBankSearch(claimId) {
        const searchInput = document.getElementById(`bank-search-${claimId}`);
        const hiddenInput = document.getElementById(`bank-id-${claimId}`);
        const currentBankElement = document.getElementById(`current-bank-${claimId}`);
        searchInput.value = '';
        hiddenInput.value = '';
        currentBankElement.textContent = '‚Äî';
        updateBankMemberId(claimId, '');
        const dropdown = document.getElementById(`bank-dropdown-${claimId}`);
        dropdown.innerHTML = '';
    }
    async function updateBankMemberId(claimId, bankId) {
        const statusElement = document.getElementById(`bank-status-${claimId}`);
        const currentBankElement = document.getElementById(`current-bank-${claimId}`);
        try {
            statusElement.textContent = "‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
            statusElement.className = "bank-saving";
            const response = await fetch('/claims/update_bank', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({claim_id: claimId, bank_member_id: bankId})
            });
            const result = await response.json();
            if (result.ok) {
                statusElement.textContent = "‚úÖ –ë–∞–Ω–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω";
                statusElement.className = "bank-success";
                currentBankElement.textContent = bankId || '‚Äî';
                setTimeout(() => { statusElement.textContent = ""; }, 3000);
            } else {
                statusElement.textContent = `‚ùå –û—à–∏–±–∫–∞: ${result.error}`;
                statusElement.className = "bank-error";
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–Ω–∫–∞:', error);
            statusElement.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
            statusElement.className = "bank-error";
        }
    }

    async function startChatSession(claimId) {
        try {
            const res = await fetch('/claims/chat/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({claim_id: claimId})
            });
            const data = await res.json();
            if (!data.ok) throw new Error('Failed to start chat');
        } catch (e) {
            console.error('Start chat error:', e);
        }
    }

    async function toggleChat(button, claimId, userId) {
    const chatContainer = document.getElementById(`chat-${claimId}`);
    const toggleButton = document.getElementById(`chat-toggle-${claimId}`);
    const isActive = chatContainer.classList.contains('active');

    if (!isActive) {
        await startChatSession(claimId);
        await loadChatHistory(claimId);
        startPolling(claimId);
        setupFileUploadForClaim(claimId);
        initDragAndDropForChats(); // ‚Üê –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DnD –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞
        initClipboardPasteForClaim(claimId);

        toggleButton.innerHTML = `üîº –°–≤–µ—Ä–Ω—É—Ç—å —á–∞—Ç`;
        setTimeout(() => {
            chatContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    } else {
        stopPolling(claimId);
        toggleButton.innerHTML = `üí¨ –ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º`;
    }
    chatContainer.classList.toggle('active');
}

    async function loadChatHistory(claimId) {
        try {
            const res = await fetch(`/claims/chat/history?claim_id=${claimId}`);
            if (!res.ok) return;
            const messages = await res.json();
            displayMessages(claimId, messages);
            resetUnreadCount(claimId);
        } catch (e) {
            console.error('üí• –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', e);
        }
    }

    async function displayMessages(claimId, messages) {
    const container = document.getElementById(`messages-${claimId}`);
    if (!container) return;

    const photoUrlMap = {};
    const photoPromises = messages
        .filter(msg => msg.has_photo && msg.photo_file_id)
        .map(async (msg) => {
            try {
                const resp = await fetch(`/claims/chat/photo-url/${msg.id}`);
                if (resp.ok) {
                    const data = await resp.json();
                    photoUrlMap[msg.id] = data.url;
                }
            } catch (e) {
                console.warn(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å URL —Ñ–æ—Ç–æ ${msg.id}`);
            }
        });
    await Promise.all(photoPromises);

    const fragment = document.createDocumentFragment();
    for (const msg of messages) {
        const div = document.createElement('div');
        div.className = `message ${msg.is_bot ? 'bot' : 'user'}`;
        const timeStr = formatMessageTime(msg.timestamp);
        let content = '';

        if (msg.has_photo && msg.photo_file_id) {
            // –§–û–¢–û —Å –ø—Ä–µ–≤—å—é
            const url = photoUrlMap[msg.id];
            if (url) {
                content += `
                    <div style="margin-bottom: 6px;">
                        <img src="${url}" alt="–§–æ—Ç–æ"
                             style="max-width: 100px; max-height: 100px; border-radius: 6px; border: 2px solid var(--primary); cursor: pointer;"
                             onclick="openChatPhoto('${msg.id}')"
                             onerror="this.parentElement.innerHTML='üñºÔ∏è –û—à–∏–±–∫–∞'">
                    </div>`;
            } else {
                content += `<div style="color:#e63946;">‚ùå –§–æ—Ç–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</div>`;
            }

            // –î–ª—è —Ñ–æ—Ç–æ: –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ
            if (msg.message) {
                const lines = msg.message.split('\n');
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
                const isJustFileName = lines.length === 1 &&
                    (lines[0].trim().toLowerCase().endsWith('.jpg') ||
                     lines[0].trim().toLowerCase().endsWith('.jpeg') ||
                     lines[0].trim().toLowerCase().endsWith('.png') ||
                     lines[0].trim().toLowerCase().endsWith('.gif'));

                if (!isJustFileName) {
                    content += `<div style="margin-top: 4px;">${linkify(escapeHtml(msg.message))}</div>`;
                }
            }
        } else if (msg.photo_file_id) {
            // –î–û–ö–£–ú–ï–ù–¢ (—Ñ–∞–π–ª –±–µ–∑ –ø—Ä–µ–≤—å—é)
            const lines = msg.message?.split('\n') || [];
            const fileName = lines[0]?.trim() || '–§–∞–π–ª';

            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Å—Ç–∞–≤—à–∏–π—Å—è —Ç–µ–∫—Å—Ç (–±–µ–∑ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ —ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞)
            let remainingText = '';
            if (lines.length > 1) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫, –±–µ—Ä–µ–º –≤—Å–µ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π
                remainingText = lines.slice(1).join('\n').trim();
            } else if (lines.length === 1) {
                // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ñ–∞–π–ª–∞
                const isFileName = fileName.toLowerCase().match(/\.(jpg|jpeg|png|gif|pdf|doc|docx|xls|xlsx|txt|zip|rar)$/);
                if (!isFileName) {
                    remainingText = fileName; // –≠—Ç–æ –Ω–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞, –∞ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                }
                // –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ - remainingText –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø—É—Å—Ç—ã–º
            }

            content = `
    <div style="margin-bottom: 6px;">
        <a href="/claims/chat/download/${msg.id}"
           style="font-weight: bold !important; color: #2563eb !important; text-decoration: none !important; word-break: break-all; display: inline-flex; align-items: center; gap: 4px;"
           title="–°–∫–∞—á–∞—Ç—å ${escapeHtml(fileName)}">
            üìÇ <span>${escapeHtml(fileName)}</span>
        </a>
    </div>
`;
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–π—Å—è —Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (remainingText) {
                content += `<div style="margin-top: 4px;">${linkify(escapeHtml(remainingText))}</div>`;
            }
        } else {
            // –û–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            content = `<div>${linkify(escapeHtml(msg.message || '[–ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'))}</div>`;
        }

        div.innerHTML = `${content}<div class="message-time">${timeStr}</div>`;
        fragment.appendChild(div);
    }

    container.innerHTML = '';
    container.appendChild(fragment);
    initializeChatScroll(claimId);
    setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
}

    let isSendingMessage = {};

async function sendMessage(event, claimId, userId) {
    event.preventDefault();

    if (isSendingMessage[claimId]) {
        console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º...');
        return;
    }

    const input = document.getElementById(`message-input-${claimId}`);
    const text = input.value.trim();

    if (!text) return;

    isSendingMessage[claimId] = true;

    const sendBtn = event.target.querySelector('button[type="submit"]') ||
                   document.querySelector(`#chat-${claimId} .chat-send`);
    const originalBtnText = sendBtn?.innerHTML;
    if (sendBtn) {
        sendBtn.innerHTML = '<span class="sending-spinner">‚è≥</span> –û—Ç–ø—Ä–∞–≤–∫–∞...';
        sendBtn.disabled = true;
    }

    if (input) {
        input.disabled = true;
    }

    try {
        const res = await fetch('/claims/chat/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({claim_id: claimId, text, is_bot: true})
        });

        if (res.ok) {
            input.value = '';
            resetTextareaHeight(input);
            await loadChatHistory(claimId);

            setTimeout(() => {
                const container = document.getElementById(`messages-${claimId}`);
                if (container) container.scrollTop = container.scrollHeight;
            }, 100);

        } else {
            const error = await res.json();
            alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        console.error('Send message error:', e);
        alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
    } finally {
        isSendingMessage[claimId] = false;

        if (sendBtn) {
            sendBtn.innerHTML = originalBtnText;
            sendBtn.disabled = false;
        }

        if (input) {
            input.disabled = false;
            input.focus();
        }
    }
}

    function initializeChatScroll(claimId) {
        const container = document.getElementById(`messages-${claimId}`);
        if (!container) return;
        let isScrollingChat = false;
        container.addEventListener('wheel', (e) => {
            const atTop = container.scrollTop === 0;
            const atBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 1;
            if ((e.deltaY > 0 && atBottom) || (e.deltaY < 0 && atTop)) {
                e.preventDefault();
                e.stopPropagation();
            } else if (!atTop && !atBottom) {
                e.stopPropagation();
            }
        });
        container.addEventListener('touchstart', (e) => { isScrollingChat = true; });
        container.addEventListener('touchmove', (e) => { if (isScrollingChat) e.stopPropagation(); });
        container.addEventListener('touchend', (e) => { isScrollingChat = false; });
    }

    function setupFileUploadForClaim(claimId) {
    const fileInput = document.getElementById(`fileInput-${claimId}`);
    const statusDiv = document.getElementById(`fileStatus-${claimId}`);
    const chatInput = document.getElementById(`message-input-${claimId}`);
    if (!fileInput || !statusDiv) return;

    fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        statusDiv.textContent = `üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ ${file.name}...`;
        statusDiv.style.color = '#6c757d';

        const formData = new FormData();
        formData.append('claim_id', claimId);
        formData.append('file', file);
        const caption = chatInput?.value.trim();
        if (caption) formData.append('caption', caption);

        try {
            const response = await fetch('/claims/chat/send-file', {method: 'POST', body: formData});
            const result = await response.json();
            if (response.ok && result.ok) {
                statusDiv.textContent = `‚úÖ ${file.name} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`;
                statusDiv.style.color = '#4CAF50';

                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                if (chatInput) {
                    chatInput.value = '';
                    autoResizeTextarea(chatInput);
                }

                e.target.value = '';
                await loadChatHistory(claimId);
            } else {
                throw new Error(result.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞:', error);
            statusDiv.textContent = `‚ùå ${error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª'}`;
            statusDiv.style.color = '#e63946';
        }
        setTimeout(() => { statusDiv.textContent = ''; }, 3000);
    });
}

    function resetTextareaHeight(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = '44px';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º
    document.addEventListener('DOMContentLoaded', function() {
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('chat-input')) autoResizeTextarea(e.target);
        });
        document.addEventListener('keydown', function(e) {
            if (e.target.classList.contains('chat-input') && e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const claimId = e.target.id.replace('message-input-', '');
                const userId = document.querySelector(`[data-claim-id="${claimId}"]`)?.dataset.userId;
                if (userId) {
                    sendMessage(e, claimId, userId);
                }
            }
        });
    });

    // Polling ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    function startPolling(claimId) {
        stopPolling(claimId);
        chatIntervals[claimId] = setInterval(async () => {
            try {
                const res = await fetch(`/claims/chat/history?claim_id=${claimId}`);
                const messages = await res.json();
                const container = document.getElementById(`messages-${claimId}`);
                const currentCount = container.children.length;
                if (messages.length > currentCount) {
                    displayMessages(claimId, messages);
                    if (!document.getElementById(`chat-${claimId}`).classList.contains('active')) {
                        incrementUnreadCount(claimId);
                    }
                }
            } catch (e) {
                console.error('Poll error:', e);
            }
        }, 3000);
    }

    async function closeChatSession(claimId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç? –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏.')) return;
        try {
            const response = await fetch('/claims/chat/close/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({claim_id: claimId})
            });
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    showNotification('‚úÖ –ß–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
                    setTimeout(() => { window.location.reload(); }, 1000);
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞:', error);
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —á–∞—Ç–∞', 'error');
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px;
            color: white; font-weight: 500; z-index: 10000; animation: slideIn 0.3s ease;
            ${type === 'success' ? 'background: #4CAF50;' : 'background: #f44336;'}
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => { notification.remove(); }, 3000);
    }

    function stopPolling(claimId) {
        if (chatIntervals[claimId]) {
            clearInterval(chatIntervals[claimId]);
            delete chatIntervals[claimId];
        }
    }

    function incrementUnreadCount(claimId) {
    unreadCounters[claimId] = (unreadCounters[claimId] || 0) + 1;
    const badge = document.getElementById(`unread-badge-${claimId}`);
    if (badge) {
        badge.textContent = unreadCounters[claimId];
        badge.style.display = 'inline-flex';
    }
}

    function resetUnreadCount(claimId) {
    unreadCounters[claimId] = 0;
    const badge = document.getElementById(`unread-badge-${claimId}`);
    if (badge) {
        badge.style.display = 'none';
    }
}

    async function updateStatus(claimId, newStatus) {
        if (!confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ ‚Ññ${claimId} –Ω–∞ "${newStatus}"?`)) return;
        try {
            const res = await fetch('/claims/status/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({claim_id: claimId, new_status: newStatus, close_chat: true})
            });
            const result = await res.json();
            if (result.ok) {
                const chatContainer = document.getElementById(`chat-${claimId}`);
                if (chatContainer && chatContainer.classList.contains('active')) {
                    toggleChat(null, claimId);
                }
                alert('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω' + (newStatus === 'pending' ? ', –ø–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω' : ''));
                location.reload();
            } else {
                alert(`‚ùå ${result.error || '–û—à–∏–±–∫–∞'}`);
            }
        } catch (e) {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        }
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏, —Ç–æ–ª—å–∫–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    let galleryPhotoScale = 1;
    let galleryOffsetX = 0, galleryOffsetY = 0;
    let isGalleryDragging = false;
    let galleryStartX = 0, galleryStartY = 0;
    const GALLERY_ZOOM_STEP = 0.2;
    const GALLERY_MIN_ZOOM = 0.3;
    const GALLERY_MAX_ZOOM = 5;
    function openPhotoModal(claimId, photoIndex, photoCount) {
    currentClaimId = claimId;
    currentPhotoIndex = photoIndex;
    totalPhotos = photoCount;
    galleryPhotoScale = 1;
    galleryOffsetX = 0;
    galleryOffsetY = 0;

    const oldModal = document.getElementById('photoModal');
    if (oldModal) oldModal.remove();

    const modal = document.createElement('div');
    modal.id = 'photoModal';
    modal.className = 'photo-modal';
    modal.innerHTML = `
        <div class="photo-modal-overlay">
            <div class="photo-modal-container">
                <div class="photo-modal-header">
                    <div class="photo-modal-controls">
                        <button class="photo-modal-btn" onclick="zoomOutGallery()" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
                        <span class="photo-modal-scale" id="photoScale">100%</span>
                        <button class="photo-modal-btn" onclick="zoomInGallery()" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
                        <button class="photo-modal-btn" onclick="resetZoomGallery()" title="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±">‚ü≤</button>
                        <button class="photo-modal-btn" onclick="downloadCurrentPhoto()" title="–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ">‚§ì</button>
                    </div>
                    <div class="photo-modal-counter" id="photoCounter">${photoIndex + 1} / ${photoCount}</div>
                    <button class="photo-modal-close" onclick="closePhotoModal()" title="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
                </div>
                <div class="photo-modal-content-area">
                    <button class="photo-modal-nav photo-modal-prev" onclick="changePhoto(-1)">‚ùÆ</button>
                    <div id="galleryPhotoContainer" style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        overflow: hidden;
                        cursor: grab;
                    ">
                        <img class="photo-modal-content" id="modalPhoto"
                             style="
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%) scale(1);
                                max-width: 100%;
                                max-height: 100%;
                                object-fit: contain;
                                transform-origin: center center;
                                cursor: grab;
                             ">
                    </div>
                    <button class="photo-modal-nav photo-modal-next" onclick="changePhoto(1)">‚ùØ</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag & drop
    initializeGalleryPhotoDrag(modal);

    modal.querySelector('.photo-modal-overlay').onclick = function(event) {
        if (event.target === this) closePhotoModal();
    };

    document.addEventListener('keydown', handlePhotoModalKeydown);

    // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π wheel listener –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
    modal.removeEventListener('wheel', handlePhotoZoom);
    modal.addEventListener('wheel', handleGalleryPhotoWheel, { passive: false });

    resetZoomGallery();
    updateModalPhoto();
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}
function initializeGalleryPhotoDrag(modal) {
    const photoContainer = modal.querySelector('#galleryPhotoContainer');
    const modalPhoto = modal.querySelector('#modalPhoto');

    if (!photoContainer || !modalPhoto) return;

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ
    function calculateGalleryMaxOffset() {
        if (!modalPhoto.naturalWidth) return { maxX: 0, maxY: 0 };

        const containerRect = photoContainer.getBoundingClientRect();

        // –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞
        const imgWidth = modalPhoto.naturalWidth * galleryPhotoScale;
        const imgHeight = modalPhoto.naturalHeight * galleryPhotoScale;

        // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ (–ø–æ–ª–æ–≤–∏–Ω–∞ —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É —Ä–∞–∑–º–µ—Ä–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
        const maxX = Math.max(0, (imgWidth - containerRect.width) / 2);
        const maxY = Math.max(0, (imgHeight - containerRect.height) / 2);

        return { maxX, maxY };
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
    function updateGalleryPosition() {
        const { maxX, maxY } = calculateGalleryMaxOffset();

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ
        galleryOffsetX = Math.max(-maxX, Math.min(maxX, galleryOffsetX));
        galleryOffsetY = Math.max(-maxY, Math.min(maxY, galleryOffsetY));

        modalPhoto.style.transform = `translate(calc(-50% + ${galleryOffsetX}px), calc(-50% + ${galleryOffsetY}px)) scale(${galleryPhotoScale})`;

        const scaleIndicator = document.getElementById('photoScale');
        if (scaleIndicator) {
            scaleIndicator.textContent = `${Math.round(galleryPhotoScale * 100)}%`;
        }

        // –ò–∑–º–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä
        modalPhoto.style.cursor = galleryPhotoScale > 1 ? 'grab' : 'move';
        photoContainer.style.cursor = galleryPhotoScale > 1 ? 'grab' : 'default';
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    window.calculateGalleryMaxOffset = calculateGalleryMaxOffset;
    window.updateGalleryPosition = updateGalleryPosition;

    // Drag to move (–ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ)
    photoContainer.addEventListener('mousedown', (e) => {
        if (galleryPhotoScale > 1) {
            isGalleryDragging = true;
            galleryStartX = e.clientX - galleryOffsetX;
            galleryStartY = e.clientY - galleryOffsetY;
            modalPhoto.style.cursor = 'grabbing';
            photoContainer.style.cursor = 'grabbing';
            e.preventDefault();
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏
    modal.addEventListener('mousemove', (e) => {
        if (!isGalleryDragging) return;
        e.preventDefault();

        galleryOffsetX = e.clientX - galleryStartX;
        galleryOffsetY = e.clientY - galleryStartY;

        updateGalleryPosition();
    });

    modal.addEventListener('mouseup', () => {
        isGalleryDragging = false;
        modalPhoto.style.cursor = galleryPhotoScale > 1 ? 'grab' : 'move';
        photoContainer.style.cursor = galleryPhotoScale > 1 ? 'grab' : 'default';
    });

    // Touch events –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    photoContainer.addEventListener('touchstart', (e) => {
        if (galleryPhotoScale > 1 && e.touches.length === 1) {
            isGalleryDragging = true;
            galleryStartX = e.touches[0].clientX - galleryOffsetX;
            galleryStartY = e.touches[0].clientY - galleryOffsetY;
            e.preventDefault();
        }
    }, { passive: false });

    modal.addEventListener('touchmove', (e) => {
        if (!isGalleryDragging || e.touches.length !== 1) return;
        e.preventDefault();

        galleryOffsetX = e.touches[0].clientX - galleryStartX;
        galleryOffsetY = e.touches[0].clientY - galleryStartY;

        updateGalleryPosition();
    }, { passive: false });

    modal.addEventListener('touchend', () => {
        isGalleryDragging = false;
    });
}
function zoomInGallery() {
    if (galleryPhotoScale < GALLERY_MAX_ZOOM) {
        const oldScale = galleryPhotoScale;
        galleryPhotoScale = Math.min(GALLERY_MAX_ZOOM, galleryPhotoScale + GALLERY_ZOOM_STEP);

        const photoContainer = document.getElementById('galleryPhotoContainer');
        if (photoContainer) {
            const containerCenterX = photoContainer.clientWidth / 2;
            const containerCenterY = photoContainer.clientHeight / 2;
            const mouseX = containerCenterX;
            const mouseY = containerCenterY;

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
            galleryOffsetX = galleryOffsetX * (galleryPhotoScale / oldScale) + (mouseX - containerCenterX) * (1 - galleryPhotoScale / oldScale);
            galleryOffsetY = galleryOffsetY * (galleryPhotoScale / oldScale) + (mouseY - containerCenterY) * (1 - galleryPhotoScale / oldScale);

            updateGalleryPosition();
        }
    }
}

function zoomOutGallery() {
    if (galleryPhotoScale > GALLERY_MIN_ZOOM) {
        const oldScale = galleryPhotoScale;
        galleryPhotoScale = Math.max(GALLERY_MIN_ZOOM, galleryPhotoScale - GALLERY_ZOOM_STEP);

        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ
        galleryOffsetX = galleryOffsetX * (galleryPhotoScale / oldScale);
        galleryOffsetY = galleryOffsetY * (galleryPhotoScale / oldScale);

        updateGalleryPosition();
    }
}

function resetZoomGallery() {
    galleryPhotoScale = 1;
    galleryOffsetX = 0;
    galleryOffsetY = 0;
    updateGalleryPosition();
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑—É–º–∞ –∫–æ–ª–µ—Å–æ–º –º—ã—à–∏ –¥–ª—è gallery —Ñ–æ—Ç–æ
function handleGalleryPhotoWheel(event) {
    event.preventDefault();
    event.stopPropagation();

    const photoContainer = document.getElementById('galleryPhotoContainer');
    if (!photoContainer) return;

    const containerRect = photoContainer.getBoundingClientRect();
    const mouseX = event.clientX - containerRect.left;
    const mouseY = event.clientY - containerRect.top;

    const oldScale = galleryPhotoScale;

    if (event.deltaY < 0) {
        // –ö–æ–ª–µ—Å–æ –≤–≤–µ—Ä—Ö - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º
        if (galleryPhotoScale < GALLERY_MAX_ZOOM) {
            galleryPhotoScale = Math.min(GALLERY_MAX_ZOOM, galleryPhotoScale + GALLERY_ZOOM_STEP);
        }
    } else {
        // –ö–æ–ª–µ—Å–æ –≤–Ω–∏–∑ - —É–º–µ–Ω—å—à–∞–µ–º
        if (galleryPhotoScale > GALLERY_MIN_ZOOM) {
            galleryPhotoScale = Math.max(GALLERY_MIN_ZOOM, galleryPhotoScale - GALLERY_ZOOM_STEP);
        }
    }

    if (oldScale !== galleryPhotoScale) {
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
        const scaleRatio = galleryPhotoScale / oldScale;
        galleryOffsetX = mouseX - (mouseX - galleryOffsetX) * scaleRatio;
        galleryOffsetY = mouseY - (mouseY - galleryOffsetY) * scaleRatio;

        updateGalleryPosition();
    }
}
    function closeChatPhotoModal() {
        const modal = document.getElementById('chatPhotoModal');
        if (modal) modal.remove();
        document.removeEventListener('keydown', handleChatPhotoModalKeydown);
        document.body.style.overflow = 'auto';
    }

    function closePhotoModal() {
    const modal = document.getElementById('photoModal');
    if (modal) {
        modal.remove();
    }
    document.body.style.overflow = 'auto';
    document.removeEventListener('keydown', handlePhotoModalKeydown);
}

    // –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ –µ—Å—Ç—å
    function handlePhotoZoom(event) {
        event.preventDefault();
        if (event.deltaY < 0) zoomIn(); else zoomOut();
    }
    function zoomIn() {
        if (currentScale < MAX_ZOOM) {
            currentScale += ZOOM_STEP;
            applyZoom();
        }
    }
    function zoomOut() {
        if (currentScale > MIN_ZOOM) {
            currentScale -= ZOOM_STEP;
            applyZoom();
        }
    }
    function resetZoom() {
        currentScale = 1;
        applyZoom();
    }
    function applyZoom() {
        const modalPhoto = document.getElementById('modalPhoto');
        const scaleIndicator = document.getElementById('photoScale');
        if (modalPhoto) {
            modalPhoto.style.transform = `scale(${currentScale})`;
            modalPhoto.style.transition = 'transform 0.2s ease';
        }
        if (scaleIndicator) scaleIndicator.textContent = `${Math.round(currentScale * 100)}%`;
    }
    function downloadCurrentPhoto() {
    const modalPhoto = document.getElementById('modalPhoto');
    if (!modalPhoto || !modalPhoto.src) return;
    const link = document.createElement('a');
    link.href = modalPhoto.src;
    link.download = `photo_${currentClaimId}_${currentPhotoIndex + 1}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    function downloadChatPhoto(messageId) {
        const modalPhoto = document.getElementById('chatModalPhoto');
        if (!modalPhoto || !modalPhoto.src) return;
        const link = document.createElement('a');
        link.href = modalPhoto.src;
        link.download = `chat_photo_${messageId}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    async function loadChatPhoto(messageId, modal) {
    try {
        const resp = await fetch(`/claims/chat/photo-url/${messageId}`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const { url } = await resp.json();

        const img = document.getElementById('chatModalPhoto');
        if (!img) return;

        img.onerror = () => {
            img.src = 'https://via.placeholder.com/400x300/333/999?text=üñºÔ∏è+–û—à–∏–±–∫–∞+–∑–∞–≥—Ä—É–∑–∫–∏';
            img.alt = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ";
            if (typeof updateChatPosition === 'function') {
                updateChatPosition();
            }
        };

        img.onload = () => {
            if (typeof calculateChatMaxOffset === 'function' && typeof updateChatPosition === 'function') {
                calculateChatMaxOffset();
                updateChatPosition();
            }
        };

        img.src = url;
        img.alt = "–§–æ—Ç–æ –∏–∑ —á–∞—Ç–∞";
    } catch (error) {
        console.error("‚ùå loadChatPhoto error:", error);
        const img = document.getElementById('chatModalPhoto');
        if (img) {
            img.src = 'https://via.placeholder.com/400x300/333/999?text=üñºÔ∏è+–û—à–∏–±–∫–∞+–∑–∞–≥—Ä—É–∑–∫–∏';
            img.alt = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ";
            if (typeof updateChatPosition === 'function') {
                updateChatPosition();
            }
        }
    }
}
    function handlePhotoModalKeydown(event) {
    const photoModal = document.getElementById('photoModal');
    const chatPhotoModal = document.getElementById('chatPhotoModal');

    if (photoModal && photoModal.style.display === 'block') {
        if (event.key === 'Escape') {
            closePhotoModal();
        } else if (event.key === 'ArrowLeft') {
            changePhoto(-1);
        } else if (event.key === 'ArrowRight') {
            changePhoto(1);
        } else if (event.key === '+' || event.key === '=') {
            event.preventDefault();
            zoomInGallery();
        } else if (event.key === '-' || event.key === '_') {
            event.preventDefault();
            zoomOutGallery();
        } else if (event.key === '0') {
            event.preventDefault();
            resetZoomGallery();
        } else if (event.key === 'ArrowLeft' && event.altKey) {
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–µ–ª–∫–∏ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            galleryOffsetX -= 50;
            if (typeof updateGalleryPosition === 'function') updateGalleryPosition();
        } else if (event.key === 'ArrowRight' && event.altKey) {
            galleryOffsetX += 50;
            if (typeof updateGalleryPosition === 'function') updateGalleryPosition();
        } else if (event.key === 'ArrowUp' && event.altKey) {
            galleryOffsetY -= 50;
            if (typeof updateGalleryPosition === 'function') updateGalleryPosition();
        } else if (event.key === 'ArrowDown' && event.altKey) {
            galleryOffsetY += 50;
            if (typeof updateGalleryPosition === 'function') updateGalleryPosition();
        }
    } else if (chatPhotoModal && chatPhotoModal.style.display === 'block') {
        if (event.key === 'Escape') {
            closeChatPhotoModal();
        } else if (event.key === '+' || event.key === '=') {
            event.preventDefault();
            zoomInChat();
        } else if (event.key === '-' || event.key === '_') {
            event.preventDefault();
            zoomOutChat();
        } else if (event.key === '0') {
            event.preventDefault();
            resetZoomChat();
        }
    }
}
    function changePhoto(direction) {
    currentPhotoIndex += direction;
    if (currentPhotoIndex >= totalPhotos) currentPhotoIndex = 0;
    else if (currentPhotoIndex < 0) currentPhotoIndex = totalPhotos - 1;

    resetZoomGallery();
    updateModalPhoto();
}
    function updateModalPhoto() {
    const modalPhoto = document.getElementById('modalPhoto');
    const photoCounter = document.getElementById('photoCounter');

    if (modalPhoto && photoCounter) {
        modalPhoto.classList.remove('photo-fade');
        void modalPhoto.offsetWidth;
        modalPhoto.classList.add('photo-fade');
        modalPhoto.src = `/claims/${currentClaimId}/photos/${currentPhotoIndex}`;
        modalPhoto.alt = `–§–æ—Ç–æ ${currentPhotoIndex + 1}`;
        photoCounter.textContent = `${currentPhotoIndex + 1} / ${totalPhotos}`;

        const prevBtn = document.querySelector('.photo-modal-prev');
        const nextBtn = document.querySelector('.photo-modal-next');
        if (totalPhotos <= 1) {
            if (prevBtn) prevBtn.style.display = 'none';
            if (nextBtn) nextBtn.style.display = 'none';
        } else {
            if (prevBtn) prevBtn.style.display = 'block';
            if (nextBtn) nextBtn.style.display = 'block';
        }

        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        modalPhoto.onload = function() {
            if (typeof calculateGalleryMaxOffset === 'function' && typeof updateGalleryPosition === 'function') {
                calculateGalleryMaxOffset();
                updateGalleryPosition();
            }
        };
    }
}
function openChatPhoto(messageId) {
    chatPhotoScale = 1;
    chatOffsetX = 0;
    chatOffsetY = 0;

    const oldModal = document.getElementById('chatPhotoModal');
    if (oldModal) oldModal.remove();

    const modal = document.createElement('div');
    modal.id = 'chatPhotoModal';
    modal.className = 'photo-modal';
    modal.innerHTML = `
        <div class="photo-modal-overlay">
            <div class="photo-modal-container">
                <div class="photo-modal-header">
                    <div class="photo-modal-controls">
                        <button class="photo-modal-btn" onclick="zoomOutChat()" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
                        <span class="photo-modal-scale" id="chatPhotoScale">100%</span>
                        <button class="photo-modal-btn" onclick="zoomInChat()" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
                        <button class="photo-modal-btn" onclick="resetZoomChat()" title="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±">‚ü≤</button>
                        <button class="photo-modal-btn" onclick="downloadChatPhoto('${messageId}')" title="–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ">‚§ì</button>
                    </div>
                    <button class="photo-modal-close" onclick="closeChatPhotoModal()" title="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
                </div>
                <div class="photo-modal-content-area">
                    <div id="chatPhotoContainer" style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        overflow: hidden;
                        cursor: grab;
                    ">
                        <img class="photo-modal-content" id="chatModalPhoto"
                             style="
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%) scale(1);
                                max-width: 100%;
                                max-height: 100%;
                                object-fit: contain;
                                transform-origin: center center;
                                cursor: grab;
                             ">
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    modal.querySelector('.photo-modal-overlay').onclick = function(e) {
        if (e.target === this) closeChatPhotoModal();
    };

    // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π wheel listener –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
    modal.removeEventListener('wheel', handleChatPhotoZoom);
    modal.addEventListener('wheel', handleChatPhotoWheel, { passive: false });

    document.addEventListener('keydown', handleChatPhotoModalKeydown);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag & drop
    initializeChatPhotoDrag(modal);

    resetZoomChat();
    loadChatPhoto(messageId, modal);

    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';

    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–æ–≤
    const modalPhoto = document.getElementById('chatModalPhoto');
    if (modalPhoto) {
        modalPhoto.onload = function() {
            calculateChatMaxOffset();
        };
    }
}

const CHAT_ZOOM_STEP = 0.2;
const CHAT_MIN_ZOOM = 0.3;
const CHAT_MAX_ZOOM = 5;

function initializeChatPhotoDrag(modal) {
    const photoContainer = modal.querySelector('#chatPhotoContainer');
    const modalPhoto = modal.querySelector('#chatModalPhoto');

    if (!photoContainer || !modalPhoto) return;

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ
    function calculateChatMaxOffset() {
        if (!modalPhoto.naturalWidth) return { maxX: 0, maxY: 0 };

        const containerRect = photoContainer.getBoundingClientRect();

        // –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞
        const imgWidth = modalPhoto.naturalWidth * chatPhotoScale;
        const imgHeight = modalPhoto.naturalHeight * chatPhotoScale;

        // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ (–ø–æ–ª–æ–≤–∏–Ω–∞ —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É —Ä–∞–∑–º–µ—Ä–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
        const maxX = Math.max(0, (imgWidth - containerRect.width) / 2);
        const maxY = Math.max(0, (imgHeight - containerRect.height) / 2);

        return { maxX, maxY };
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
    function updateChatPosition() {
        const { maxX, maxY } = calculateChatMaxOffset();

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ
        chatOffsetX = Math.max(-maxX, Math.min(maxX, chatOffsetX));
        chatOffsetY = Math.max(-maxY, Math.min(maxY, chatOffsetY));

        modalPhoto.style.transform = `translate(calc(-50% + ${chatOffsetX}px), calc(-50% + ${chatOffsetY}px)) scale(${chatPhotoScale})`;

        const scaleIndicator = document.getElementById('chatPhotoScale');
        if (scaleIndicator) {
            scaleIndicator.textContent = `${Math.round(chatPhotoScale * 100)}%`;
        }

        // –ò–∑–º–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä
        modalPhoto.style.cursor = chatPhotoScale > 1 ? 'grab' : 'move';
        photoContainer.style.cursor = chatPhotoScale > 1 ? 'grab' : 'default';
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    window.calculateChatMaxOffset = calculateChatMaxOffset;
    window.updateChatPosition = updateChatPosition;

    // Drag to move (–ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ)
    photoContainer.addEventListener('mousedown', (e) => {
        if (chatPhotoScale > 1) {
            isChatDragging = true;
            chatStartX = e.clientX - chatOffsetX;
            chatStartY = e.clientY - chatOffsetY;
            modalPhoto.style.cursor = 'grabbing';
            photoContainer.style.cursor = 'grabbing';
            e.preventDefault();
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏
    modal.addEventListener('mousemove', (e) => {
        if (!isChatDragging) return;
        e.preventDefault();

        chatOffsetX = e.clientX - chatStartX;
        chatOffsetY = e.clientY - chatStartY;

        updateChatPosition();
    });

    modal.addEventListener('mouseup', () => {
        isChatDragging = false;
        modalPhoto.style.cursor = chatPhotoScale > 1 ? 'grab' : 'move';
        photoContainer.style.cursor = chatPhotoScale > 1 ? 'grab' : 'default';
    });

    // Touch events –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    photoContainer.addEventListener('touchstart', (e) => {
        if (chatPhotoScale > 1 && e.touches.length === 1) {
            isChatDragging = true;
            chatStartX = e.touches[0].clientX - chatOffsetX;
            chatStartY = e.touches[0].clientY - chatOffsetY;
            e.preventDefault();
        }
    }, { passive: false });

    modal.addEventListener('touchmove', (e) => {
        if (!isChatDragging || e.touches.length !== 1) return;
        e.preventDefault();

        chatOffsetX = e.touches[0].clientX - chatStartX;
        chatOffsetY = e.touches[0].clientY - chatStartY;

        updateChatPosition();
    }, { passive: false });

    modal.addEventListener('touchend', () => {
        isChatDragging = false;
    });
}

// –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è chat —Ñ–æ—Ç–æ
function zoomInChat() {
    if (chatPhotoScale < CHAT_MAX_ZOOM) {
        const oldScale = chatPhotoScale;
        chatPhotoScale = Math.min(CHAT_MAX_ZOOM, chatPhotoScale + CHAT_ZOOM_STEP);

        const photoContainer = document.getElementById('chatPhotoContainer');
        if (photoContainer) {
            const containerCenterX = photoContainer.clientWidth / 2;
            const containerCenterY = photoContainer.clientHeight / 2;
            const mouseX = containerCenterX;
            const mouseY = containerCenterY;

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
            chatOffsetX = chatOffsetX * (chatPhotoScale / oldScale) + (mouseX - containerCenterX) * (1 - chatPhotoScale / oldScale);
            chatOffsetY = chatOffsetY * (chatPhotoScale / oldScale) + (mouseY - containerCenterY) * (1 - chatPhotoScale / oldScale);

            updateChatPosition();
        }
    }
}

function zoomOutChat() {
    if (chatPhotoScale > CHAT_MIN_ZOOM) {
        const oldScale = chatPhotoScale;
        chatPhotoScale = Math.max(CHAT_MIN_ZOOM, chatPhotoScale - CHAT_ZOOM_STEP);

        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ
        chatOffsetX = chatOffsetX * (chatPhotoScale / oldScale);
        chatOffsetY = chatOffsetY * (chatPhotoScale / oldScale);

        updateChatPosition();
    }
}

function resetZoomChat() {
    chatPhotoScale = 1;
    chatOffsetX = 0;
    chatOffsetY = 0;
    updateChatPosition();
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑—É–º–∞ –∫–æ–ª–µ—Å–æ–º –º—ã—à–∏ –¥–ª—è chat —Ñ–æ—Ç–æ
function handleChatPhotoWheel(event) {
    event.preventDefault();
    event.stopPropagation();

    const photoContainer = document.getElementById('chatPhotoContainer');
    if (!photoContainer) return;

    const containerRect = photoContainer.getBoundingClientRect();
    const mouseX = event.clientX - containerRect.left;
    const mouseY = event.clientY - containerRect.top;

    const oldScale = chatPhotoScale;

    if (event.deltaY < 0) {
        // –ö–æ–ª–µ—Å–æ –≤–≤–µ—Ä—Ö - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º
        if (chatPhotoScale < CHAT_MAX_ZOOM) {
            chatPhotoScale = Math.min(CHAT_MAX_ZOOM, chatPhotoScale + CHAT_ZOOM_STEP);
        }
    } else {
        // –ö–æ–ª–µ—Å–æ –≤–Ω–∏–∑ - —É–º–µ–Ω—å—à–∞–µ–º
        if (chatPhotoScale > CHAT_MIN_ZOOM) {
            chatPhotoScale = Math.max(CHAT_MIN_ZOOM, chatPhotoScale - CHAT_ZOOM_STEP);
        }
    }

    if (oldScale !== chatPhotoScale) {
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
        const scaleRatio = chatPhotoScale / oldScale;
        chatOffsetX = mouseX - (mouseX - chatOffsetX) * scaleRatio;
        chatOffsetY = mouseY - (mouseY - chatOffsetY) * scaleRatio;

        updateChatPosition();
    }
}



    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // –ó–∞–ø—É—Å–∫
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.chat-container.active').forEach(container => {
            const claimId = container.id.replace('chat-', '');
            startPolling(claimId);
        });
        // –î–æ–±–∞–≤–ª—è–µ–º DnD –¥–ª—è —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —á–∞—Ç–æ–≤
        initDragAndDropForChats();
    });


</script>

</body>
</html>